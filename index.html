<!DOCTYPE html>
<html lang="tr" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GORK APP | Görkem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Excel & PDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.3s ease-out' },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .login-bg {
            background-color: #0f172a;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
        }

        /* Takvim hücreleri için iyileştirilmiş grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: 24px repeat(7, 1fr);
            gap: 1px;
            text-align: center;
            font-size: 0.7rem;
            line-height: 1.5;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .week-num {
            color: #94a3b8;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(226, 232, 240, 0.5);
            font-weight: 600;
        }

        .dark .week-num {
            border-right-color: rgba(51, 65, 85, 0.5);
        }

        .today-highlight {
            background-color: #2563eb;
            color: white;
            font-weight: bold;
        }

        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .break-words {
            overflow-wrap: break-word;
            word-wrap: break-word;
            hyphens: auto;
        }

        /* Kanban Styles */
        .kanban-col {
            min-width: 280px;
            transition: background-color 0.2s;
        }

        .kanban-card {
            cursor: grab;
            touch-action: none;
        }

        .kanban-card:active {
            cursor: grabbing;
        }

        .kanban-col.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .status-badge {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
        }



        @media print {
            .no-print {
                display: none !important;
            }

            input {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
            }

            select {
                appearance: none;
                border: none;
                background: transparent;
            }
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-200 font-sans h-screen overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen"
        class="fixed inset-0 z-[999] flex items-center justify-center login-bg p-4 transition-opacity duration-500 overflow-y-auto">
        <div
            class="bg-white/10 backdrop-blur-md border border-white/10 p-8 rounded-3xl shadow-2xl w-full max-w-md animate-fade-in my-auto">
            <div class="text-center mb-8">
                <!-- UPDATED LOGO -->
                <div
                    class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 mx-auto mb-4 overflow-hidden p-1">
                    <img src="https://i.hizliresim.com/hvotmea.png" class="w-full h-full object-contain rounded-xl"
                        alt="Gork App Logo"
                        onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'">
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight">GORK <span class="text-blue-400">APP</span>
                </h1>
                <p class="text-slate-400 text-sm mt-2">Görkem</p>
            </div>

            <form id="authForm" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-slate-300 text-xs font-bold uppercase mb-2 ml-1">E-Posta</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="email" id="email" required
                            class="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                            placeholder="ornek@sirket.com">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-300 text-xs font-bold uppercase mb-2 ml-1">Şifre</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="password" id="password" required
                            class="w-full bg-slate-900/50 border border-slate-700 text-white rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
                            placeholder="••••••••">
                    </div>
                </div>
                <div id="authError"
                    class="hidden bg-red-500/20 border border-red-500/50 text-red-200 text-xs p-3 rounded-lg text-center">
                </div>
                <button type="submit" id="loginBtn"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-600/30 transition transform active:scale-95 flex items-center justify-center gap-2"><span>Giriş
                        Yap</span><i class="fas fa-arrow-right"></i></button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="flex h-screen overflow-hidden hidden">
        <!-- Mobile Header -->
        <div
            class="md:hidden fixed top-0 left-0 right-0 bg-slate-900 z-50 h-14 flex items-center justify-between px-4 border-b border-slate-800 shadow-lg">
            <div class="flex items-center gap-2">
                <!-- UPDATED LOGO MOBILE -->
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center overflow-hidden p-0.5">
                    <img src="https://i.hizliresim.com/hvotmea.png" class="w-full h-full object-contain rounded-md"
                        onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'">
                </div>
                <span class="font-bold text-white text-base">GORK APP</span>
            </div>
            <button onclick="toggleSidebar()"
                class="text-white p-2 focus:outline-none active:bg-slate-800 rounded-lg"><i
                    class="fas fa-bars text-lg"></i></button>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" onclick="toggleSidebar()"
            class="fixed inset-0 bg-black/60 z-[60] hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="w-64 bg-slate-900 dark:bg-slate-900 text-white fixed h-full z-[70] transition-transform duration-300 transform -translate-x-full md:translate-x-0 border-r border-slate-800 shadow-2xl md:shadow-none flex flex-col">
            <div class="p-6 flex flex-col h-full overflow-hidden">
                <div class="hidden md:flex items-center gap-3 mb-8 flex-shrink-0">
                    <!-- UPDATED LOGO SIDEBAR -->
                    <div
                        class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/20 overflow-hidden p-1">
                        <img src="https://i.hizliresim.com/hvotmea.png" class="w-full h-full object-contain rounded-lg"
                            onerror="this.src='https://cdn-icons-png.flaticon.com/512/3069/3069172.png'">
                    </div>
                    <h1 class="font-bold text-xl tracking-tight">GORK <span class="text-blue-400">APP</span></h1>
                </div>

                <nav class="space-y-0.5 flex-1 overflow-y-auto custom-scrollbar px-2">
                    <button onclick="changeTab('home')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white"><i
                            class="fas fa-home w-4 text-center"></i> Ana Sayfa</button>

                    <div
                        class="mt-1 mb-1 px-3 text-[9px] font-bold text-slate-500 uppercase tracking-widest border-t border-slate-800 pt-2">
                        İş</div>

                    <button onclick="changeTab('dashboard')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white"><i
                            class="fas fa-chart-line w-4 text-center"></i> Dashboard</button>
                    <button onclick="changeTab('orders')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white"><i
                            class="fas fa-list-check w-4 text-center"></i> Siparişler</button>
                    <button onclick="changeTab('shipping')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-white"><i
                            class="fas fa-truck-ramp-box w-4 text-center"></i> Sevkiyat</button>
                    <button onclick="changeTab('biota')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-teal-400"><i
                            class="fas fa-flask w-4 text-center"></i> Biota Sipariş</button>

                    <!-- CAD CONVERTER -->
                    <a href="https://gemini.google.com/gem/17YM1pqwRfgxt1ddA1yl8rZ2u55xyCpoY?usp=sharing"
                        target="_blank"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-purple-400"><i
                            class="fas fa-drafting-compass w-4 text-center"></i> CAD Çevirici</a>

                    <button onclick="changeTab('colorApproval')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-rose-500"><i
                            class="fas fa-swatchbook w-4 text-center"></i> Renk Onay</button>

                    <button onclick="changeTab('marketIntel')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-cyan-500"><i
                            class="fas fa-search-dollar w-4 text-center"></i> Pazar İstihbaratı</button>

                    <button onclick="changeTab('priceList')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-amber-500"><i
                            class="fas fa-tags w-4 text-center"></i> Fiyat Listesi</button>

                    <button onclick="changeTab('archive')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-green-400"><i
                            class="fas fa-check-circle w-4 text-center"></i> Geçmiş</button>
                    <button onclick="changeTab('proposals')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-indigo-400"><i
                            class="fas fa-columns w-4 text-center"></i> Teklif Takip</button>


                    <div
                        class="mt-1 mb-1 px-3 text-[9px] font-bold text-slate-500 uppercase tracking-widest border-t border-slate-800 pt-2">
                        Kişisel</div>

                    <button onclick="changeTab('personalNotepad')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-yellow-400"><i
                            class="fas fa-sticky-note w-4 text-center"></i> Not Defteri</button>

                    <button onclick="changeTab('financial')"
                        class="w-full flex items-center gap-3 px-3 py-1.5 text-sm rounded-lg hover:bg-slate-800 transition text-slate-400 hover:text-emerald-500"><i
                            class="fas fa-coins w-4 text-center"></i> Finansal Kayıt</button>
                </nav>

                <div class="mt-auto pt-4 border-t border-slate-800 space-y-2 flex-shrink-0">
                    <button onclick="handleLogout()"
                        class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg bg-red-900/20 active:bg-red-900/40 transition text-red-400 hover:text-white text-xs border border-red-900/30"><i
                            class="fas fa-sign-out-alt"></i> Çıkış</button>
                    <button onclick="toggleDarkMode()"
                        class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-lg bg-slate-800/50 hover:bg-slate-800 transition text-slate-300 hover:text-white border border-slate-700"><i
                            class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main
            class="md:ml-64 flex-1 p-4 md:p-8 pt-16 md:pt-8 overflow-y-auto h-full w-full bg-slate-50 dark:bg-slate-950">

            <!-- HOME PAGE CONTENT -->
            <div id="homeContent" class="hidden animate-fade-in space-y-6 pb-20">
                <!-- Header Card -->
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center glass-panel p-5 rounded-2xl shadow-sm gap-4">
                    <div class="flex-1 overflow-hidden">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800 dark:text-white mb-0.5 truncate">Hoş
                            geldin</h2>
                        <p class="text-sm md:text-lg font-medium text-blue-600 dark:text-blue-400 truncate">Görkem</p>
                    </div>
                    <div class="text-right flex justify-between md:block items-end gap-2">
                        <div id="digitalClock"
                            class="text-xl md:text-2xl font-bold text-slate-700 dark:text-slate-300 font-mono">00:00
                        </div>
                        <div id="currentDate"
                            class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">TARİH</div>
                    </div>
                </div>

                <!-- Row 1: Motivation, Weather, Rates -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Motivation -->
                    <div
                        class="glass-panel p-3 rounded-2xl shadow-sm flex flex-col h-48 relative group overflow-hidden">
                        <div class="relative w-full h-full rounded-xl overflow-hidden shadow-inner">
                            <img id="motivationImg" src=""
                                class="w-full h-full object-cover transition duration-700 group-hover:scale-110"
                                alt="Motivation">
                            <div
                                class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex items-end p-4">
                                <blockquote class="text-white relative z-10 w-full pr-6">
                                    <p id="motivationText"
                                        class="text-xs font-medium italic mb-1 line-clamp-2 break-words">...</p>
                                    <footer id="motivationAuthor"
                                        class="text-white/70 text-[9px] font-bold uppercase tracking-widest truncate">
                                    </footer>
                                </blockquote>
                            </div>
                            <button onclick="editMotivation()"
                                class="absolute top-2 right-2 z-20 bg-white/20 hover:bg-white/40 backdrop-blur text-white p-2 rounded-lg shadow-lg"><i
                                    class="fas fa-pen text-xs"></i></button>
                        </div>
                    </div>

                    <!-- Weekly Weather -->
                    <div class="glass-panel p-4 rounded-2xl shadow-sm flex flex-col h-48 overflow-hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Haftalık Hava
                                Durumu</h3>
                            <span class="text-[10px] font-bold text-blue-500">İstanbul</span>
                        </div>
                        <div id="weeklyWeather" class="flex-1 flex gap-2 overflow-x-auto custom-scrollbar pb-1">
                            <div class="animate-pulse flex-1 bg-slate-100 dark:bg-slate-800 rounded-xl"></div>
                        </div>
                    </div>

                    <!-- Exchange Rates -->
                    <div
                        class="glass-panel p-5 rounded-2xl shadow-sm bg-gradient-to-br from-white/50 to-blue-50/50 dark:from-slate-900/50 dark:to-blue-900/20 flex flex-col h-48 justify-between overflow-hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Canlı Döviz
                                Kurları</h3>
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-ping"></div>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-inner border border-slate-100 dark:border-slate-700 flex items-center justify-between min-w-0">
                                <span class="text-xs font-black text-slate-500">USD</span>
                                <span id="rateUSD"
                                    class="text-sm font-black text-slate-800 dark:text-white">--.--</span>
                            </div>
                            <div
                                class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-inner border border-slate-100 dark:border-slate-700 flex items-center justify-between min-w-0">
                                <span class="text-xs font-black text-slate-500">EUR</span>
                                <span id="rateEUR"
                                    class="text-sm font-black text-slate-800 dark:text-white">--.--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Summary and Shortcuts -->
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                    <!-- Summary Module -->
                    <div
                        class="lg:col-span-8 glass-panel p-5 rounded-3xl shadow-sm border-l-4 border-blue-600 flex flex-col justify-center overflow-hidden">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Genel Durum
                            Özeti</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                            <div class="flex flex-col min-w-0">
                                <span class="text-[10px] font-bold text-slate-500 uppercase truncate">Aktif
                                    Sipariş</span>
                                <span id="summaryActive" class="text-2xl font-black text-blue-600">0</span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[10px] font-bold text-slate-500 uppercase truncate">Geciken</span>
                                <span id="summaryLate" class="text-2xl font-black text-red-500">0</span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[10px] font-bold text-slate-500 uppercase truncate">TRY Hacmi</span>
                                <span id="summaryTRY"
                                    class="text-sm font-black text-slate-800 dark:text-white truncate">₺0</span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[10px] font-bold text-slate-500 uppercase truncate">USD Hacmi</span>
                                <span id="summaryUSD" class="text-sm font-black text-emerald-600 truncate">$0</span>
                            </div>
                            <div class="flex flex-col min-w-0">
                                <span class="text-[10px] font-bold text-slate-500 uppercase truncate">EUR Hacmi</span>
                                <span id="summaryEUR" class="text-sm font-black text-orange-600 truncate">€0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links (8 Slots) -->
                    <div class="lg:col-span-4 glass-panel p-5 rounded-3xl shadow-sm">
                        <div class="flex justify-between items-center mb-4 min-w-0">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Kısayollar</h3>
                            <button onclick="openLinkModal()"
                                class="text-[10px] bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 font-bold flex-shrink-0">Ekle</button>
                        </div>
                        <div id="quickLinksGrid" class="grid grid-cols-4 gap-4">
                            <!-- 8 slot capacity -->
                        </div>
                    </div>
                </div>

                <!-- Row 3: Calendar and Notes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Calendar -->
                    <div class="glass-panel p-5 rounded-3xl shadow-sm overflow-hidden h-80 flex flex-col">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Takvim</h3>
                        <div class="flex gap-6 overflow-x-auto custom-scrollbar pb-4 flex-1 items-start"
                            id="calendarContainer"></div>
                    </div>

                    <!-- Todo / Notes -->
                    <div class="glass-panel p-5 rounded-3xl shadow-sm flex flex-col h-80 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Görevler ve
                                Notlar</h3>
                            <span
                                class="text-[10px] bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-full text-slate-500 font-bold"
                                id="todoCount">0</span>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="newTodoInput" placeholder="Yeni not..."
                                class="flex-1 min-w-0 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-xs outline-none dark:text-white"
                                onkeypress="handleTodoKeypress(event)">
                            <button onclick="addTodo()"
                                class="bg-blue-600 text-white rounded-xl px-4 py-2 text-xs active:scale-95 transition flex-shrink-0 shadow-lg shadow-blue-500/20"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div id="todoList" class="overflow-y-auto custom-scrollbar flex-1 space-y-2 pr-1"></div>
                    </div>
                </div>
            </div>

            <!-- SHIPPING CONTENT -->
            <div id="shippingContent" class="hidden animate-fade-in pb-20">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white">Lojistik - Sevkiyat
                            Planı</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs">Sevkiyat Yönetimi</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="printShipments()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg"><i
                                class="fas fa-print"></i> Yazdır / PDF</button>
                        <button onclick="openShipmentModal()"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg"><i
                                class="fas fa-plus"></i> Yeni Sevkiyat</button>
                    </div>
                </header>

                <!-- Shipment Table -->
                <div class="glass-panel rounded-2xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="shipmentTable">
                            <thead>
                                <tr
                                    class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-[10px] font-black uppercase tracking-wider">
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700 w-10 text-center"><i
                                            class="fas fa-exclamation-circle text-red-400"></i></th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700">Tarih Aralığı</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700">Firma / Müşteri</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700">Sevk Adresi</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700">Ürün</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-center">Miktar
                                        Detay</th>
                                    <th
                                        class="p-3 border-b border-slate-200 dark:border-slate-700 text-center bg-blue-50 dark:bg-blue-900/20">
                                        Koli Sayısı</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700">Açıklama</th>
                                    <th class="p-3 border-b border-slate-200 dark:border-slate-700 text-center w-24">
                                        İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="shipmentTableBody" class="text-xs text-slate-700 dark:text-slate-300">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BIOTA SIPARIS TAKIP CONTENT -->
            <div id="biotaContent" class="hidden pb-24">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white">Biota Sipariş Takip
                            <span class="text-teal-500 text-sm">LITE</span>
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs">Derma-Cos ve Biota Siparişleri</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportBiotaExcel()"
                            class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white text-xs font-bold transition flex items-center gap-1"><i
                                class="fas fa-file-excel"></i> Excel</button>
                        <button onclick="copyBiotaMail()"
                            class="px-3 py-2 rounded-lg bg-orange-600 hover:bg-orange-700 text-white text-xs font-bold transition flex items-center gap-1"><i
                                class="fas fa-copy"></i> Mail Kopyala</button>
                        <button onclick="backupBiotaData()"
                            class="px-3 py-2 rounded-lg bg-slate-600 hover:bg-slate-700 text-white text-xs font-bold transition flex items-center gap-1"><i
                                class="fas fa-download"></i> Yedekle</button>
                        <button onclick="openBiotaCatalog()"
                            class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold transition flex items-center gap-1 border border-slate-600"><i
                                class="fas fa-images"></i> Katalog</button>
                    </div>
                </div>

                <!-- Biota Order Form -->
                <div
                    class="bg-white/70 dark:bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-200 dark:border-slate-700 p-5 mb-6">
                    <h3 class="text-sm font-black text-teal-600 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Yeni Sipariş Ekle
                    </h3>
                    <form id="biotaAddOrderForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <input type="text" id="biotaSiparisNo" placeholder="Sipariş No" required
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                        <div class="relative">
                            <input type="text" id="biotaMalzemeNo" placeholder="Malzeme No (Otomatik Tanıma)" required
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition"
                                oninput="biotaAutoComplete(this.value)">
                            <div id="biotaMatchIndicator" class="hidden absolute right-3 top-3 text-green-500"><i
                                    class="fas fa-check-circle text-lg"></i></div>
                        </div>
                        <input type="text" id="biotaMalzemeAciklamasi" placeholder="Malzeme Açıklaması (Otomatik)"
                            required
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition lg:col-span-2">
                        <input type="text" id="biotaSiparisTarihi" placeholder="Sipariş Tarihi (GG.AA.YYYY)" required
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                        <input type="number" id="biotaSiparisAdeti" placeholder="Sip. Adeti" required
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                        <input type="number" id="biotaTeslimEdilen" placeholder="Teslim Edilen" required
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                        <button type="submit"
                            class="px-6 py-3 rounded-lg text-xs font-black text-white bg-teal-600 hover:bg-teal-700 shadow-lg transition uppercase tracking-widest flex items-center justify-center gap-2"><i
                                class="fas fa-save"></i> Siparişi Kaydet</button>
                    </form>
                    <div class="mt-2 text-right">
                        <button id="biotaAddToCatalogShortcut"
                            class="hidden text-xs text-teal-500 hover:underline cursor-pointer"
                            onclick="biotaAddToCatalogFromForm()">Bu kodu kataloğa ekle</button>
                    </div>
                </div>

                <!-- Biota Filters -->
                <div
                    class="bg-white/70 dark:bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-200 dark:border-slate-700 p-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-3">
                    <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                        <div class="relative w-full sm:w-64">
                            <input type="text" id="biotaSearchInput" placeholder="Ara (Kod, Açıklama, Sipariş No)..."
                                oninput="renderBiotaOrders()"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg py-2 pl-10 pr-4 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                            <i
                                class="fas fa-search text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-sm"></i>
                        </div>
                        <select id="biotaStatusFilter" onchange="renderBiotaOrders()"
                            class="bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg py-2 px-3 text-sm outline-none focus:ring-2 focus:ring-teal-500 transition">
                            <option value="all">Tüm Siparişler</option>
                            <option value="completed">Tamamlananlar</option>
                            <option value="partial">Kısmi Teslimat</option>
                            <option value="pending">İşlem Görmeyenler</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="biotaBulkCompleteBtn"
                            class="hidden px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold transition animate-pulse"
                            onclick="biotaBulkComplete()">Seçilenleri Tamamla</button>
                        <button onclick="triggerBiotaImport()"
                            class="px-3 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold transition flex items-center gap-1"><i
                                class="fas fa-file-import"></i> Yükle</button>
                        <input type="file" id="biotaImportFile" class="hidden" accept=".xlsx,.xls"
                            onchange="biotaImportExcel(event)">
                    </div>
                </div>

                <!-- Biota Orders Table -->
                <div
                    class="bg-white/70 dark:bg-slate-800/50 backdrop-blur rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div class="overflow-x-auto" style="max-height: 60vh; overflow-y: auto;">
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-[10px] uppercase text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-center w-10"><input type="checkbox" id="biotaSelectAll"
                                            onchange="biotaToggleSelectAll()"
                                            class="w-4 h-4 accent-teal-600 rounded cursor-pointer"></th>
                                    <th class="px-4 py-3">Durum</th>
                                    <th class="px-4 py-3">Sipariş No</th>
                                    <th class="px-4 py-3">Malzeme</th>
                                    <th class="px-4 py-3 text-right">Sip. Adeti</th>
                                    <th class="px-4 py-3 text-right">Teslim</th>
                                    <th class="px-4 py-3 w-1/6">İlerleme</th>
                                    <th class="px-4 py-3 text-center">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="biotaTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RENK ONAY FORMU CONTENT -->
            <div id="colorApprovalContent" class="hidden pb-24">
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 print:hidden">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white">Renk Onay Formu</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs">Müşteri Renk Onay Çıktısı Oluşturma</p>
                    </div>
                    <button onclick="printColorApproval()"
                        class="px-4 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-white font-bold transition flex items-center gap-2 shadow-lg"><i
                            class="fas fa-print"></i> Yazdır / PDF</button>
                </div>

                <!-- A4 PAGE PREVIEW WRAPPER -->
                <div class="flex justify-center">
                    <div id="colorApprovalPage"
                        class="bg-white text-slate-900 w-[210mm] min-h-[297mm] p-[15mm] shadow-2xl relative box-border mx-auto print:shadow-none print:w-full print:m-0 print:p-0">
                        <!-- Header -->
                        <header class="flex justify-between items-center border-b-[3px] border-[#E31E24] pb-5 mb-8">
                            <div class="flex-1">
                                <img src="https://www.unison.com.tr/wp-content/uploads/2024/11/cropped-logo_unison-300x70.png"
                                    alt="Unison Logo" class="h-20 w-auto block">
                            </div>
                            <div class="text-right flex-1">
                                <h1 class="m-0 text-[#58595B] text-2xl uppercase tracking-wider font-bold">Renk Onay
                                    Formu</h1>
                                <span class="text-xs text-[#E31E24] font-bold">COLOR APPROVAL FORM</span>
                            </div>
                        </header>

                        <!-- Section 1: Prep Info -->
                        <div class="mb-6">
                            <div class="grid grid-cols-2 gap-5">
                                <div>
                                    <label
                                        class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Düzenleyen
                                        (Prepared By)</label>
                                    <input type="text" id="caPreparedBy" placeholder="Ad Soyad..."
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div>
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Tarih
                                        (Date)</label>
                                    <input type="date" id="caDate"
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div>
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Ürün
                                        (Product)</label>
                                    <input type="text" id="caProduct" placeholder="Ürün adı veya kodu..."
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div>
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Renk
                                        Tanımı (Color Definition)</label>
                                    <input type="text" id="caColorDef" placeholder="Pantone kodu veya renk adı..."
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Notlar
                                        (Notes)</label>
                                    <textarea id="caNotes" placeholder="Ürün veya renkle ilgili özel notlar..."
                                        class="w-full border border-[#eee] bg-[#fcfcfc] p-2 text-sm resize-none h-16 outline-none focus:border-[#E31E24] print:border-none print:bg-transparent print:p-0 print:h-auto print:min-h-[40px]"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Visual Area -->
                        <label class="block text-sm mb-1 font-bold text-[#333]">ÜRÜN / RENK GÖRSELİ (PRODUCT
                            IMAGE)</label>
                        <div class="border-2 border-dashed border-[#ccc] h-[350px] my-5 flex justify-center items-center relative bg-[#fafafa] cursor-pointer overflow-hidden rounded hover:border-[#E31E24] hover:bg-[#fff0f0] transition-colors print:border print:border-black print:border-solid print:h-[300px]"
                            onclick="document.getElementById('caImageUpload').click()">
                            <input type="file" id="caImageUpload" accept="image/*" class="hidden"
                                onchange="previewColorImage(event)">
                            <div class="text-center text-[#999] pointer-events-none" id="caPlaceholderText">
                                <p class="font-bold">Görsel Eklemek İçin Tıklayın</p>
                                <p class="text-xs mt-1">(Çıktı almadan önce renk örneği fotoğrafını yükleyiniz)</p>
                            </div>
                            <img id="caPreviewImage" src="" alt="Renk Örneği"
                                class="max-w-full max-h-full object-contain hidden">
                        </div>

                        <!-- Section 3: Customer Info -->
                        <div
                            class="bg-[#f4f4f4] p-4 border-l-4 border-[#58595B] mb-8 print:bg-white print:border print:border-[#ccc] print:border-l-4 print:p-2">
                            <div class="grid grid-cols-2 gap-5">
                                <div class="col-span-2">
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">Firma
                                        / Cari (Customer)</label>
                                    <input type="text" id="caCustomer" placeholder="Müşteri firma unvanı..."
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div>
                                    <label class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">İlgili
                                        Kişi (Contact Person)</label>
                                    <input type="text" id="caContact" placeholder="İlgili kişi adı..."
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                                <div>
                                    <label
                                        class="block text-[11px] text-[#58595B] font-bold uppercase mb-1 mt-2">E-Mail</label>
                                    <input type="email" id="caEmail" placeholder="ornek@musteri.com"
                                        class="w-full border-b border-[#ccc] py-1 text-sm outline-none bg-transparent focus:border-[#E31E24] transition-colors print:border-none">
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <footer class="mt-auto border-t border-[#ccc] pt-5 flex justify-between items-end print:mt-10">
                            <div class="text-xs text-[#666] max-w-[50%]">
                                <span class="block font-bold text-[#58595B] text-sm mb-1">Unison Dış Ticaret ve Ambalaj
                                    Sanayi Anonim Şirketi</span>
                                <span>www.unison.com.tr</span>
                            </div>
                            <div class="text-center w-[200px]">
                                <label class="block text-[11px] text-[#58595B] font-bold uppercase">MÜŞTERİ ONAYI
                                    (CUSTOMER APPROVAL)</label>
                                <div class="h-20 border-b border-[#333] mt-2 mb-1"></div>
                                <div class="flex justify-between text-[11px] mt-1 text-[#333]">
                                    <span>Kaşe / İmza</span>
                                    <span>Tarih: ..../..../20....</span>
                                </div>
                            </div>
                        </footer>
                    </div>
                    <!-- CSS for Print -->
                    <style>
                        @media print {
                            @page {
                                size: A4 portrait;
                                margin: 0;
                            }

                            body * {
                                visibility: hidden;
                            }

                            #colorApprovalPage,
                            #colorApprovalPage * {
                                visibility: visible;
                            }

                            #colorApprovalPage {
                                position: absolute;
                                left: 0;
                                top: 0;
                                width: 100%;
                                height: 100%;
                                margin: 0;
                                padding: 10mm 15mm;
                                overflow: hidden;
                                box-shadow: none;
                            }

                            ::placeholder {
                                color: transparent;
                            }
                        }
                    </style>
                </div>
            </div>

            <!-- FIYAT LISTESI CONTENT -->
            <div id="priceListContent"
                class="hidden h-screen bg-[#f4f7f6] relative w-full overflow-hidden flex flex-row pb-24 md:pb-0">
                <!-- Price Sidebar -->
                <div class="w-80 bg-white border-r border-slate-200 flex flex-col h-full flex-shrink-0">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-bold text-slate-700">Müşteri Yönetimi</h2>
                            <button onclick="changeTab('home')" class="text-slate-400 hover:text-slate-600 md:hidden"><i
                                    class="fas fa-arrow-left"></i></button>
                            <button onclick="changeTab('home')"
                                class="text-slate-400 hover:text-slate-600 hidden md:block text-xs">Menüye Dön</button>
                        </div>
                        <input type="text" id="plSearchCustomer" placeholder="Cari Hesap Ara..."
                            onkeyup="renderPriceCustomers()"
                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500 mb-2">
                        <div class="flex gap-2">
                            <input type="text" id="plNewCustomerName" placeholder="Yeni Cari Adı"
                                class="flex-1 border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                            <button onclick="addPriceCustomer()"
                                class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg text-sm font-bold transition">Ekle</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto">
                        <ul id="plCustomerList" class="divide-y divide-slate-100"></ul>
                    </div>
                    <div class="p-4 border-t border-slate-100 bg-slate-50 flex flex-col gap-2">
                        <button onclick="exportPriceList()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i
                                class="fas fa-save"></i> Dışa Aktar (Yedek)</button>
                        <button onclick="document.getElementById('plImportFile').click()"
                            class="w-full bg-slate-600 hover:bg-slate-700 text-white py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i
                                class="fas fa-file-import"></i> İçe Aktar</button>
                        <input type="file" id="plImportFile" accept=".json" class="hidden"
                            onchange="importPriceList(this)">
                    </div>
                </div>

                <!-- Price Main Area -->
                <div class="flex-grow flex flex-col bg-[#f4f7f6] h-full overflow-hidden relative">
                    <!-- Empty State -->
                    <div id="plEmptyState"
                        class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 z-10">
                        <i class="fas fa-arrow-left text-4xl mb-4 md:block hidden"></i>
                        <p class="text-lg">Lütfen sol menüden bir cari hesap seçin veya yeni ekleyin.</p>
                    </div>

                    <!-- Main Content -->
                    <div id="plMainContent" class="hidden flex-col h-full z-20 overflow-hidden">
                        <div class="p-6 border-b border-slate-200 bg-white flex justify-between items-center">
                            <h1 id="plCurrentCustomerTitle" class="text-2xl font-normal text-slate-800">Cari Hesap</h1>
                        </div>

                        <div class="flex-grow overflow-y-auto p-6">
                            <!-- Product Form -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 mb-6">
                                <form id="plProductForm" onsubmit="savePriceProduct(event)"
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="hidden" id="plProductId">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Müşteri Stok Kodu
                                            *</label>
                                        <input type="text" id="plCustomerCode" required placeholder="Örn: MST-001"
                                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Unison Stok Kodu
                                            *</label>
                                        <input type="text" id="plUnisonCode" required placeholder="Örn: UNS-999"
                                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Fiyat ve Döviz
                                            *</label>
                                        <div class="flex gap-2">
                                            <input type="number" step="0.001" id="plPrice" required placeholder="0.00"
                                                class="flex-1 border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                            <select id="plCurrency"
                                                class="w-24 border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                                <option value="TL">TL</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">MOQ (Min.
                                            Sipariş)</label>
                                        <input type="text" id="plMoq" placeholder="İsteğe Bağlı"
                                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Termin Detayı</label>
                                        <input type="text" id="plLeadTime" placeholder="İsteğe Bağlı"
                                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Geçerlilik
                                            Alanı/Süresi</label>
                                        <input type="text" id="plValidity" placeholder="İsteğe Bağlı"
                                            class="w-full border border-slate-200 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                                    </div>
                                    <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                                        <button type="button" id="plCancelBtn" onclick="resetPriceForm()"
                                            class="hidden px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-100 text-sm font-bold transiton">İptal</button>
                                        <button type="submit" id="plSubmitBtn"
                                            class="px-6 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white text-sm font-bold transition">Kayıt
                                            Ekle</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Product Table -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-100">
                                        <tr>
                                            <th class="px-4 py-3">Müşteri Kodu</th>
                                            <th class="px-4 py-3">Unison Kodu</th>
                                            <th class="px-4 py-3">Fiyat</th>
                                            <th class="px-4 py-3 hidden md:table-cell">MOQ</th>
                                            <th class="px-4 py-3 hidden md:table-cell">Termin</th>
                                            <th class="px-4 py-3 hidden md:table-cell">Geçerlilik</th>
                                            <th class="px-4 py-3 text-right">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="plProductTableBody" class="divide-y divide-slate-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKET INTEL CONTENT -->
            <div id="marketIntelContent" class="hidden pb-24 h-full">
                <div class="flex flex-col xl:flex-row gap-6 h-full">
                    <!-- Left: Form -->
                    <div
                        class="w-full xl:w-96 flex-shrink-0 bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-6 h-fit">
                        <h2
                            class="text-lg font-bold text-slate-800 dark:text-white mb-4 border-b dark:border-slate-700 pb-2">
                            İstihbarat Ekle</h2>
                        <form id="miForm" onsubmit="saveMarketIntel(event)">
                            <input type="hidden" id="miEditId">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Tarih</label>
                                    <input type="date" id="miDate"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-cyan-500"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Kategori</label>
                                    <select id="miCategory"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-cyan-500"
                                        required>
                                        <option value="Yeni ürün">Yeni ürün</option>
                                        <option value="Müşteri talebi">Müşteri talebi</option>
                                        <option value="Hedef müşteri">Hedef müşteri</option>
                                        <option value="İstihbarat">İstihbarat</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Başlık / Konu</label>
                                    <input type="text" id="miSubject"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-cyan-500"
                                        placeholder="Örn: Potansiyel müşteri..." required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">İçerik Detayı</label>
                                    <textarea id="miContent"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-cyan-500 h-24 resize-y"
                                        placeholder="Notlar..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Dosya Eki</label>
                                    <input type="file" id="miFileInput"
                                        class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="miImportant" class="w-4 h-4 accent-red-500">
                                    <label for="miImportant" class="text-sm font-bold text-red-500">KRİTİK /
                                        Önemli</label>
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button type="submit"
                                        class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg font-bold transition">Kaydet</button>
                                    <button type="button" id="miCancelBtn" onclick="resetMarketIntelForm()"
                                        class="hidden px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-lg font-bold transition">Vazgeç</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Right: List -->
                    <div class="flex-grow flex flex-col h-full overflow-hidden">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="miSearch" onkeyup="renderMarketIntel()" placeholder="Ara..."
                                class="flex-grow bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-cyan-500 shadow-sm">
                        </div>
                        <div id="miListContainer" class="flex-grow overflow-y-auto space-y-4 pr-2 pb-24">
                            <!-- Cards will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- FINANCIAL CONTENT -->
            <div id="financialContent" class="hidden pb-24 h-full relative overflow-y-auto custom-scrollbar">
                <div class="flex flex-col space-y-6">
                    <!-- Header -->
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center glass-panel p-6 rounded-2xl gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Finansal Takip</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Gelir, Gider ve Yatırım Yönetimi</p>
                        </div>
                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <select id="finMonthSelector" onchange="loadFinansData()"
                                class="flex-1 md:flex-none bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500 transition shadow-sm"></select>
                            <button onclick="printFinansReport()"
                                class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-md"><i
                                    class="fas fa-print"></i> Yazdır</button>
                            <button onclick="saveFinansData()"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/30 transition hover:shadow-emerald-500/50">Kaydet</button>
                        </div>
                    </div>

                    <!-- Print Title (Hidden usually, visible on print) -->
                    <div id="finPrintTitle" class="hidden print:block text-2xl font-bold text-center mb-8"></div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 pb-20">
                        <!-- Left Col: Income & Debts -->
                        <div class="space-y-6">
                            <!-- Income -->
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-emerald-100 dark:border-emerald-900/20">
                                <div
                                    class="flex justify-between items-center mb-4 border-b border-emerald-100 dark:border-emerald-900/30 pb-2">
                                    <h3
                                        class="text-emerald-600 dark:text-emerald-400 font-bold uppercase text-xs tracking-wider">
                                        Gelirler</h3>
                                    <span id="total_income" class="font-black text-emerald-600 text-lg">0 TL</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Maaş</label><input
                                            type="number" id="inc_maas" oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Yemek</label><input
                                            type="number" id="inc_yemek" oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Hediye /
                                            Ek</label><input type="number" id="inc_hediye"
                                            oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Yan Hak
                                            (YT)</label><input type="number" id="inc_yt"
                                            oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Prim /
                                            RD</label><input type="number" id="inc_rd" oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Diğer</label><input
                                            type="number" id="inc_diger" oninput="calculateFinansTotals()"
                                            class="fin-calc-inc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition"
                                            placeholder="0"></div>
                                </div>
                            </div>

                            <!-- Debts (CC) -->
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-red-100 dark:border-red-900/20">
                                <div
                                    class="flex justify-between items-center mb-4 border-b border-red-100 dark:border-red-900/30 pb-2">
                                    <h3
                                        class="text-red-500 dark:text-red-400 font-bold uppercase text-xs tracking-wider">
                                        Kredi Kartları</h3>
                                    <span id="total_cc" class="font-black text-red-500 text-lg">0 TL</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Akbank</label><input
                                            type="number" id="cc_akbank" oninput="calculateFinansTotals()"
                                            class="fin-calc-cc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-red-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Yapı
                                            Kredi</label><input type="number" id="cc_ykb"
                                            oninput="calculateFinansTotals()"
                                            class="fin-calc-cc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-red-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Garanti</label><input
                                            type="number" id="cc_garanti" oninput="calculateFinansTotals()"
                                            class="fin-calc-cc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-red-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Enpara</label><input
                                            type="number" id="cc_enpara" oninput="calculateFinansTotals()"
                                            class="fin-calc-cc w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-red-500 transition"
                                            placeholder="0"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Middle Col: Loans & Summary -->
                        <div class="space-y-6">
                            <!-- Loans -->
                            <div
                                class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-orange-100 dark:border-orange-900/20">
                                <div
                                    class="flex justify-between items-center mb-4 border-b border-orange-100 dark:border-orange-900/30 pb-2">
                                    <h3
                                        class="text-orange-500 dark:text-orange-400 font-bold uppercase text-xs tracking-wider">
                                        Krediler & Borçlar</h3>
                                    <span id="total_loan" class="font-black text-orange-500 text-lg">0 TL</span>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Akbank
                                            Kredi</label><input type="number" id="loan_akbank"
                                            oninput="calculateFinansTotals()"
                                            class="fin-calc-loan w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-orange-500 transition"
                                            placeholder="0"></div>
                                    <div class="flex justify-between items-center"><label
                                            class="text-xs font-bold text-slate-500 dark:text-slate-400 w-1/3">Nurçehre</label><input
                                            type="number" id="loan_nurcehre" oninput="calculateFinansTotals()"
                                            class="fin-calc-loan w-2/3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-right font-mono text-sm outline-none focus:ring-2 focus:ring-orange-500 transition"
                                            placeholder="0"></div>
                                </div>
                            </div>

                            <!-- Summary Card -->
                            <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-48 h-48 bg-emerald-500/20 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none">
                                </div>
                                <div
                                    class="absolute bottom-0 left-0 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl -ml-10 -mb-10 pointer-events-none">
                                </div>

                                <h3 class="font-bold mb-6 text-center text-lg tracking-tight z-10 relative">Genel Özet
                                </h3>
                                <div class="space-y-4 relative z-10">
                                    <div
                                        class="flex justify-between items-center p-2 rounded hover:bg-white/5 transition">
                                        <span
                                            class="text-slate-400 text-xs font-bold uppercase tracking-wider">Gelir</span>
                                        <span id="summary_inc" class="font-bold text-emerald-400 text-lg">0 TL</span>
                                    </div>
                                    <div
                                        class="flex justify-between items-center p-2 rounded hover:bg-white/5 transition">
                                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Gider
                                            (KK+Kredi)</span>
                                        <span id="summary_debt" class="font-bold text-red-400 text-lg">0 TL</span>
                                    </div>
                                    <div
                                        class="flex justify-between items-center p-2 rounded hover:bg-white/5 transition">
                                        <span
                                            class="text-slate-400 text-xs font-bold uppercase tracking-wider">Yatırım</span>
                                        <span id="summary_inv" class="font-bold text-blue-400 text-lg">0 TL</span>
                                    </div>
                                    <div class="h-px bg-slate-700 my-2"></div>
                                    <div
                                        class="flex justify-between items-center p-3 bg-white/10 rounded-xl border border-white/10">
                                        <span class="font-bold text-slate-200 uppercase text-xs tracking-wider">Net
                                            Kalan</span>
                                        <span id="summary_net" class="font-black text-white text-xl">0 TL</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Investments -->
                        <div
                            class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-blue-100 dark:border-blue-900/20 flex flex-col h-full">
                            <div
                                class="flex justify-between items-center mb-4 border-b border-blue-100 dark:border-blue-900/30 pb-2">
                                <h3 class="text-blue-600 dark:text-blue-400 font-bold uppercase text-xs tracking-wider">
                                    Yatırımlar</h3>
                                <span id="total_invest" class="font-black text-blue-600 text-lg">0 TL</span>
                            </div>

                            <div
                                class="grid grid-cols-12 gap-2 mb-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">
                                <div class="col-span-5 text-left">Tür</div>
                                <div class="col-span-3">Miktar</div>
                                <div class="col-span-3 text-right">Değer (TL)</div>
                                <div class="col-span-1"></div>
                            </div>

                            <div id="finInvestContainer"
                                class="space-y-2 flex-grow overflow-y-auto max-h-[400px] mb-4 custom-scrollbar">
                                <!-- JS inserts here -->
                            </div>

                            <button onclick="addInvestmentRow()"
                                class="w-full py-2 rounded-lg border border-dashed border-blue-300 dark:border-blue-700 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 text-xs font-bold transition flex justify-center items-center gap-2"><i
                                    class="fas fa-plus-circle"></i> Yeni Yatırım Ekle</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PERSONAL NOTEPAD (KANBAN) -->
            <div id="personalNotepadContent" class="hidden pb-24 h-full relative">
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Kişisel Not Defteri</h2>
                        <button onclick="addPersonalNote()"
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition"><i
                                class="fas fa-plus"></i> Yeni Not</button>
                    </div>

                    <div class="flex-grow flex gap-4 overflow-x-auto pb-4">
                        <!-- Todo Column -->
                        <div
                            class="flex-1 min-w-[300px] flex flex-col bg-slate-100 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-slate-600 dark:text-slate-300">YAPILACAKLAR</h3>
                                <span id="count-todo"
                                    class="bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded text-xs font-bold text-slate-600 dark:text-slate-400">0</span>
                            </div>
                            <div id="pn-col-todo" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar"
                                ondrop="dropPersonalNote(event, 'todo')" ondragover="allowDropPN(event)">
                                <!-- Note Cards -->
                            </div>
                        </div>

                        <!-- Done Column -->
                        <div
                            class="flex-1 min-w-[300px] flex flex-col bg-green-50 dark:bg-green-900/10 rounded-xl p-4 border border-green-100 dark:border-green-900/30">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-green-700 dark:text-green-400">TAMAMLANDI</h3>
                                <span id="count-done"
                                    class="bg-green-100 dark:bg-green-900/30 px-2 py-0.5 rounded text-xs font-bold text-green-700 dark:text-green-400">0</span>
                            </div>
                            <div id="pn-col-done" class="flex-grow overflow-y-auto space-y-3 custom-scrollbar"
                                ondrop="dropPersonalNote(event, 'done')" ondragover="allowDropPN(event)">
                                <!-- Note Cards -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APP CONTENT (Orders, Dashboard etc.) -->
            <div id="appContent" class="hidden pb-24">
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div class="min-w-0 flex-1">
                        <h2 id="pageTitle"
                            class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white truncate">Dashboard</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs truncate">Operasyon Yönetimi</p>
                    </div>
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <div id="filterContainer" class="hidden flex-1 md:flex-none">
                            <select id="customerFilter" onchange="render()"
                                class="w-full px-3 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl outline-none text-xs">
                                <option value="">Müşteri Seç</option>
                            </select>
                        </div>
                        <div class="relative flex-1 md:flex-none">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                            <input type="text" id="globalSearch" placeholder="Ara..."
                                class="pl-8 pr-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl outline-none w-full md:w-48 text-xs"
                                onkeyup="handleSearch()">
                        </div>

                        <!-- NEW: SELECT ALL CHECKBOX CONTAINER -->
                        <div id="selectAllContainer"
                            class="hidden flex items-center gap-2 mr-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 px-3 py-2 rounded-xl h-[34px] md:h-auto">
                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"
                                class="w-4 h-4 accent-blue-600 cursor-pointer rounded">
                            <label for="selectAllCheckbox"
                                class="text-xs font-bold text-slate-600 dark:text-slate-300 cursor-pointer select-none whitespace-nowrap">Tümünü
                                Seç</label>
                        </div>

                        <div class="flex gap-1 flex-wrap">
                            <button onclick="openModal()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-xl flex items-center gap-2 shadow-lg text-xs font-bold"><i
                                    class="fas fa-plus"></i> Ekle</button>
                            <button onclick="exportToExcel()"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-xl text-xs font-bold"
                                title="Excel"><i class="fas fa-file-excel"></i></button>
                            <button onclick="exportToPDF()" id="pdfBtn"
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-xl text-xs font-bold hidden"
                                title="PDF Dışa Aktar"><i class="fas fa-file-pdf"></i> PDF</button>
                            <button onclick="document.getElementById('excelImport').click()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-xl text-xs font-bold"
                                title="İçe Aktar"><i class="fas fa-file-import"></i></button>
                            <input type="file" id="excelImport" class="hidden" accept=".xlsx, .xls, .csv"
                                onchange="importFromExcel(event)">
                        </div>
                    </div>
                </header>

                <!-- Dashboard Details -->
                <div id="dashboardStats" class="space-y-4 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div
                            class="glass-panel p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm min-w-0">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider truncate w-full">Aktif
                                Siparişler</span>
                            <span id="dashActiveCount" class="text-xl font-black text-blue-600 leading-none">0</span>
                        </div>
                        <div
                            class="glass-panel p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm min-w-0">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider truncate w-full">Geciken
                                / Kritik</span>
                            <span id="dashCriticalCount" class="text-xl font-black text-red-500 leading-none">0</span>
                        </div>
                        <div
                            class="glass-panel p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm min-w-0">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider truncate w-full">Toplam
                                TRY</span>
                            <span id="dashSumTRY"
                                class="text-sm font-black text-slate-800 dark:text-white leading-none">₺0</span>
                        </div>
                        <div
                            class="glass-panel p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm min-w-0">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider truncate w-full">Toplam
                                USD</span>
                            <span id="dashSumUSD" class="text-sm font-black text-emerald-600 leading-none">$0</span>
                        </div>
                        <div
                            class="glass-panel p-4 rounded-2xl flex flex-col justify-center items-center text-center shadow-sm min-w-0">
                            <span
                                class="text-[9px] font-black text-slate-400 uppercase mb-1 tracking-wider truncate w-full">Toplam
                                EUR</span>
                            <span id="dashSumEUR" class="text-sm font-black text-orange-600 leading-none">€0</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">Aktif Süreç
                                Dağılımı</h4>
                            <div id="processDistribution" class="space-y-2"></div>
                        </div>
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">En Yüksek
                                Hacimli</h4>
                            <div id="topCustomers" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="mainContent" class="bg-transparent overflow-hidden hidden flex-1">
                    <div id="orderListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10">
                    </div>
                </div>
            </div>

            <!-- KANBAN CONTENT (New Module) -->
            <div id="kanbanContainer" class="hidden h-full flex flex-col pb-4">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white truncate">Teklif Takip
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs truncate">Satış & İlişki Yönetimi</p>
                    </div>
                    <button onclick="openProposalModal()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-lg text-xs font-bold"><i
                            class="fas fa-plus"></i> Yeni Not</button>
                </header>

                <div class="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                    <div class="flex gap-6 h-full min-w-[1200px]">
                        <!-- Column 1: Teklif -->
                        <div class="kanban-col flex-1 bg-slate-100/80 dark:bg-slate-900/50 rounded-2xl flex flex-col border border-slate-200 dark:border-slate-800"
                            ondrop="drop(event, 'Offer')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)"
                            ondragleave="dragLeave(event)">
                            <div
                                class="p-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-white/50 dark:bg-slate-800/50 rounded-t-2xl">
                                <span class="text-xs font-black text-slate-500 uppercase tracking-widest">Teklif</span>
                                <span
                                    class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[9px] font-bold px-2 py-0.5 rounded-full"
                                    id="countOffer">0</span>
                            </div>
                            <div id="colOffer" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3"></div>
                        </div>

                        <!-- Column 2: Takip -->
                        <div class="kanban-col flex-1 bg-blue-50/80 dark:bg-blue-900/10 rounded-2xl flex flex-col border border-blue-100 dark:border-blue-900/30"
                            ondrop="drop(event, 'FollowUp')" ondragover="allowDrop(event)"
                            ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                            <div
                                class="p-4 border-b border-blue-100 dark:border-blue-900/30 flex justify-between items-center bg-white/50 dark:bg-slate-800/50 rounded-t-2xl">
                                <span class="text-xs font-black text-blue-500 uppercase tracking-widest">Takip</span>
                                <span
                                    class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 text-[9px] font-bold px-2 py-0.5 rounded-full"
                                    id="countFollowUp">0</span>
                            </div>
                            <div id="colFollowUp" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3"></div>
                        </div>

                        <!-- Column 3: Sonuç -->
                        <div class="kanban-col flex-1 bg-emerald-50/80 dark:bg-emerald-900/10 rounded-2xl flex flex-col border border-emerald-100 dark:border-emerald-900/30"
                            ondrop="drop(event, 'Result')" ondragover="allowDrop(event)" ondragenter="dragEnter(event)"
                            ondragleave="dragLeave(event)">
                            <div
                                class="p-4 border-b border-emerald-100 dark:border-emerald-900/30 flex justify-between items-center bg-white/50 dark:bg-slate-800/50 rounded-t-2xl">
                                <span class="text-xs font-black text-emerald-500 uppercase tracking-widest">Sonuç</span>
                                <span
                                    class="bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 text-[9px] font-bold px-2 py-0.5 rounded-full"
                                    id="countResult">0</span>
                            </div>
                            <div id="colResult" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3"></div>
                        </div>

                        <!-- Column 4: Tamamlandı / Arşiv -->
                        <div class="kanban-col flex-1 bg-slate-200/80 dark:bg-slate-800/50 rounded-2xl flex flex-col border border-slate-300 dark:border-slate-700"
                            ondrop="drop(event, 'Archived')" ondragover="allowDrop(event)"
                            ondragenter="dragEnter(event)" ondragleave="dragLeave(event)">
                            <div
                                class="p-4 border-b border-slate-300 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50 rounded-t-2xl">
                                <span
                                    class="text-xs font-black text-slate-600 dark:text-slate-400 uppercase tracking-widest">Tamamlandı
                                    / Arşiv</span>
                                <span
                                    class="bg-slate-300 dark:bg-slate-700 text-slate-700 dark:text-slate-200 text-[9px] font-bold px-2 py-0.5 rounded-full"
                                    id="countArchived">0</span>
                            </div>
                            <div id="colArchived" class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROPOSAL ARCHIVE CONTENT -->
            <div id="propArchiveContainer" class="hidden h-full flex flex-col pb-4">
                <header class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 dark:text-white truncate">Tamamlananlar
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400 text-xs truncate">Satış Arşivi</p>
                    </div>
                </header>
                <div id="propArchiveList"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto custom-scrollbar pb-10">
                </div>
            </div>


        </main>
    </div>

    <!-- Modals -->
    <!-- Order Modal -->
    <div id="orderModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-end md:items-center justify-center sm:p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-t-3xl md:rounded-3xl w-full max-w-4xl h-[90vh] md:max-h-[85vh] overflow-y-auto shadow-2xl p-6 border-t md:border border-slate-200 dark:border-slate-800 animate-slide-up">
            <div
                class="sticky top-0 bg-white dark:bg-slate-900 z-10 flex justify-between items-center mb-6 pb-2 border-b border-slate-100 dark:border-slate-800">
                <h3 id="modalTitle" class="text-lg font-bold dark:text-white">Sipariş Detayı</h3>
                <div class="flex items-center gap-2">
                    <button id="deleteBtn"
                        class="hidden text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition"
                        onclick="deleteCurrentOrder()"><i class="fas fa-trash"></i></button>
                    <button onclick="closeModal()"
                        class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i
                            class="fas fa-times"></i></button>
                </div>
            </div>
            <form id="orderForm" class="grid grid-cols-1 md:grid-cols-3 gap-6 pb-20 md:pb-0">
                <input type="hidden" id="editId" name="editId">
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-blue-600 uppercase border-b border-blue-100 pb-1">Temel Bilgiler
                    </h4>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Cari Adı</label><input
                            type="text" name="customerName" required
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Ürün Kodu</label><input
                            type="text" name="productCodeCust" required
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Sipariş No</label><input
                            type="text" name="orderNo" required
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Unison Kod</label><input
                            type="text" name="productCodeUnison"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-blue-600 uppercase border-b border-blue-100 pb-1">Miktar & Tutar
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Toplam Adet</label><input
                                type="number" name="totalQty" required
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Teslim
                                Edilen</label><input type="number" name="deliveredQty" value="0"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Birim Fiyat</label><input
                                type="number" step="0.0001" name="unitPrice" required
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Döviz</label><select
                                name="currency"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none">
                                <option>TRY</option>
                                <option>USD</option>
                                <option>EUR</option>
                            </select></div>
                    </div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Koli İçi Adet</label><input
                            type="number" name="qtyPerBox" value="1"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-xs font-bold text-blue-600 uppercase border-b border-blue-100 pb-1">Lojistik & Detay
                    </h4>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Durum</label><select
                            name="status"
                            class="w-full bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none font-medium">
                            <option value="Production">Üretim</option>
                            <option value="Imported">İthal Ürün</option>
                            <option value="Stock">Stok</option>
                            <option value="Complete">Tamamlandı</option>
                        </select></div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Termin Tarihi</label><input
                            type="date" name="deadline" required
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Nakliye</label><select
                                name="shippingType"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none">
                                <option>Ambar</option>
                                <option>Kargo</option>
                                <option>Özmal Araç</option>
                                <option>Müşteri Aracı</option>
                            </select></div>
                        <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Konum</label><input
                                type="text" name="shipmentLocation"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                    </div>
                    <div><label class="block text-xs font-medium mb-1 dark:text-slate-400">Notlar</label><textarea
                            name="revisionNotes" rows="2"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition"></textarea>
                    </div>
                </div>
                <div
                    class="col-span-1 md:col-span-3 pt-4 flex gap-3 fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 md:static md:p-0 md:bg-transparent md:border-0 z-20">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-medium transition active:bg-slate-100">İptal</button>
                    <button type="submit"
                        class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg shadow-blue-500/30 transition active:scale-95">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shipment Modal -->
    <div id="shipmentModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-end md:items-center justify-center sm:p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-t-3xl md:rounded-3xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl p-6 border-t md:border border-slate-200 dark:border-slate-800 animate-slide-up">
            <div
                class="sticky top-0 bg-white dark:bg-slate-900 z-10 flex justify-between items-center mb-6 pb-2 border-b border-slate-100 dark:border-slate-800">
                <h3 class="text-lg font-bold dark:text-white" id="shipmentModalTitle">Yeni Sevkiyat</h3>
                <button onclick="closeShipmentModal()"
                    class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition"><i
                        class="fas fa-times dark:text-white"></i></button>
            </div>
            <form id="shipmentForm" class="space-y-5">
                <input type="hidden" id="shipmentEditId" name="shipmentEditId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Başlangıç Tarihi</label>
                        <input type="date" name="startDate" id="shipStartDate" required
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Bitiş Tarihi</label>
                        <input type="date" name="endDate" id="shipEndDate"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Firma / Müşteri</label>
                        <input type="text" name="customer" id="shipCustomer" required placeholder="Müşteri Adı"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Logo</label>
                        <div class="relative">
                            <input type="file" accept="image/*" id="shipLogoInput"
                                onchange="handleShipLogoUpload(event)"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div id="shipLogoPreview"
                                class="w-full border border-dashed border-slate-300 dark:border-slate-700 rounded-lg flex items-center justify-center bg-slate-50 dark:bg-slate-950 text-slate-400 h-[46px] overflow-hidden">
                                <span class="text-xs flex items-center gap-1"><i class="fas fa-upload"></i> Logo
                                    Seç</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1 dark:text-slate-400">Sevk Adresi</label>
                    <input type="text" name="address" id="shipAddress" placeholder="Teslimat Adresi"
                        class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1 dark:text-slate-400">Ürün</label>
                    <input type="text" name="product" id="shipProduct" placeholder="Örn: şişe / kapak / pompa"
                        class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div
                    class="bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-100 dark:border-blue-900/30">
                    <label class="block text-xs font-bold text-blue-800 dark:text-blue-300 mb-2">Miktar
                        Hesaplama</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <input type="number" name="quantity" id="shipQuantity" placeholder="Toplam Adet"
                                oninput="calcShipBoxes()"
                                class="w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        <div>
                            <input type="number" name="itemsPerBox" id="shipItemsPerBox" placeholder="Koli İçi Adet"
                                oninput="calcShipBoxes()"
                                class="w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                    </div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-2 text-right font-medium"
                        id="shipBoxCalcResult">
                        Otomatik hesaplanacak
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1 dark:text-slate-400">Açıklama / Not</label>
                    <input type="text" name="notes" id="shipNotes" placeholder="Özel Notlar"
                        class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                </div>
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="shipIsImportant" name="isImportant"
                        class="w-5 h-5 accent-red-600 rounded cursor-pointer">
                    <label for="shipIsImportant"
                        class="text-sm font-semibold text-red-700 dark:text-red-400 cursor-pointer">Önemli
                        Sevkiyat</label>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeShipmentModal()"
                        class="px-6 py-3 rounded-xl text-xs font-bold border border-slate-300 dark:border-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition">Vazgeç</button>
                    <button type="submit" id="shipmentSubmitBtn"
                        class="px-8 py-3 rounded-xl text-xs font-black text-white bg-emerald-600 hover:bg-emerald-700 shadow-lg transition uppercase tracking-widest">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Biota Edit Modal -->
    <div id="biotaEditModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md p-6 border border-slate-200 dark:border-slate-800 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold dark:text-white mb-4">Sipariş Güncelle</h3>
            <form id="biotaEditForm">
                <input type="hidden" id="biotaEditOrderId">
                <div class="mb-4">
                    <label class="block mb-1 text-xs font-medium text-slate-500 dark:text-slate-400">Malzeme</label>
                    <input type="text" id="biotaEditInfo" readonly
                        class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm text-slate-500">
                </div>
                <div class="mb-6">
                    <label class="block mb-2 text-xs font-medium text-green-600 dark:text-green-400">Eklenecek
                        Miktar</label>
                    <input type="number" id="biotaEditTeslimEdilen" required
                        class="w-full bg-slate-50 dark:bg-slate-950 border-2 border-green-500 rounded-lg p-3 text-lg font-bold outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeBiotaEditModal()"
                        class="px-5 py-2 rounded-lg border border-slate-300 dark:border-slate-700 text-sm font-bold dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition">İptal</button>
                    <button type="submit"
                        class="px-6 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold transition">Güncelle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Biota Delete Modal -->
    <div id="biotaDeleteModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 border border-slate-200 dark:border-slate-800 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold text-red-500 mb-2">Siparişi Sil</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Bu siparişi kalıcı olarak silmek istediğinizden
                emin misiniz?</p>
            <input type="hidden" id="biotaDeleteOrderId">
            <div class="flex justify-end gap-3">
                <button onclick="closeBiotaDeleteModal()"
                    class="px-5 py-2 rounded-lg border border-slate-300 dark:border-slate-700 text-sm font-bold dark:text-white hover:bg-slate-100 dark:hover:bg-slate-800 transition">Vazgeç</button>
                <button onclick="confirmBiotaDelete()"
                    class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-bold transition">Sil</button>
            </div>
        </div>
    </div>

    <!-- Biota Catalog Modal -->
    <div id="biotaCatalogModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto p-6 border border-slate-200 dark:border-slate-800 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100 dark:border-slate-800">
                <h3 class="text-lg font-bold dark:text-white">Ürün Kataloğu Yönetimi</h3>
                <button onclick="closeBiotaCatalog()"
                    class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition"><i
                        class="fas fa-times dark:text-white"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                    <h4 class="text-xs font-bold text-teal-600 uppercase mb-3">Yeni Ürün Tanımla</h4>
                    <form id="biotaAddProductForm" class="space-y-3">
                        <input type="text" id="biotaCatCode" placeholder="Malzeme No (Örn: 2003080)" required
                            class="w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-teal-500">
                        <textarea id="biotaCatDesc" placeholder="Malzeme Açıklaması" required
                            class="w-full bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-teal-500"
                            rows="2"></textarea>
                        <button type="submit"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm transition">Listeye
                            Ekle</button>
                    </form>
                </div>
                <div class="md:col-span-2">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Kayıtlı Ürünler</h4>
                    <div class="overflow-y-auto max-h-[400px] border border-slate-200 dark:border-slate-700 rounded-xl">
                        <table class="w-full text-sm text-left">
                            <thead
                                class="text-[10px] uppercase text-slate-500 bg-slate-100 dark:bg-slate-800 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2">Kod</th>
                                    <th class="px-3 py-2">Açıklama</th>
                                    <th class="px-3 py-2 w-10">Sil</th>
                                </tr>
                            </thead>
                            <tbody id="biotaCatalogTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div id="linkModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-sm p-6 border border-slate-200 dark:border-slate-800 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold dark:text-white mb-4">Yeni Kısayol</h3>
            <form onsubmit="saveNewLink(event)">
                <div class="space-y-4">
                    <input type="text" id="linkName" required
                        class="w-full border dark:border-slate-800 dark:bg-slate-950 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition"
                        placeholder="İsim (Örn: Banka)">
                    <input type="url" id="linkUrl" required
                        class="w-full border dark:border-slate-800 dark:bg-slate-950 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition"
                        placeholder="Link (https://...)">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeLinkModal()"
                        class="px-4 py-2 rounded-lg border dark:border-slate-700 text-slate-600 dark:text-slate-300">Vazgeç</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold">Ekle</button>
                </div>
            </form>
        </div>
    </div>



    <!-- PROPOSAL MODAL -->
    <div id="proposalModal"
        class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-lg p-6 border border-slate-200 dark:border-slate-800 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold dark:text-white">Kart Detayı</h3>
                <div class="flex gap-2">
                    <button id="deletePropBtn" onclick="deleteProposal()"
                        class="hidden text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg"><i
                            class="fas fa-trash"></i></button>
                    <button onclick="closeProposalModal()"
                        class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i
                            class="fas fa-times"></i></button>
                </div>
            </div>
            <form id="proposalForm" onsubmit="saveProposal(event)">
                <input type="hidden" id="propId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Başlık</label>
                        <input type="text" id="propTitle" required
                            class="w-full border dark:border-slate-800 dark:bg-slate-950 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1 dark:text-slate-400">Açıklama</label>
                        <textarea id="propDesc" rows="4"
                            class="w-full border dark:border-slate-800 dark:bg-slate-950 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium mb-1 dark:text-slate-400">Hatırlatıcı Tarihi</label>
                            <input type="date" id="propReminder"
                                class="w-full border dark:border-slate-800 dark:bg-slate-950 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1 dark:text-slate-400">Dosya Ekle</label>
                            <div class="relative">
                                <input type="file" id="propFile"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    onchange="handleFileSelect(event)">
                                <div class="w-full border border-dashed border-slate-300 dark:border-slate-700 rounded-lg p-3 text-xs text-center text-slate-400"
                                    id="fileNameDisplay">Dosya Seç (PDF, JPG)</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeProposalModal()"
                        class="px-4 py-2 rounded-lg border dark:border-slate-700 text-slate-600 dark:text-slate-300">Vazgeç</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-bold shadow-lg">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-4 left-4 right-4 md:right-8 md:left-auto md:w-auto bg-slate-900 dark:bg-blue-600 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-40 transition-transform duration-300 z-[200] text-center text-sm font-medium">
        Mesaj</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyApndGw-eVvtsVTwtPitHuQkldHsjJ4QTw",
            authDomain: "unison-kam-grkm.firebaseapp.com",
            projectId: "unison-kam-grkm",
            storageBucket: "unison-kam-grkm.firebasestorage.app",
            messagingSenderId: "694763291293",
            appId: "1:694763291293:web:768b0d4b798d93397b8a74"
        };
        let db, auth;
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); } catch (e) { console.warn(e); }

        // Use DOMContentLoaded to ensure elements exist before initApp
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    initApp();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                }
            });
        });

        async function handleLogin(e) { e.preventDefault(); try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } catch (e) { document.getElementById('authError').innerText = "Giriş hatası."; document.getElementById('authError').classList.remove('hidden'); } }
        function handleLogout() { auth.signOut(); }

        let orders = [], todos = [], motivationData = {}, quickLinks = [], proposals = [], shipments = [];
        let biotaOrders = [], biotaProducts = {}, biotaEditedOrderNos = new Set(), biotaSelectedIds = new Set();
        let priceListCustomers = [], currentPriceCustomer = null;
        let marketIntelData = [], personalNotes = [], financialData = {};
        let currentTab = 'home', selectedOrderIds = new Set();

        function initApp() {
            if (localStorage.getItem('darkMode') === 'true') document.documentElement.classList.add('dark');
            motivationData = JSON.parse(localStorage.getItem('gorkem_motivation')) || { image: "https://images.unsplash.com/photo-1497366216548-37526070297c?w=600", quote: "Başarı disiplindir.", author: "Görkem" };
            quickLinks = JSON.parse(localStorage.getItem('gorkem_links')) || [];
            // Notification permission
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            updateClock(); setInterval(updateClock, 1000);
            fetchWeather(); fetchExchangeRates(); renderCalendar();
            syncFromCloud();
            changeTab('home');
        }

        async function syncFromCloud() {
            if (!db) return;
            const doc = await db.collection("gorkem_erp").doc("backup").get();
            if (doc.exists) {
                const d = doc.data();
                orders = d.orders || [];
                todos = d.todos || [];
                if (d.motivation) motivationData = d.motivation;
                if (d.links) quickLinks = d.links;
                if (d.proposals) proposals = d.proposals;
                if (d.shipments) shipments = d.shipments;
                if (d.biotaOrders) biotaOrders = d.biotaOrders;
                if (d.biotaProducts) biotaProducts = d.biotaProducts;
                if (d.priceList) priceListCustomers = d.priceList;
                if (d.marketIntel) marketIntelData = d.marketIntel;
                if (d.personalNotes) personalNotes = d.personalNotes;
                if (d.financial) financialData = d.financial;
                saveAllLocal(); renderAll();
            } else {
                orders = JSON.parse(localStorage.getItem('unison_orders')) || [];
                // todos etc... 
                // re-implementing init fallback correctly
                todos = JSON.parse(localStorage.getItem('gorkem_todos')) || [];
                motivationData = JSON.parse(localStorage.getItem('gorkem_motivation')) || { image: 'https://images.unsplash.com/photo-1490730141103-6cac27aaab94?auto=format&fit=crop&w=1000&q=80', quote: 'Başarı bir yolculuktur, varış noktası değil.' };
                quickLinks = JSON.parse(localStorage.getItem('gorkem_links')) || [];
                proposals = JSON.parse(localStorage.getItem('gorkem_proposals')) || [];
                shipments = JSON.parse(localStorage.getItem('gorkem_shipments')) || [];
                biotaOrders = JSON.parse(localStorage.getItem('gorkem_biotaOrders')) || [];
                biotaProducts = JSON.parse(localStorage.getItem('gorkem_biotaProducts')) || {};
                priceListCustomers = JSON.parse(localStorage.getItem('gorkem_priceList')) || [];
                marketIntelData = JSON.parse(localStorage.getItem('gorkem_marketIntel')) || [];
                personalNotes = JSON.parse(localStorage.getItem('gorkem_personalNotes')) || [];
                financialData = JSON.parse(localStorage.getItem('gorkem_financial')) || {};
                renderAll();
            }
        }
        async function syncToCloud() { if (db && auth.currentUser) await db.collection("gorkem_erp").doc("backup").set({ orders, todos, motivation: motivationData, links: quickLinks, proposals, shipments, biotaOrders, biotaProducts, priceList: priceListCustomers, marketIntel: marketIntelData, personalNotes: personalNotes, financial: financialData, updatedAt: new Date().toISOString() }); }
        function saveAllLocal() {
            localStorage.setItem('unison_orders', JSON.stringify(orders));
            localStorage.setItem('gorkem_links', JSON.stringify(quickLinks));
            localStorage.setItem('gorkem_motivation', JSON.stringify(motivationData));
            localStorage.setItem('gorkem_proposals', JSON.stringify(proposals));
            localStorage.setItem('gorkem_shipments', JSON.stringify(shipments));
            localStorage.setItem('gorkem_biotaOrders', JSON.stringify(biotaOrders));
            localStorage.setItem('gorkem_biotaProducts', JSON.stringify(biotaProducts));
            localStorage.setItem('gorkem_priceList', JSON.stringify(priceListCustomers));
            localStorage.setItem('gorkem_marketIntel', JSON.stringify(marketIntelData));
            localStorage.setItem('gorkem_personalNotes', JSON.stringify(personalNotes));
            localStorage.setItem('gorkem_financial', JSON.stringify(financialData));
        }
        function saveAndRefresh() { saveAllLocal(); renderAll(); syncToCloud(); }
        function renderAll() { renderTodos(); renderMotivation(); renderLinks(); updateHomeStats(); render(); renderKanban(); renderProposalArchive(); renderShipments(); renderBiotaOrders(); renderPriceCustomers(); renderMarketIntel(); renderPersonalNotes(); setupFinancialModule(); checkProposalReminders(); }

        function editMotivation() {
            const img = prompt("Görsel URL:", motivationData.image);
            if (img === null) return;
            const txt = prompt("Söz:", motivationData.quote);
            const author = prompt("Yazar:", motivationData.author);
            if (img && txt) { motivationData = { image: img, quote: txt, author: author || "" }; saveAndRefresh(); }
        }
        function renderMotivation() {
            const el = document.getElementById('motivationImg');
            if (el) {
                el.src = motivationData.image;
                document.getElementById('motivationText').innerText = `"${motivationData.quote}"`;
                document.getElementById('motivationAuthor').innerText = motivationData.author;
            }
        }

        async function fetchExchangeRates() {
            try {
                const r = await fetch("https://api.exchangerate-api.com/v4/latest/USD");
                const d = await r.json();
                const elUSD = document.getElementById('rateUSD');
                if (elUSD) {
                    elUSD.innerText = d.rates.TRY.toFixed(2);
                    document.getElementById('rateEUR').innerText = ((1 / d.rates.EUR) * d.rates.TRY).toFixed(2);
                }
            } catch (e) {
                const elUSD = document.getElementById('rateUSD');
                if (elUSD) {
                    elUSD.innerText = "34.15";
                    document.getElementById('rateEUR').innerText = "37.20";
                }
            }
        }

        async function fetchWeather() {
            try {
                const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=41.0082&longitude=28.9784&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto");
                const d = await r.json();
                const container = document.getElementById('weeklyWeather');
                if (!container) return;
                container.innerHTML = "";
                d.daily.time.forEach((t, i) => {
                    const date = new Date(t);
                    const day = date.toLocaleDateString('tr-TR', { weekday: 'short' });
                    let icon = "☀️"; const code = d.daily.weathercode[i];
                    if (code > 3) icon = "☁️"; if (code > 60) icon = "🌧️"; if (code > 80) icon = "⛈️";
                    container.innerHTML += `
                        <div class="min-w-[70px] bg-white dark:bg-slate-800 p-3 rounded-2xl flex flex-col items-center justify-between border border-slate-100 dark:border-slate-700 shadow-sm">
                            <span class="text-[9px] font-black text-slate-400 uppercase">${day}</span>
                            <span class="text-xl my-1">${icon}</span>
                            <span class="text-[10px] font-black text-slate-800 dark:text-white">${Math.round(d.daily.temperature_2m_max[i])}°</span>
                            <span class="text-[8px] text-slate-400 font-bold">${Math.round(d.daily.temperature_2m_min[i])}°</span>
                        </div>`;
                });
            } catch (e) {
                const container = document.getElementById('weeklyWeather');
                if (container) container.innerHTML = '<span class="text-xs text-slate-400">Hata.</span>';
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            if (!container) return; // FIX: Added null check

            container.innerHTML = "";
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthDiv = document.createElement('div');
                monthDiv.className = "min-w-[240px] p-4 bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex-shrink-0";

                let title = `<div class="font-bold text-center mb-3 text-[11px] uppercase tracking-wider text-slate-700 dark:text-slate-200 border-b border-slate-50 dark:border-slate-700 pb-2">${monthDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' })}</div>`;
                let gridHeader = `<div class="calendar-grid">
                    <div class="text-[8px] font-black text-slate-300">Hf</div>
                    <div class="font-bold text-slate-500">Pt</div>
                    <div class="font-bold text-slate-500">Sa</div>
                    <div class="font-bold text-slate-500">Ça</div>
                    <div class="font-bold text-slate-500">Pe</div>
                    <div class="font-bold text-slate-500">Cu</div>
                    <div class="font-bold text-slate-400">Ct</div>
                    <div class="font-bold text-slate-400">Pa</div>`;

                let gridBody = "";
                const lastDayOfMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                let startDay = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).getDay();
                startDay = startDay === 0 ? 7 : startDay;
                // Always add the week number for the first row
                const weekStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                const janFirst = new Date(weekStart.getFullYear(), 0, 1);
                const wNum = Math.ceil(((weekStart - janFirst + ((janFirst.getDay() || 7) * 86400000)) / 604800000));
                gridBody += `<div class="week-num">${wNum}</div>`;
                for (let k = 1; k < startDay; k++) {
                    gridBody += `<div></div>`;
                }
                for (let d = 1; d <= lastDayOfMonth; d++) {
                    const currentLoopDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), d);
                    if (currentLoopDate.getDay() === 1) {
                        const janFirst = new Date(currentLoopDate.getFullYear(), 0, 1);
                        const wNum = Math.ceil(((currentLoopDate - janFirst + ((janFirst.getDay() || 7) * 86400000)) / 604800000));
                        gridBody += `<div class="week-num">${wNum}</div>`;
                    }
                    const isToday = currentLoopDate.toDateString() === now.toDateString();
                    gridBody += `<div class="calendar-day ${isToday ? 'today-highlight shadow-lg shadow-blue-500/30' : ''}">${d}</div>`;
                }
                monthDiv.innerHTML = title + gridHeader + gridBody + `</div>`;
                container.appendChild(monthDiv);
            }
        }

        function renderLinks() {
            const container = document.getElementById('quickLinksGrid');
            if (!container) return; // FIX: Added null check
            container.innerHTML = "";
            for (let i = 0; i < 8; i++) {
                const l = quickLinks[i];
                if (l) {
                    container.innerHTML += `
                        <div class="flex flex-col items-center gap-1 group relative">
                            <div onclick="window.open('${l.url}','_blank')" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center cursor-pointer shadow-sm border border-slate-100 dark:border-slate-700 hover:scale-105 transition transform">
                                <img src="https://www.google.com/s2/favicons?domain=${l.url}" class="w-5 h-5 opacity-80" onerror="this.src='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/svgs/solid/link.svg'">
                            </div>
                            <span class="text-[9px] text-slate-500 truncate w-full text-center font-medium">${l.name}</span>
                            <button onclick="removeLink(${i})" class="absolute -top-1 -right-1 bg-red-500 text-white w-4 h-4 rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 shadow-lg">×</button>
                        </div>`;
                } else {
                    container.innerHTML += `
                        <div onclick="openLinkModal()" class="flex flex-col items-center gap-1 cursor-pointer group">
                            <div class="w-10 h-10 border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-2xl flex items-center justify-center text-slate-300 dark:text-slate-700 group-hover:border-blue-400 group-hover:text-blue-400 transition">
                                <i class="fas fa-plus text-xs"></i>
                            </div>
                            <span class="text-[9px] text-slate-300 dark:text-slate-700 font-medium">Boş</span>
                        </div>`;
                }
            }
        }

        function openLinkModal() { document.getElementById('linkModal').classList.remove('hidden'); document.getElementById('linkModal').classList.add('flex'); }
        function closeLinkModal() { document.getElementById('linkModal').classList.add('hidden'); document.getElementById('linkModal').classList.remove('flex'); }
        function saveNewLink(e) { e.preventDefault(); const n = document.getElementById('linkName').value; const u = document.getElementById('linkUrl').value; if (n && u) { quickLinks.push({ name: n, url: u }); saveAndRefresh(); closeLinkModal(); } }
        function removeLink(i) { quickLinks.splice(i, 1); saveAndRefresh(); }

        function updateHomeStats() {
            const act = orders.filter(o => o.status !== 'Complete');
            const late = act.filter(o => (new Date(o.deadline) - new Date()) < 0).length;
            let tT = 0, uT = 0, eT = 0; act.forEach(o => {
                const v = o.totalQty * o.unitPrice;
                if (o.currency === 'TRY') tT += v; if (o.currency === 'USD') uT += v; if (o.currency === 'EUR') eT += v;
            });
            const elActive = document.getElementById('summaryActive');
            if (elActive) {
                elActive.innerText = act.length;
                document.getElementById('summaryLate').innerText = late;
                document.getElementById('summaryTRY').innerText = tT.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
                document.getElementById('summaryUSD').innerText = uT.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
                document.getElementById('summaryEUR').innerText = eT.toLocaleString('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            }
            if (document.getElementById('dashActiveCount')) {
                document.getElementById('dashActiveCount').innerText = act.length;
                document.getElementById('dashCriticalCount').innerText = late;
                document.getElementById('dashSumTRY').innerText = tT.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 });
                document.getElementById('dashSumUSD').innerText = uT.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
                document.getElementById('dashSumEUR').innerText = eT.toLocaleString('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
            }
        }

        function getFilteredData() {
            let data = [...orders];
            const search = document.getElementById('globalSearch').value.toLowerCase();
            if (search) data = data.filter(o => o.customerName.toLowerCase().includes(search) || o.orderNo.toLowerCase().includes(search) || o.productCodeCust.toLowerCase().includes(search));

            if (currentTab === 'dashboard') data = data.filter(o => o.status !== 'Complete');
            else if (currentTab === 'orders') {
                data = data.filter(o => o.status !== 'Complete');
                const cf = document.getElementById('customerFilter').value;
                if (cf) data = data.filter(o => o.customerName === cf);
            }
            else if (currentTab === 'archive') {
                data = data.filter(o => o.status === 'Complete');
            }
            return data;
        }

        function toggleSelectAll() {
            const visibleData = getFilteredData();
            const allSelected = visibleData.length > 0 && visibleData.every(o => selectedOrderIds.has(o.id));
            if (allSelected) visibleData.forEach(o => selectedOrderIds.delete(o.id));
            else visibleData.forEach(o => selectedOrderIds.add(o.id));
            render();
        }

        function render() {
            let data = getFilteredData();
            const selectAllCb = document.getElementById('selectAllCheckbox');
            if (data.length > 0 && data.every(o => selectedOrderIds.has(o.id))) { selectAllCb.checked = true; selectAllCb.indeterminate = false; }
            else if (data.length > 0 && data.some(o => selectedOrderIds.has(o.id))) { selectAllCb.checked = false; selectAllCb.indeterminate = true; }
            else { selectAllCb.checked = false; selectAllCb.indeterminate = false; }

            if (currentTab === 'orders') { document.getElementById('pdfBtn').classList.remove('hidden'); document.getElementById('selectAllContainer').classList.remove('hidden'); }
            else if (currentTab === 'archive') { document.getElementById('pdfBtn').classList.add('hidden'); document.getElementById('selectAllContainer').classList.add('hidden'); }
            else { document.getElementById('pdfBtn').classList.add('hidden'); document.getElementById('selectAllContainer').classList.add('hidden'); }

            renderOrderCards(data);
            if (currentTab === 'dashboard') renderAnalytics(data);

            const sel = document.getElementById('customerFilter');
            const val = sel.value;
            const activeOrders = orders.filter(o => o.status !== 'Complete');
            sel.innerHTML = '<option value="">Müşteri Seç</option>' + [...new Set(activeOrders.map(o => o.customerName))].sort().map(c => `<option ${c === val ? 'selected' : ''}>${c}</option>`).join('');
        }

        function renderOrderCards(data) {
            const container = document.getElementById('orderListContainer');
            if (!container) return;

            container.innerHTML = data.length ? '' : '<div class="col-span-full text-center py-10 text-slate-400 text-xs">Kayıt bulunamadı.</div>';
            data.forEach(o => {
                const d = o.deadline ? o.deadline.split('-').reverse().join('.') : '-';
                const late = (new Date(o.deadline) - new Date()) < 0 && o.status !== 'Complete';
                const total = (o.totalQty * o.unitPrice).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
                const isSelected = selectedOrderIds.has(o.id);
                const remainingQty = o.totalQty - o.deliveredQty;
                const totalBoxes = Math.ceil(remainingQty / (o.qtyPerBox || 1));
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-slate-900 rounded-2xl p-5 shadow-sm border relative group transition ${isSelected ? 'ring-2 ring-blue-500 border-transparent' : 'border-slate-100 dark:border-slate-800'}`;
                card.innerHTML = `
                    <div class="absolute top-4 right-4 z-10"><input type="checkbox" class="w-5 h-5 accent-blue-600 rounded cursor-pointer" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${o.id}')"></div>
                    <div class="flex flex-col mb-4 min-w-0 pr-8"><span class="text-[9px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest truncate">${o.orderNo}</span><h3 class="font-bold text-slate-900 dark:text-white text-base leading-tight truncate-2 break-words mt-1">${o.customerName}</h3></div>
                    <div class="space-y-3 text-xs">
                        <div class="grid grid-cols-2 gap-4 border-b border-slate-50 dark:border-slate-800/50 pb-3"><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Ürün Kodu</span><span class="font-semibold dark:text-slate-200 break-all">${o.productCodeCust}</span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Unison Kod</span><span class="font-semibold dark:text-slate-200 break-all">${o.productCodeUnison || '-'}</span></div></div>
                        <div class="grid grid-cols-3 gap-2 border-b border-slate-50 dark:border-slate-800/50 pb-3"><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Miktar</span><span class="font-bold text-slate-800 dark:text-white">${o.totalQty}</span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Teslim</span><span class="font-bold text-emerald-600">${o.deliveredQty}</span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Kalan</span><span class="font-bold text-orange-600">${remainingQty}</span></div></div>
                        <div class="grid grid-cols-3 gap-2 border-b border-slate-50 dark:border-slate-800/50 pb-3"><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Birim Fiyat</span><span class="font-bold">${o.unitPrice} <span class="text-[8px]">${o.currency}</span></span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Koli İçi Adet</span><span class="font-bold">${o.qtyPerBox || 1}</span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Koli Miktarı</span><span class="font-bold">${totalBoxes}</span></div></div>
                        <div class="grid grid-cols-2 gap-4 border-b border-slate-50 dark:border-slate-800/50 pb-3"><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Durum</span><span class="px-2 py-0.5 rounded bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-[9px] font-black uppercase">${o.status}</span></div><div><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Termin</span><span class="font-bold ${late ? 'text-red-500' : 'text-slate-700 dark:text-slate-300'}">${d}</span></div></div>
                        <div class="grid grid-cols-2 gap-4"><div class="min-w-0"><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Lojistik</span><div class="text-[10px] text-slate-600 dark:text-slate-400 truncate">${o.shippingType || '-'} / ${o.shipmentLocation || '-'}</div></div><div class="text-right"><span class="text-slate-400 block text-[8px] font-bold uppercase truncate">Toplam</span><span class="font-black text-slate-900 dark:text-white">${total} ${o.currency}</span></div></div>
                    </div>
                    ${o.revisionNotes ? `<div class="mt-3 bg-amber-50 dark:bg-amber-900/10 p-2 rounded-xl border border-amber-100 dark:border-amber-900/30 text-[9px] text-amber-900 dark:text-amber-200 italic break-words">${o.revisionNotes}</div>` : ''}
                    <button onclick="editOrder('${o.id}')" class="mt-4 w-full py-2.5 rounded-xl bg-slate-900 dark:bg-blue-600 text-white text-[10px] font-black uppercase tracking-widest hover:opacity-90 active:scale-95 transition">Düzenle</button>`;
                container.appendChild(card);
            });
        }

        function renderAnalytics(act) {
            const container = document.getElementById('processDistribution');
            if (!container) return; // FIX: Null check

            const dist = {};
            act.forEach(o => { if (!dist[o.status]) dist[o.status] = { count: 0, qty: 0 }; dist[o.status].count++; dist[o.status].qty += (o.totalQty || 0); });
            container.innerHTML = Object.entries(dist).map(([k, v]) => `
                <div class="mb-3 last:mb-0"><div class="flex justify-between items-end mb-1"><span class="text-slate-500 text-[10px] uppercase font-bold">${k}</span><div class="text-right"><span class="font-bold text-xs dark:text-slate-200">${v.count} Sip.</span><span class="text-[10px] text-blue-600 dark:text-blue-400 font-bold ml-1">(${v.qty.toLocaleString()} Ad.)</span></div></div><div class="h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden w-full"><div class="h-full bg-blue-500 rounded-full" style="width:${(v.count / act.length) * 100}%"></div></div></div>`).join('') || '<span class="text-xs text-slate-400">Veri yok.</span>';
            const cust = {}; act.forEach(o => cust[o.customerName] = (cust[o.customerName] || 0) + o.totalQty);
            document.getElementById('topCustomers').innerHTML = Object.entries(cust).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([k, v]) => `
                <div class="flex justify-between items-center text-xs border-b border-slate-50 dark:border-slate-800 py-2 last:border-0 min-w-0"><span class="truncate dark:text-slate-300 font-medium mr-2">${k}</span><span class="font-bold text-blue-600 whitespace-nowrap">${v.toLocaleString()} ADET</span></div>`).join('') || '<span class="text-xs text-slate-400">Veri yok.</span>';
        }

        function toggleSelect(id) { if (selectedOrderIds.has(id)) selectedOrderIds.delete(id); else selectedOrderIds.add(id); render(); }
        function trCharFix(str) { if (!str) return ""; return str.replace(/ğ/g, "g").replace(/Ğ/g, "G").replace(/ü/g, "u").replace(/Ü/g, "U").replace(/ş/g, "s").replace(/Ş/g, "S").replace(/ı/g, "i").replace(/İ/g, "I").replace(/ö/g, "o").replace(/Ö/g, "O").replace(/ç/g, "c").replace(/Ç/g, "C"); }
        function exportToPDF() {
            if (selectedOrderIds.size === 0) { showToast("Lütfen dışa aktarmak istediğiniz kayıtları seçin."); return; }
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'pt', 'a4'); const selectedOrders = orders.filter(o => selectedOrderIds.has(o.id));
            const primaryColor = [37, 99, 235]; const secondaryColor = [71, 85, 105];
            doc.setFontSize(20); doc.setTextColor(...primaryColor); doc.text(trCharFix("Siparis Listesi - Gorkem"), 40, 50);
            doc.setFontSize(10); doc.setTextColor(...secondaryColor);
            doc.text(trCharFix(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')} | Toplam Kayit: ${selectedOrders.length}`), 40, 70);
            doc.setDrawColor(226, 232, 240); doc.line(40, 85, 802, 85);
            let head, body, colStyles;
            head = [[trCharFix('Cari Adi'), trCharFix('Urun Kodu'), trCharFix('Siparis No'), trCharFix('Unison Kod'), trCharFix('Miktar'), trCharFix('Teslim'), trCharFix('Kalan'), trCharFix('Durum'), trCharFix('Termin'), trCharFix('Notlar')]];
            body = selectedOrders.map(o => [trCharFix(o.customerName), trCharFix(o.productCodeCust), trCharFix(o.orderNo), trCharFix(o.productCodeUnison), (o.totalQty || 0).toString(), (o.deliveredQty || 0).toString(), (o.totalQty - (o.deliveredQty || 0)).toString(), trCharFix(o.status), o.deadline ? o.deadline.split('-').reverse().join('.') : '-', trCharFix(o.revisionNotes)]);
            colStyles = { 0: { cellWidth: 110 }, 1: { cellWidth: 65 }, 2: { cellWidth: 65 }, 3: { cellWidth: 65 }, 4: { cellWidth: 45, halign: 'center' }, 5: { cellWidth: 45, halign: 'center' }, 6: { cellWidth: 45, halign: 'center', fontStyle: 'bold' }, 7: { cellWidth: 55 }, 8: { cellWidth: 55 }, 9: { cellWidth: 'auto' } };
            doc.autoTable({ head: head, body: body, startY: 100, theme: 'plain', styles: { fontSize: 8, cellPadding: 4, font: 'helvetica', overflow: 'linebreak', halign: 'left', valign: 'middle' }, headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' }, columnStyles: colStyles, margin: { left: 40, right: 40, bottom: 40 }, didDrawCell: function (data) { if (data.section === 'body') { doc.setDrawColor(0, 0, 0); doc.setLineWidth(0.5); doc.line(data.cell.x, data.cell.y + data.cell.height, data.cell.x + data.cell.width, data.cell.y + data.cell.height); } } });
            const pageCount = doc.internal.getNumberOfPages(); for (let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(148, 163, 184); doc.text(trCharFix(`Sayfa ${i} / ${pageCount}`), 40, 575); doc.text(trCharFix("GORK APP | Gorkem ERP Sistem Ciktisi"), 802, 575, { align: 'right' }); }
            doc.save(`GorkemERP_Rapor_${Date.now()}.pdf`); showToast("PDF Hazırlandı.");
        }

        function updateClock() { document.getElementById('digitalClock').innerText = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }); document.getElementById('currentDate').innerText = new Date().toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }); }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', document.documentElement.classList.contains('dark')); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('translate-y-40'); setTimeout(() => t.classList.add('translate-y-40'), 3000); }
        function changeTab(tab) {
            currentTab = tab; document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebarOverlay').classList.add('hidden');
            // Hide all tab content
            document.getElementById('homeContent').classList.add('hidden');
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('kanbanContainer').classList.add('hidden');
            document.getElementById('propArchiveContainer').classList.add('hidden');
            document.getElementById('shippingContent').classList.add('hidden');
            document.getElementById('biotaContent').classList.add('hidden');
            document.getElementById('colorApprovalContent').classList.add('hidden');
            document.getElementById('marketIntelContent').classList.add('hidden');
            document.getElementById('personalNotepadContent').classList.add('hidden');
            document.getElementById('financialContent').classList.add('hidden');
            const priceList = document.getElementById('priceListContent');
            priceList.classList.add('hidden');
            priceList.classList.remove('flex');

            if (tab === 'home') {
                document.getElementById('homeContent').classList.remove('hidden');
                updateHomeStats();
            }
            else if (tab === 'proposals') {
                document.getElementById('kanbanContainer').classList.remove('hidden');
                renderKanban();
            }
            else if (tab === 'propArchive') {
                document.getElementById('propArchiveContainer').classList.remove('hidden');
                renderProposalArchive();
            }
            else if (tab === 'financial') {
                const pin = prompt("Giriş şifresini giriniz :");
                if (pin !== '0999') { alert("Hatalı şifre!"); return; }
                document.getElementById('financialContent').classList.remove('hidden');
                // Ensure setup is called if not already
                if (document.getElementById('finMonthSelector').options.length === 0) setupFinancialModule();
            }
            else if (tab === 'shipping') {
                document.getElementById('shippingContent').classList.remove('hidden');
                renderShipments();
            }
            else if (tab === 'biota') {
                document.getElementById('biotaContent').classList.remove('hidden');
                renderBiotaOrders();
            }
            else if (tab === 'colorApproval') {
                document.getElementById('colorApprovalContent').classList.remove('hidden');
                // Set prep date to today if empty
                if (!document.getElementById('caDate').value) {
                    document.getElementById('caDate').valueAsDate = new Date();
                }
            }
            else if (tab === 'priceList') {
                document.getElementById('priceListContent').classList.remove('hidden');
                document.getElementById('priceListContent').classList.add('flex');
            }
            else if (tab === 'marketIntel') {
                document.getElementById('marketIntelContent').classList.remove('hidden');
                renderMarketIntel();
                if (!document.getElementById('miDate').value) document.getElementById('miDate').valueAsDate = new Date();
            }
            else if (tab === 'personalNotepad') {
                document.getElementById('personalNotepadContent').classList.remove('hidden');
                renderPersonalNotes();
            }
            else {
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('pageTitle').innerText = tab === 'orders' ? 'Siparişler' : tab === 'archive' ? 'Geçmiş' : 'Dashboard';
                const dash = document.getElementById('dashboardStats');
                if (dash) dash.style.display = tab === 'dashboard' ? 'grid' : 'none';

                const main = document.getElementById('mainContent');
                if (main) main.style.display = tab === 'dashboard' ? 'none' : 'block';

                const filter = document.getElementById('filterContainer');
                if (filter) filter.style.display = (tab === 'orders' || tab === 'archive') ? 'block' : 'none';
                render();
            }
        }
        function toggleSidebar() { const sb = document.getElementById('sidebar'); sb.classList.toggle('-translate-x-full'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); }

        let FORM, MODAL;
        document.addEventListener('DOMContentLoaded', () => {
            FORM = document.getElementById('orderForm');
            MODAL = document.getElementById('orderModal');
            if (FORM) {
                FORM.onsubmit = (e) => {
                    e.preventDefault(); const d = Object.fromEntries(new FormData(FORM).entries());
                    d.totalQty = parseInt(d.totalQty); d.deliveredQty = parseInt(d.deliveredQty); d.unitPrice = parseFloat(d.unitPrice); d.qtyPerBox = parseInt(d.qtyPerBox);
                    const editId = d.editId; delete d.editId; // editId'yi kayıttan sil
                    if (editId) { const i = orders.findIndex(x => x.id === editId); if (i > -1) orders[i] = { ...d, id: editId }; }
                    else { d.id = Date.now().toString(); orders.push(d); }
                    saveAndRefresh(); closeModal(); showToast("Kaydedildi.");
                };
            }
        });
        function editOrder(id) { const o = orders.find(x => x.id === id); if (!o) return; Object.keys(o).forEach(k => { if (FORM.elements[k]) FORM.elements[k].value = o[k] }); document.getElementById('editId').value = id; document.getElementById('deleteBtn').classList.remove('hidden'); MODAL.style.display = 'flex'; }
        function openModal() { FORM.reset(); document.getElementById('editId').value = ''; document.getElementById('deleteBtn').classList.add('hidden'); MODAL.style.display = 'flex'; }
        function closeModal() { MODAL.style.display = 'none'; }
        function deleteCurrentOrder() { if (confirm("Silmek istediğinize emin misiniz?")) { orders = orders.filter(o => o.id !== document.getElementById('editId').value); saveAndRefresh(); closeModal(); showToast("Silindi."); } }

        function exportToExcel() {
            if (orders.length === 0) return;
            let exportData = []; let sheetName = "Rapor";
            sheetName = "Sipariş Listesi";
            exportData = orders.filter(o => o.status !== 'Complete').map(o => ({ "Cari Adı": o.customerName, "Ürün Kodu": o.productCodeCust, "Sipariş No": o.orderNo, "Unison Kod": o.productCodeUnison || '-', "Toplam Adet": o.totalQty, "Teslim Edilen": o.deliveredQty, "Kalan Adet": o.totalQty - o.deliveredQty, "Birim Fiyat": o.unitPrice, "Döviz": o.currency, "Koli İçi Adet": o.qtyPerBox || 1, "Termin Tarihi": o.deadline, "Durum": o.status, "Notlar": o.revisionNotes || '' }));
            if (exportData.length === 0) { showToast("Dışa aktarılacak veri bulunamadı."); return; }
            const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `GorkemERP_${sheetName.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`); showToast("Excel dosyası indiriliyor...");
        }

        function importFromExcel(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length > 0 && confirm(`${jsonData.length} kayıt aktarılsın mı?`)) {
                    orders = [...orders, ...jsonData.map(item => ({ id: Date.now().toString() + Math.random(), customerName: item.Cari || item.customerName || "İsimsiz", productCodeCust: item.productCodeCust || "", orderNo: item.orderNo || "", totalQty: parseInt(item.totalQty) || 0, deliveredQty: 0, unitPrice: 0, currency: "TRY", status: "Production", deadline: new Date().toISOString().split('T')[0] }))];
                    saveAndRefresh();
                }
            };
            reader.readAsArrayBuffer(file); event.target.value = '';
        }

        function handleTodoKeypress(e) { if (e.key === 'Enter') addTodo() }
        function addTodo() { const v = document.getElementById('newTodoInput').value; if (!v) return; todos.push({ text: v, done: false, id: Date.now() }); document.getElementById('newTodoInput').value = ''; saveAndRefresh(); }
        function renderTodos() {
            const container = document.getElementById('todoList');
            if (container) {
                container.innerHTML = todos.map(t => `<div class="p-2 bg-white dark:bg-slate-800 rounded-xl mb-1 flex justify-between text-[10px] items-center group shadow-sm min-w-0" onclick="toggleTodo(${t.id})"><span class="flex-1 truncate ${t.done ? 'line-through opacity-40' : ''}">${t.text}</span><button onclick="deleteTodo(${t.id},event)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 px-1"><i class="fas fa-trash-alt"></i></button></div>`).join('');
                document.getElementById('todoCount').innerText = todos.length;
            }
        }
        function toggleTodo(id) { const t = todos.find(x => x.id === id); if (t) { t.done = !t.done; saveAndRefresh(); } }
        function deleteTodo(id, e) { e.stopPropagation(); todos = todos.filter(x => x.id !== id); saveAndRefresh(); }
        function handleSearch() { render(); }

        /* KANBAN LOGIC */
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        function dragLeave(ev) { ev.currentTarget.classList.remove('drag-over'); }
        function dragEnter(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev, newStatus) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const cardId = ev.dataTransfer.getData("text").replace('card-', '');
            const propIndex = proposals.findIndex(p => p.id == cardId);
            if (propIndex > -1) {
                proposals[propIndex].status = newStatus;
                saveAndRefresh();
            }
        }

        function renderKanban() {
            const cols = {
                'Offer': document.getElementById('colOffer'),
                'FollowUp': document.getElementById('colFollowUp'),
                'Result': document.getElementById('colResult'),
                'Archived': document.getElementById('colArchived')
            };

            // Check if kanban elements exist
            if (!cols['Offer']) return;

            Object.values(cols).forEach(c => c.innerHTML = '');
            const counts = { 'Offer': 0, 'FollowUp': 0, 'Result': 0, 'Archived': 0 };

            proposals.forEach(p => {
                const col = cols[p.status];
                if (col) {
                    counts[p.status]++;
                    col.appendChild(createCardElement(p));
                }
            });

            document.getElementById('countOffer').innerText = counts.Offer;
            document.getElementById('countFollowUp').innerText = counts.FollowUp;
            document.getElementById('countResult').innerText = counts.Result;
            document.getElementById('countArchived').innerText = counts.Archived;
        }

        function createCardElement(p) {
            const el = document.createElement('div');
            el.id = `card-${p.id}`;
            el.className = "kanban-card bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 hover:shadow-md transition relative group";
            el.draggable = true;
            el.ondragstart = drag;

            let dateClass = "text-slate-400";
            if (p.reminderDate) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const reminder = new Date(p.reminderDate);
                const diffTime = reminder - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays < 0) { dateClass = "text-red-500 font-bold"; el.classList.add('ring-1', 'ring-red-500', 'bg-red-50', 'dark:bg-red-900/10'); }
                else if (diffDays <= 3) { dateClass = "text-amber-500 font-bold"; el.classList.add('ring-1', 'ring-amber-400'); }
            }

            let actionBtn = '';
            if (p.status === 'Result') {
                actionBtn = `<button onclick="archiveProposal(${p.id})" class="text-[9px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 transition" title="Arşivle"><i class="fas fa-archive"></i></button>`;
            } else if (p.status === 'Archived') {
                actionBtn = `<button onclick="deleteArchivedProposal(${p.id})" class="text-[9px] bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded text-red-500 hover:bg-red-100 transition" title="Sil"><i class="fas fa-trash"></i></button>`;
            }

            el.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-sm text-slate-800 dark:text-white line-clamp-2">${p.title}</h4>
                    <button onclick="editProposal(${p.id})" class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-blue-500 transition"><i class="fas fa-pen text-xs"></i></button>
                </div>
                <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 line-clamp-3 whitespace-pre-wrap">${p.desc || ''}</p>
                <div class="flex flex-col gap-2 mt-auto">
                    ${p.fileName ? `<div class="flex items-center gap-2 text-[10px] bg-slate-50 dark:bg-slate-700/50 p-1.5 rounded border border-slate-100 dark:border-slate-700 text-blue-600 dark:text-blue-400 cursor-pointer hover:underline" onclick="alert('Dosya önizleme simülasyonu: ${p.fileName}')"><i class="fas fa-paperclip"></i> ${p.fileName}</div>` : ''}
                    <div class="flex justify-between items-center pt-2 border-t border-slate-50 dark:border-slate-700">
                        <span class="text-[9px] text-slate-300 font-mono">${new Date(p.createdAt).toLocaleDateString('tr-TR')}</span>
                        <div class="flex items-center gap-2">
                             ${p.reminderDate ? `<div class="flex items-center gap-1 ${dateClass} text-[10px]"><i class="far fa-clock"></i> ${new Date(p.reminderDate).toLocaleDateString('tr-TR')}</div>` : ''}
                             ${actionBtn}
                        </div>
                    </div>
                </div>
            `;
            return el;
        }

        function archiveProposal(id) {
            const idx = proposals.findIndex(p => p.id == id);
            if (idx > -1) {
                proposals[idx].status = 'Archived';
                saveAndRefresh();
                showToast("Arşive taşındı.");
            }
        }

        function restoreProposal(id) {
            const idx = proposals.findIndex(p => p.id == id);
            if (idx > -1) {
                proposals[idx].status = 'Result';
                saveAndRefresh();
                showToast("Panoya geri yüklendi.");
            }
        }

        function deleteArchivedProposal(id) {
            if (confirm("Tamamen silmek istediğinize emin misiniz?")) {
                proposals = proposals.filter(p => p.id != id);
                saveAndRefresh();
                showToast("Silindi.");
            }
        }

        function renderProposalArchive() {
            const container = document.getElementById('propArchiveList');
            if (!container) return; // FIX: Null check

            container.innerHTML = '';
            const archived = proposals.filter(p => p.status === 'Archived');

            if (archived.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400 text-xs">Arşivlenmiş kayıt bulunamadı.</div>';
                return;
            }

            archived.forEach(p => {
                const el = document.createElement('div');
                el.className = "bg-white dark:bg-slate-900 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col";
                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-sm text-slate-800 dark:text-white">${p.title}</h4>
                        <span class="text-[9px] font-mono text-slate-400">${new Date(p.createdAt).toLocaleDateString('tr-TR')}</span>
                    </div>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 line-clamp-3">${p.desc || ''}</p>
                    <div class="mt-auto pt-3 border-t border-slate-50 dark:border-slate-800 flex justify-end gap-2">
                        <button onclick="deleteArchivedProposal(${p.id})" class="text-xs text-red-400 hover:text-red-600 px-2 py-1"><i class="fas fa-trash"></i> Sil</button>
                        <button onclick="restoreProposal(${p.id})" class="text-xs bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 px-3 py-1 rounded-lg font-bold hover:bg-emerald-100"><i class="fas fa-undo"></i> Geri Yükle</button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        /* PROPOSAL MODAL LOGIC */
        let PROP_FORM, PROP_MODAL;
        document.addEventListener('DOMContentLoaded', () => {
            PROP_FORM = document.getElementById('proposalForm');
            PROP_MODAL = document.getElementById('proposalModal');
        });
        let tempFile = null;

        function openProposalModal() {
            PROP_FORM.reset();
            document.getElementById('propId').value = '';
            document.getElementById('deletePropBtn').classList.add('hidden');
            document.getElementById('fileNameDisplay').innerText = "Dosya Seç (PDF, JPG)";
            tempFile = null;
            PROP_MODAL.style.display = 'flex';
        }

        function editProposal(id) {
            const p = proposals.find(x => x.id == id);
            if (!p) return;
            document.getElementById('propId').value = p.id;
            document.getElementById('propTitle').value = p.title;
            document.getElementById('propDesc').value = p.desc;
            document.getElementById('propReminder').value = p.reminderDate || '';
            document.getElementById('fileNameDisplay').innerText = p.fileName || "Dosya Seç (PDF, JPG)";
            document.getElementById('deletePropBtn').classList.remove('hidden');
            tempFile = p.fileName ? { name: p.fileName } : null; // Keep existing file ref
            PROP_MODAL.style.display = 'flex';
        }

        function closeProposalModal() { PROP_MODAL.style.display = 'none'; }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                tempFile = e.target.files[0];
                document.getElementById('fileNameDisplay').innerText = tempFile.name;
            }
        }

        function saveProposal(e) {
            e.preventDefault();
            const id = document.getElementById('propId').value;
            const title = document.getElementById('propTitle').value;
            const desc = document.getElementById('propDesc').value;
            const reminderDate = document.getElementById('propReminder').value;
            const fileName = tempFile ? tempFile.name : null;

            if (id) {
                const idx = proposals.findIndex(x => x.id == id);
                if (idx > -1) {
                    proposals[idx] = { ...proposals[idx], title, desc, reminderDate, fileName };
                }
            } else {
                proposals.push({
                    id: Date.now(),
                    status: 'Offer',
                    title, desc, reminderDate, fileName,
                    createdAt: new Date().toISOString()
                });
            }
            saveAndRefresh();
            closeProposalModal();
            showToast("Not kaydedildi.");
        }

        function deleteProposal() {
            if (confirm("Bu kartı silmek istediğinize emin misiniz?")) {
                const id = document.getElementById('propId').value;
                proposals = proposals.filter(p => p.id != id);
                saveAndRefresh();
                closeProposalModal();
                showToast("Not silindi.");
            }
        }

        function checkProposalReminders() {
            if ("Notification" in window && Notification.permission === "granted") {
                const today = new Date().toISOString().split('T')[0];
                const alerts = proposals.filter(p => p.reminderDate === today);
                alerts.forEach(p => {
                    new Notification("GORK APP Hatırlatıcı", { body: `${p.title} için bugün hatırlatmanız var!` });
                });
            }
        }

        // === SEVKIYAT (SHIPPING) MODULE ===
        let shipmentLogoBase64 = null;

        function renderShipments() {
            const tbody = document.getElementById('shipmentTableBody');
            if (!tbody) return;
            if (shipments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-slate-400 italic">Henüz listeye eklenmiş bir sevkiyat yok.</td></tr>';
                return;
            }
            const fmtDate = (d) => d ? d.split('-').reverse().join('.') : '';
            tbody.innerHTML = shipments.map((s, i) => `
                <tr class="${s.isImportant ? 'bg-red-50 dark:bg-red-900/10 border-l-4 border-l-red-500' : (i % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-slate-50 dark:bg-slate-800/50')} hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition">
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 text-center align-middle">
                        <button onclick="toggleShipmentImportance('${s.id}')" class="focus:outline-none" title="Önemli olarak işaretle">
                            <i class="fas fa-exclamation-circle text-lg ${s.isImportant ? 'text-red-500' : 'text-slate-300 dark:text-slate-600 hover:text-slate-400'} transition"></i>
                        </button>
                    </td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 align-middle">
                        <div class="flex flex-col text-xs font-semibold">
                            <span>${fmtDate(s.startDate)}</span>
                            ${s.endDate ? '<span class="text-slate-400">-</span>' : ''}
                            <span>${fmtDate(s.endDate)}</span>
                        </div>
                    </td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 align-middle">
                        <div class="flex items-center gap-2">
                            ${s.logo ? `<img src="${s.logo}" alt="logo" class="w-8 h-8 object-contain border border-slate-200 dark:border-slate-700 bg-white rounded">` : ''}
                            <span class="font-bold text-slate-800 dark:text-white">${s.customer}</span>
                        </div>
                    </td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 align-middle text-slate-600 dark:text-slate-400">${s.address || '-'}</td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 align-middle">${s.product || '-'}</td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 text-center align-middle">
                        <div class="text-[10px] text-slate-400">Toplam:</div>
                        <div class="font-bold">${s.quantity || 0} Adet</div>
                        <div class="text-[10px] text-slate-400 mt-0.5">(${s.itemsPerBox || '-'} / koli)</div>
                    </td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 text-center font-black text-blue-700 dark:text-blue-300 text-lg bg-blue-50/50 dark:bg-blue-900/10 align-middle">
                        ${s.boxCount || 0}
                    </td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 align-middle italic text-slate-500 dark:text-slate-400">${s.notes || ''}</td>
                    <td class="p-3 border-b border-slate-100 dark:border-slate-800 text-center align-middle">
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="editShipment('${s.id}')" class="text-amber-500 hover:text-amber-700 p-2 rounded-full hover:bg-amber-50 dark:hover:bg-amber-900/20 transition" title="Düzenle"><i class="fas fa-edit text-sm"></i></button>
                            <button onclick="deleteShipment('${s.id}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition" title="Sil"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openShipmentModal(editId) {
            const modal = document.getElementById('shipmentModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            shipmentLogoBase64 = null;
            document.getElementById('shipmentEditId').value = '';
            document.getElementById('shipStartDate').value = '';
            document.getElementById('shipEndDate').value = '';
            document.getElementById('shipCustomer').value = '';
            document.getElementById('shipAddress').value = '';
            document.getElementById('shipProduct').value = '';
            document.getElementById('shipQuantity').value = '';
            document.getElementById('shipItemsPerBox').value = '';
            document.getElementById('shipNotes').value = '';
            document.getElementById('shipIsImportant').checked = false;
            document.getElementById('shipLogoPreview').innerHTML = '<span class="text-xs flex items-center gap-1"><i class="fas fa-upload"></i> Logo Seç</span>';
            document.getElementById('shipBoxCalcResult').innerText = 'Otomatik hesaplanacak';
            document.getElementById('shipmentModalTitle').innerText = 'Yeni Sevkiyat';
            document.getElementById('shipmentSubmitBtn').innerText = 'Ekle';
            if (document.getElementById('shipLogoInput')) document.getElementById('shipLogoInput').value = '';
        }

        function closeShipmentModal() {
            const modal = document.getElementById('shipmentModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            shipmentLogoBase64 = null;
        }

        function handleShipLogoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    shipmentLogoBase64 = reader.result;
                    document.getElementById('shipLogoPreview').innerHTML = `<img src="${reader.result}" class="h-full w-full object-contain p-1">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function calcShipBoxes() {
            const qty = parseFloat(document.getElementById('shipQuantity').value);
            const ipb = parseFloat(document.getElementById('shipItemsPerBox').value);
            const el = document.getElementById('shipBoxCalcResult');
            if (!isNaN(qty) && !isNaN(ipb) && ipb > 0) {
                el.innerText = `Tahmini: ${Math.ceil(qty / ipb)} Koli`;
            } else {
                el.innerText = 'Otomatik hesaplanacak';
            }
        }

        function editShipment(id) {
            const s = shipments.find(x => x.id == id);
            if (!s) return;
            openShipmentModal();
            document.getElementById('shipmentEditId').value = s.id;
            document.getElementById('shipStartDate').value = s.startDate || '';
            document.getElementById('shipEndDate').value = s.endDate || '';
            document.getElementById('shipCustomer').value = s.customer || '';
            document.getElementById('shipAddress').value = s.address || '';
            document.getElementById('shipProduct').value = s.product || '';
            document.getElementById('shipQuantity').value = s.quantity || '';
            document.getElementById('shipItemsPerBox').value = s.itemsPerBox || '';
            document.getElementById('shipNotes').value = s.notes || '';
            document.getElementById('shipIsImportant').checked = !!s.isImportant;
            shipmentLogoBase64 = s.logo || null;
            if (s.logo) {
                document.getElementById('shipLogoPreview').innerHTML = `<img src="${s.logo}" class="h-full w-full object-contain p-1">`;
            }
            document.getElementById('shipmentModalTitle').innerText = 'Sevkiyat Düzenle';
            document.getElementById('shipmentSubmitBtn').innerText = 'Güncelle';
            calcShipBoxes();
        }

        function deleteShipment(id) {
            if (confirm('Bu sevkiyatı silmek istediğinize emin misiniz?')) {
                shipments = shipments.filter(s => s.id != id);
                saveAndRefresh();
                showToast('Sevkiyat silindi.');
            }
        }

        function toggleShipmentImportance(id) {
            shipments = shipments.map(s => s.id == id ? { ...s, isImportant: !s.isImportant } : s);
            saveAndRefresh();
        }

        function printShipments() {
            if (shipments.length === 0) { showToast('Yazdırılacak sevkiyat bulunamadı.'); return; }
            const fmtDate = (d) => d ? d.split('-').reverse().join('.') : '';
            const rows = shipments.map((s, i) => `
                <tr style="${s.isImportant ? 'background:#fef2f2;border-left:4px solid #ef4444;' : (i % 2 === 0 ? '' : 'background:#f9fafb;')}">
                    <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">${s.isImportant ? '❗' : ''}</td>
                    <td style="padding:8px;border:1px solid #e2e8f0;font-size:11px;font-weight:600;">${fmtDate(s.startDate)}${s.endDate ? '<br>-<br>' + fmtDate(s.endDate) : ''}</td>
                    <td style="padding:8px;border:1px solid #e2e8f0;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            ${s.logo ? `<img src="${s.logo}" style="width:40px;height:40px;object-fit:contain;border:1px solid #e2e8f0;border-radius:4px;">` : ''}
                            <strong>${s.customer}</strong>
                        </div>
                    </td>
                    <td style="padding:8px;border:1px solid #e2e8f0;">${s.address || '-'}</td>
                    <td style="padding:8px;border:1px solid #e2e8f0;">${s.product || '-'}</td>
                    <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;">
                        <div style="font-size:10px;color:#94a3b8;">Toplam:</div>
                        <div style="font-weight:bold;">${s.quantity || 0} Adet</div>
                        <div style="font-size:9px;color:#94a3b8;">(${s.itemsPerBox || '-'} / koli)</div>
                    </td>
                    <td style="padding:8px;border:1px solid #e2e8f0;text-align:center;font-weight:900;font-size:16px;color:#1e3a5f;background:#eff6ff;">${s.boxCount || 0}</td>
                    <td style="padding:8px;border:1px solid #e2e8f0;font-style:italic;color:#64748b;">${s.notes || ''}</td>
                </tr>
            `).join('');
            const printHtml = `<!DOCTYPE html><html><head><title>Sevkiyat Planı</title><style>@page{size:landscape;margin:5mm;}body{font-family:Arial,sans-serif;margin:0;padding:20px;-webkit-print-color-adjust:exact;print-color-adjust:exact;}table{width:100%;border-collapse:collapse;}</style></head><body>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;border-bottom:2px solid black;padding-bottom:16px;margin-bottom:24px;">
                    <div>
                        <h1 style="font-size:24px;font-weight:bold;text-transform:uppercase;letter-spacing:2px;margin:0;">Lojistik - Sevkiyat Planı</h1>
                        <p style="font-size:13px;color:#64748b;margin:4px 0 0;">Görkem Öz</p>
                    </div>
                    <div style="text-align:right;">
                        <p style="font-size:12px;font-weight:600;">Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr style="background:#e2e8f0;font-size:11px;font-weight:bold;text-transform:uppercase;">
                            <th style="padding:10px;border:1px solid #cbd5e1;width:40px;text-align:center;">❗</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;">Tarih</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;">Firma</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;">Sevk Adresi</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;">Ürün</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;text-align:center;">Miktar</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;text-align:center;background:#dbeafe;">Koli</th>
                            <th style="padding:10px;border:1px solid #cbd5e1;">Açıklama</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </body></html>`;
            const printWin = window.open('', '_blank');
            printWin.document.write(printHtml);
            printWin.document.close();
            printWin.focus();
            setTimeout(() => { printWin.print(); }, 500);
        }

        // Shipment form setup (inside DOMContentLoaded equivalent)
        (function () {
            const setupShipForm = () => {
                const form = document.getElementById('shipmentForm');
                if (!form) return;
                form.onsubmit = (e) => {
                    e.preventDefault();
                    const editId = document.getElementById('shipmentEditId').value;
                    const qty = parseFloat(document.getElementById('shipQuantity').value) || 0;
                    const ipb = parseFloat(document.getElementById('shipItemsPerBox').value) || 0;
                    const boxCount = (ipb > 0) ? Math.ceil(qty / ipb) : 0;

                    const data = {
                        startDate: document.getElementById('shipStartDate').value,
                        endDate: document.getElementById('shipEndDate').value,
                        customer: document.getElementById('shipCustomer').value,
                        logo: shipmentLogoBase64,
                        address: document.getElementById('shipAddress').value,
                        product: document.getElementById('shipProduct').value,
                        quantity: qty,
                        itemsPerBox: ipb || '',
                        boxCount: boxCount,
                        notes: document.getElementById('shipNotes').value,
                        isImportant: document.getElementById('shipIsImportant').checked
                    };

                    if (editId) {
                        shipments = shipments.map(s => s.id == editId ? { ...s, ...data } : s);
                        showToast('Sevkiyat güncellendi.');
                    } else {
                        data.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                        shipments.push(data);
                        showToast('Sevkiyat eklendi.');
                    }
                    closeShipmentModal();
                    saveAndRefresh();
                };
            };
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupShipForm);
            } else {
                setupShipForm();
            }
        })();

        // === BIOTA SIPARIŞ TAKİP MODULE ===
        const biotaParseNumber = (str) => parseInt(String(str).replace(/\./g, ''), 10) || 0;
        const biotaFormatNumber = (num) => new Intl.NumberFormat('tr-TR').format(num);
        const biotaParseDate = (dateString) => {
            if (!dateString || typeof dateString !== 'string') return new Date(0);
            const parts = dateString.split('.');
            if (parts.length !== 3) return new Date(0);
            return new Date(parts[2], parts[1] - 1, parts[0]);
        };

        function renderBiotaOrders() {
            const tbody = document.getElementById('biotaTableBody');
            if (!tbody) return;
            const searchInput = document.getElementById('biotaSearchInput');
            const statusFilter = document.getElementById('biotaStatusFilter');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const statusTerm = statusFilter ? statusFilter.value : 'all';

            let filteredData = biotaOrders.filter(o => {
                const matchesSearch = Object.values(o).some(v => String(v).toLowerCase().includes(searchTerm));
                let matchesStatus = true;
                if (statusTerm === 'completed') matchesStatus = o.kalanMiktar <= 0;
                else if (statusTerm === 'partial') matchesStatus = o.teslimEdilenMiktar > 0 && o.kalanMiktar > 0;
                else if (statusTerm === 'pending') matchesStatus = o.teslimEdilenMiktar === 0;
                return matchesSearch && matchesStatus;
            });

            filteredData.sort((a, b) => biotaParseDate(b.siparisTarihi) - biotaParseDate(a.siparisTarihi));

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-8 text-center text-slate-400 italic">Kayıt bulunamadı.</td></tr>';
            } else {
                tbody.innerHTML = filteredData.map(order => {
                    const percent = Math.min(100, Math.round((order.teslimEdilenMiktar / order.siparisAdeti) * 100));
                    let progressColor = 'bg-red-500';
                    if (percent > 30) progressColor = 'bg-yellow-500';
                    if (percent > 70) progressColor = 'bg-blue-500';
                    if (percent >= 100) progressColor = 'bg-green-500';

                    let statusBadge = order.kalanMiktar <= 0
                        ? '<span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-[10px] font-bold">Bitti</span>'
                        : (order.teslimEdilenMiktar > 0
                            ? '<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-[10px] font-bold">Kısmi</span>'
                            : '<span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 rounded-full text-[10px] font-bold">Bekliyor</span>');

                    const isSelected = biotaSelectedIds.has(order.id);

                    return `
                    <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-teal-50/30 dark:hover:bg-teal-900/10 transition ${isSelected ? 'bg-teal-50/50 dark:bg-teal-900/20' : ''}">
                        <td class="px-4 py-3 text-center"><input type="checkbox" class="biota-row-cb w-4 h-4 accent-teal-600 rounded cursor-pointer" data-id="${order.id}" ${isSelected ? 'checked' : ''} onchange="biotaToggleRow(${order.id}, this.checked)"></td>
                        <td class="px-4 py-3 text-center">${statusBadge}</td>
                        <td class="px-4 py-3 font-bold text-slate-800 dark:text-white">${order.siparisNo}</td>
                        <td class="px-4 py-3"><div class="font-bold text-xs text-teal-700 dark:text-teal-300">${order.malzemeNo}</div><div class="text-[11px] text-slate-500 dark:text-slate-400">${order.malzemeAciklamasi}</div></td>
                        <td class="px-4 py-3 text-right text-slate-600 dark:text-slate-300">${biotaFormatNumber(order.siparisAdeti)}</td>
                        <td class="px-4 py-3 text-right font-bold text-blue-600 dark:text-blue-300">${biotaFormatNumber(order.teslimEdilenMiktar)}</td>
                        <td class="px-4 py-3">
                            <div class="flex justify-between text-[10px] mb-1">
                                <span class="${order.kalanMiktar <= 0 ? 'text-green-600' : 'text-red-500'} font-bold">${biotaFormatNumber(order.kalanMiktar)}</span>
                                <span class="text-slate-400">%${percent}</span>
                            </div>
                            <div class="bg-slate-200 dark:bg-slate-700 rounded-full h-2 w-full overflow-hidden">
                                <div class="${progressColor} h-full transition-all duration-500" style="width: ${percent}%"></div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center whitespace-nowrap">
                            <button onclick="openBiotaEditModal(${order.id})" class="text-amber-500 hover:text-amber-700 p-1.5 rounded-full hover:bg-amber-50 dark:hover:bg-amber-900/20 transition text-xs" title="Düzenle"><i class="fas fa-edit"></i></button>
                            <button onclick="openBiotaDeleteModal(${order.id})" class="text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition text-xs ml-1" title="Sil"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            }

            // Update select-all checkbox state
            const selectAllCb = document.getElementById('biotaSelectAll');
            if (selectAllCb) {
                if (filteredData.length > 0 && filteredData.every(o => biotaSelectedIds.has(o.id))) {
                    selectAllCb.checked = true; selectAllCb.indeterminate = false;
                } else if (filteredData.some(o => biotaSelectedIds.has(o.id))) {
                    selectAllCb.checked = false; selectAllCb.indeterminate = true;
                } else {
                    selectAllCb.checked = false; selectAllCb.indeterminate = false;
                }
            }
            // Show/hide bulk complete btn
            const bulkBtn = document.getElementById('biotaBulkCompleteBtn');
            if (bulkBtn) {
                if (biotaSelectedIds.size > 0) {
                    bulkBtn.classList.remove('hidden');
                    bulkBtn.textContent = `${biotaSelectedIds.size} Seçileni Tamamla`;
                } else {
                    bulkBtn.classList.add('hidden');
                }
            }
        }

        // Auto-complete from catalog
        function biotaAutoComplete(code) {
            code = code.trim();
            const descInput = document.getElementById('biotaMalzemeAciklamasi');
            const indicator = document.getElementById('biotaMatchIndicator');
            const shortcutBtn = document.getElementById('biotaAddToCatalogShortcut');
            if (biotaProducts[code]) {
                descInput.value = biotaProducts[code].desc;
                descInput.readOnly = true;
                descInput.classList.add('opacity-60');
                indicator.classList.remove('hidden');
                shortcutBtn.classList.add('hidden');
            } else {
                descInput.readOnly = false;
                descInput.value = '';
                descInput.classList.remove('opacity-60');
                indicator.classList.add('hidden');
                if (code.length > 3) {
                    shortcutBtn.classList.remove('hidden');
                    shortcutBtn.textContent = `"${code}" Kodunu Kataloğa Ekle`;
                } else {
                    shortcutBtn.classList.add('hidden');
                }
            }
        }

        function biotaAddToCatalogFromForm() {
            const code = document.getElementById('biotaMalzemeNo').value.trim();
            if (code) {
                document.getElementById('biotaCatCode').value = code;
                openBiotaCatalog();
            }
        }

        // Row selection
        function biotaToggleRow(id, checked) {
            if (checked) biotaSelectedIds.add(id); else biotaSelectedIds.delete(id);
            renderBiotaOrders();
        }

        function biotaToggleSelectAll() {
            const cb = document.getElementById('biotaSelectAll');
            document.querySelectorAll('.biota-row-cb').forEach(el => {
                const id = parseInt(el.dataset.id);
                if (cb.checked) biotaSelectedIds.add(id); else biotaSelectedIds.delete(id);
            });
            renderBiotaOrders();
        }

        function biotaBulkComplete() {
            biotaOrders.forEach(o => {
                if (biotaSelectedIds.has(o.id)) {
                    o.teslimEdilenMiktar = o.siparisAdeti;
                    o.kalanMiktar = 0;
                    biotaEditedOrderNos.add(o.siparisNo);
                }
            });
            biotaSelectedIds.clear();
            saveAndRefresh();
            showToast('Toplu işlem tamamlandı.');
        }

        // Edit modal
        function openBiotaEditModal(id) {
            const order = biotaOrders.find(o => o.id === id);
            if (!order) return;
            document.getElementById('biotaEditOrderId').value = order.id;
            document.getElementById('biotaEditInfo').value = `${order.siparisNo} - ${order.malzemeAciklamasi}`;
            document.getElementById('biotaEditTeslimEdilen').value = '';
            const modal = document.getElementById('biotaEditModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
            document.getElementById('biotaEditTeslimEdilen').focus();
        }
        function closeBiotaEditModal() {
            const modal = document.getElementById('biotaEditModal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }

        // Delete modal
        function openBiotaDeleteModal(id) {
            document.getElementById('biotaDeleteOrderId').value = id;
            const modal = document.getElementById('biotaDeleteModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeBiotaDeleteModal() {
            const modal = document.getElementById('biotaDeleteModal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }
        function confirmBiotaDelete() {
            const id = parseInt(document.getElementById('biotaDeleteOrderId').value);
            biotaOrders = biotaOrders.filter(o => o.id !== id);
            closeBiotaDeleteModal();
            saveAndRefresh();
            showToast('Sipariş silindi.');
        }

        // Catalog modal
        function openBiotaCatalog() {
            renderBiotaCatalogTable();
            const modal = document.getElementById('biotaCatalogModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function closeBiotaCatalog() {
            const modal = document.getElementById('biotaCatalogModal');
            modal.classList.add('hidden'); modal.classList.remove('flex');
        }
        function renderBiotaCatalogTable() {
            const tbody = document.getElementById('biotaCatalogTableBody');
            if (!tbody) return;
            tbody.innerHTML = Object.keys(biotaProducts).map(code => `
                <tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800">
                    <td class="px-3 py-2 font-mono text-xs text-teal-600 dark:text-teal-300 font-bold">${code}</td>
                    <td class="px-3 py-2 text-xs text-slate-600 dark:text-slate-300">${biotaProducts[code].desc}</td>
                    <td class="px-3 py-2 text-center"><button onclick="deleteBiotaProduct('${code}')" class="text-red-400 hover:text-red-600 text-lg">&times;</button></td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="p-4 text-center text-slate-400 italic text-xs">Henüz ürün eklenmemiş.</td></tr>';
        }
        function deleteBiotaProduct(code) {
            delete biotaProducts[code];
            saveAndRefresh();
            renderBiotaCatalogTable();
        }

        // Excel export
        function exportBiotaExcel() {
            if (biotaOrders.length === 0) { showToast('Veri yok.'); return; }
            const ws = XLSX.utils.json_to_sheet(biotaOrders.map(o => ({
                'SİPARİŞ NO': o.siparisNo, 'MALZEME NO': o.malzemeNo, 'AÇIKLAMA': o.malzemeAciklamasi,
                'TARİH': o.siparisTarihi, 'ADET': o.siparisAdeti, 'TESLİM': o.teslimEdilenMiktar, 'KALAN': o.kalanMiktar
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Siparişler');
            XLSX.writeFile(wb, 'Biota_Siparis_Listesi.xlsx');
            showToast('Excel dosyası indirildi.');
        }

        // Excel import
        function triggerBiotaImport() { document.getElementById('biotaImportFile').click(); }
        function biotaImportExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    const newOrders = json.map((row, index) => {
                        const siparisAdeti = biotaParseNumber(row['SİP.ADETİ'] || row['SİPARİŞ ADETİ'] || row['ADET'] || 0);
                        const teslimEdilenMiktar = biotaParseNumber(row['TESLİM EDİLEN MİKTAR'] || row['TESLİM'] || 0);
                        return {
                            id: Date.now() + index,
                            siparisNo: row['SİPARİŞ NO'] || '',
                            malzemeNo: row['MALZEME NO'] || '',
                            malzemeAciklamasi: row['MALZEME AÇIKLAMASI'] || row['AÇIKLAMA'] || '',
                            siparisTarihi: row['SİP. TARİHİ'] || row['TARİH'] || '',
                            siparisAdeti, teslimEdilenMiktar,
                            kalanMiktar: siparisAdeti - teslimEdilenMiktar
                        };
                    }).filter(row => row.siparisNo);
                    if (newOrders.length > 0) {
                        biotaOrders = newOrders;
                        saveAndRefresh();
                        showToast('Veriler güncellendi!');
                    }
                } catch (error) { showToast('Hata oluştu.'); }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        // Mail copy
        function copyBiotaMail() {
            if (biotaEditedOrderNos.size === 0) { showToast('Düzenlenen sipariş yok.'); return; }
            let txt = 'Merhaba Fatma Hanım,\n\nSevkiyatı gerçekleşecek sipariş numaraları:\n';
            biotaEditedOrderNos.forEach(no => { txt += ` ${no} \n`; });
            txt += '\nTeşekkürler\n\nGörkem';
            navigator.clipboard.writeText(txt).then(() => {
                showToast('Mail kopyalandı!');
                biotaEditedOrderNos.clear();
            });
        }

        // JSON Backup
        function backupBiotaData() {
            const backupData = { version: '5.1-gorkem', timestamp: new Date().toISOString(), orders: biotaOrders, catalog: biotaProducts };
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            const fileName = `Biota_Siparis_Yedek_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.json`;
            a.setAttribute('download', fileName);
            document.body.appendChild(a); a.click(); a.remove();
            showToast(`Yedek dosyası (${fileName}) indirildi.`);
        }

        // Biota forms setup
        (function () {
            const setupBiotaForms = () => {
                // Add order form
                const addForm = document.getElementById('biotaAddOrderForm');
                if (addForm) {
                    addForm.onsubmit = (e) => {
                        e.preventDefault();
                        const siparisAdeti = biotaParseNumber(document.getElementById('biotaSiparisAdeti').value);
                        const teslimEdilenMiktar = biotaParseNumber(document.getElementById('biotaTeslimEdilen').value);
                        const newOrder = {
                            id: Date.now(),
                            siparisNo: document.getElementById('biotaSiparisNo').value,
                            malzemeNo: document.getElementById('biotaMalzemeNo').value,
                            malzemeAciklamasi: document.getElementById('biotaMalzemeAciklamasi').value,
                            siparisTarihi: document.getElementById('biotaSiparisTarihi').value,
                            siparisAdeti, teslimEdilenMiktar,
                            kalanMiktar: siparisAdeti - teslimEdilenMiktar
                        };
                        biotaOrders.push(newOrder);
                        addForm.reset();
                        document.getElementById('biotaMalzemeAciklamasi').readOnly = false;
                        document.getElementById('biotaMalzemeAciklamasi').classList.remove('opacity-60');
                        document.getElementById('biotaMatchIndicator').classList.add('hidden');
                        saveAndRefresh();
                        showToast('Sipariş eklendi!');
                    };
                }
                // Edit form
                const editForm = document.getElementById('biotaEditForm');
                if (editForm) {
                    editForm.onsubmit = (e) => {
                        e.preventDefault();
                        const orderId = parseInt(document.getElementById('biotaEditOrderId').value);
                        const eklenecek = biotaParseNumber(document.getElementById('biotaEditTeslimEdilen').value);
                        if (eklenecek <= 0) return;
                        const order = biotaOrders.find(o => o.id === orderId);
                        if (order) {
                            order.teslimEdilenMiktar += eklenecek;
                            order.kalanMiktar = order.siparisAdeti - order.teslimEdilenMiktar;
                            biotaEditedOrderNos.add(order.siparisNo);
                            closeBiotaEditModal();
                            saveAndRefresh();
                            showToast('Güncellendi!');
                        }
                    };
                }
                // Catalog add product form
                const catForm = document.getElementById('biotaAddProductForm');
                if (catForm) {
                    catForm.onsubmit = (e) => {
                        e.preventDefault();
                        const code = document.getElementById('biotaCatCode').value.trim();
                        const desc = document.getElementById('biotaCatDesc').value.trim();
                        if (code && desc) {
                            biotaProducts[code] = { desc };
                            catForm.reset();
                            saveAndRefresh();
                            renderBiotaCatalogTable();
                            showToast('Ürün kataloğa eklendi.');
                            // refresh auto-complete if matching
                            const currentCode = document.getElementById('biotaMalzemeNo').value.trim();
                            if (currentCode === code) biotaAutoComplete(currentCode);
                        }
                    };
                }
            };
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupBiotaForms);
            } else {
                setupBiotaForms();
            }
        })();

        // === FINANCIAL MODULE ===
        function setupFinancialModule() {
            const selector = document.getElementById('finMonthSelector');
            if (!selector || selector.options.length > 0) return; // Prevent re-population

            const today = new Date();
            for (let i = -6; i <= 12; i++) {
                let d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                // Adjust for timezone issues by setting hour to 12
                d.setHours(12);
                let monthStr = d.toISOString().slice(0, 7);
                let option = document.createElement('option');
                option.value = monthStr;
                option.textContent = d.toLocaleString('tr-TR', { year: 'numeric', month: 'long' });
                selector.appendChild(option);
            }
            selector.value = today.toISOString().slice(0, 7);
            loadFinansData();
        }

        function calculateFinansTotals() {
            let totalInc = 0, totalCC = 0, totalLoan = 0, totalInv = 0;

            document.querySelectorAll('.fin-calc-inc').forEach(el => totalInc += Number(el.value) || 0);
            document.querySelectorAll('.fin-calc-cc').forEach(el => totalCC += Number(el.value) || 0);
            document.querySelectorAll('.fin-calc-loan').forEach(el => totalLoan += Number(el.value) || 0);
            document.querySelectorAll('.inv-amount').forEach(el => totalInv += Number(el.value) || 0);

            const fmt = n => n.toLocaleString('tr-TR') + ' TL';

            document.getElementById('total_income').textContent = fmt(totalInc);
            document.getElementById('total_cc').textContent = fmt(totalCC);
            document.getElementById('total_loan').textContent = fmt(totalLoan);
            document.getElementById('total_invest').textContent = fmt(totalInv);

            document.getElementById('summary_inc').textContent = fmt(totalInc);
            let allDebts = totalCC + totalLoan;
            document.getElementById('summary_debt').textContent = fmt(allDebts);
            document.getElementById('summary_inv').textContent = fmt(totalInv);
            document.getElementById('summary_net').textContent = fmt(totalInc - allDebts - totalInv);
        }

        function addInvestmentRow(type = '', qty = '', amount = '') {
            const container = document.getElementById('finInvestContainer');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-2 items-center inv-row bg-slate-50 dark:bg-slate-900 p-2 rounded';
            row.innerHTML = `
                <div class="col-span-5"><input type="text" placeholder="Tür" value="${type}" class="inv-type w-full bg-transparent border-b border-slate-300 dark:border-slate-600 text-sm focus:outline-none"></div>
                <div class="col-span-3"><input type="text" placeholder="Miktar" value="${qty}" class="inv-qty w-full bg-transparent border-b border-slate-300 dark:border-slate-600 text-sm focus:outline-none"></div>
                <div class="col-span-3"><input type="number" placeholder="Tutar" value="${amount}" class="inv-amount w-full bg-transparent border-b border-slate-300 dark:border-slate-600 text-sm focus:outline-none text-right" oninput="calculateFinansTotals()"></div>
                <div class="col-span-1 text-center"><button onclick="this.closest('.inv-row').remove(); calculateFinansTotals()" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button></div>
            `;
            container.appendChild(row);
        }

        function saveFinansData() {
            const month = document.getElementById('finMonthSelector').value;
            const data = {
                inc_maas: document.getElementById('inc_maas').value,
                inc_yemek: document.getElementById('inc_yemek').value,
                inc_hediye: document.getElementById('inc_hediye').value,
                inc_yt: document.getElementById('inc_yt').value,
                inc_rd: document.getElementById('inc_rd').value,
                inc_diger: document.getElementById('inc_diger').value,

                cc_akbank: document.getElementById('cc_akbank').value,
                cc_ykb: document.getElementById('cc_ykb').value,
                cc_garanti: document.getElementById('cc_garanti').value,
                cc_enpara: document.getElementById('cc_enpara').value,

                loan_akbank: document.getElementById('loan_akbank').value,
                loan_nurcehre: document.getElementById('loan_nurcehre').value,

                investments: []
            };

            document.querySelectorAll('.inv-row').forEach(row => {
                data.investments.push({
                    type: row.querySelector('.inv-type').value,
                    qty: row.querySelector('.inv-qty').value,
                    amount: row.querySelector('.inv-amount').value
                });
            });

            financialData[month] = data;
            saveAndRefresh();
            showToast('Finansal veriler kaydedildi.');
        }

        function loadFinansData() {
            const month = document.getElementById('finMonthSelector').value;
            const data = financialData[month] || {};

            // Clear inputs
            document.querySelectorAll('.fin-calc-inc, .fin-calc-cc, .fin-calc-loan').forEach(el => el.value = '');
            document.getElementById('finInvestContainer').innerHTML = '';

            const fields = ['inc_maas', 'inc_yemek', 'inc_hediye', 'inc_yt', 'inc_rd', 'inc_diger',
                'cc_akbank', 'cc_ykb', 'cc_garanti', 'cc_enpara',
                'loan_akbank', 'loan_nurcehre'];

            fields.forEach(f => {
                if (data[f]) document.getElementById(f).value = data[f];
            });

            if (data.investments && data.investments.length > 0) {
                data.investments.forEach(i => addInvestmentRow(i.type, i.qty, i.amount));
            } else {
                addInvestmentRow(); // Empty row
            }
            calculateFinansTotals();
        }

        function printFinansReport() {
            const selector = document.getElementById('finMonthSelector');
            const txt = selector.options[selector.selectedIndex].text;
            document.getElementById('finPrintTitle').textContent = txt + ' Finansal Raporu';
            window.print();
        }

    </script>
    <script>
        // === RENK ONAY FORMU MODULE ===
        function previewColorImage(event) {
            const reader = new FileReader();
            reader.onload = function () {
                const output = document.getElementById('caPreviewImage');
                const placeholder = document.getElementById('caPlaceholderText');
                if (output && placeholder) {
                    output.src = reader.result;
                    output.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
            };
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        function printColorApproval() {
            window.print();
        }

        // === FIYAT LISTESI MODULE ===
        function generateId() { return Math.random().toString(36).substr(2, 9); }

        function renderPriceCustomers() {
            const list = document.getElementById('plCustomerList');
            if (!list) return;
            const searchElem = document.getElementById('plSearchCustomer');
            const search = searchElem ? searchElem.value.toLowerCase() : '';
            list.innerHTML = '';

            // Sort alphabetically
            const sortedCustomers = [...priceListCustomers].sort((a, b) => a.name.localeCompare(b.name));

            sortedCustomers.filter(c => c.name.toLowerCase().includes(search)).forEach(c => {
                const li = document.createElement('li');
                li.className = `p-3 cursor-pointer flex justify-between items-center transition hover:bg-slate-50 border-l-4 ${currentPriceCustomer === c.id ? 'bg-amber-50 border-amber-500' : 'border-transparent'}`;
                li.onclick = () => selectPriceCustomer(c.id);
                li.innerHTML = `
                    <span class="text-sm font-medium ${currentPriceCustomer === c.id ? 'text-amber-700' : 'text-slate-600'}">${c.name}</span>
                    <button onclick="deletePriceCustomer('${c.id}', event)" class="text-slate-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(li);
            });
        }

        function addPriceCustomer() {
            const input = document.getElementById('plNewCustomerName');
            const name = input.value.trim();
            if (!name) { showToast('Cari adı giriniz.'); return; }
            const newC = { id: generateId(), name: name, products: [] };
            priceListCustomers.push(newC);
            saveAndRefresh();
            input.value = '';
            renderPriceCustomers();
            selectPriceCustomer(newC.id);
        }

        function deletePriceCustomer(id, e) {
            e.stopPropagation();
            if (confirm('Bu cari hesabı ve tüm kayıtlarını silmek istediğinize emin misiniz?')) {
                priceListCustomers = priceListCustomers.filter(c => c.id !== id);
                if (currentPriceCustomer === id) {
                    currentPriceCustomer = null;
                    document.getElementById('plMainContent').classList.remove('flex');
                    document.getElementById('plMainContent').classList.add('hidden');
                    document.getElementById('plEmptyState').classList.remove('hidden');
                    document.getElementById('plEmptyState').classList.add('flex');
                }
                saveAndRefresh();
                renderPriceCustomers();
            }
        }

        function selectPriceCustomer(id) {
            currentPriceCustomer = id;
            const customer = priceListCustomers.find(c => c.id === id);
            if (!customer) return;

            document.getElementById('plEmptyState').classList.add('hidden');
            document.getElementById('plEmptyState').classList.remove('flex');

            const main = document.getElementById('plMainContent');
            main.classList.remove('hidden');
            main.classList.add('flex'); // Ensure flex for layout

            document.getElementById('plCurrentCustomerTitle').innerText = customer.name;
            renderPriceCustomers(); // Update sidebar active state
            resetPriceForm();
            renderPriceProducts();
        }

        function renderPriceProducts() {
            const tbody = document.getElementById('plProductTableBody');
            if (!tbody || !currentPriceCustomer) return;
            const customer = priceListCustomers.find(c => c.id === currentPriceCustomer);
            if (!customer) return;

            if (customer.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">Kayıt bulunamadı.</td></tr>';
                return;
            }

            tbody.innerHTML = customer.products.map(p => `
                <tr class="hover:bg-slate-50 border-b border-slate-100 last:border-0 transition">
                    <td class="px-4 py-3 font-medium text-slate-700">${p.customerCode}</td>
                    <td class="px-4 py-3 text-slate-600">${p.unisonCode}</td>
                    <td class="px-4 py-3 font-bold text-slate-800">${p.price} <span class="text-xs text-slate-500 font-normal">${p.currency}</span></td>
                    <td class="px-4 py-3 text-slate-500 hidden md:table-cell">${p.moq || '-'}</td>
                    <td class="px-4 py-3 text-slate-500 hidden md:table-cell">${p.leadTime || '-'}</td>
                    <td class="px-4 py-3 text-slate-500 hidden md:table-cell">${p.validity || '-'}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editPriceProduct('${p.id}')" class="text-amber-500 hover:text-amber-700 p-1.5 hover:bg-amber-50 rounded-lg transition mr-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePriceProduct('${p.id}')" class="text-red-500 hover:text-red-700 p-1.5 hover:bg-red-50 rounded-lg transition"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function savePriceProduct(e) {
            e.preventDefault();
            if (!currentPriceCustomer) return;
            const customer = priceListCustomers.find(c => c.id === currentPriceCustomer);

            const pId = document.getElementById('plProductId').value;
            const pData = {
                id: pId || generateId(),
                customerCode: document.getElementById('plCustomerCode').value,
                unisonCode: document.getElementById('plUnisonCode').value,
                price: document.getElementById('plPrice').value,
                currency: document.getElementById('plCurrency').value,
                moq: document.getElementById('plMoq').value,
                leadTime: document.getElementById('plLeadTime').value,
                validity: document.getElementById('plValidity').value
            };

            if (pId) {
                const idx = customer.products.findIndex(p => p.id === pId);
                if (idx > -1) customer.products[idx] = pData;
            } else {
                customer.products.push(pData);
            }

            saveAndRefresh();
            resetPriceForm();
            renderPriceProducts();
            showToast('Kayıt edildi.');
        }

        function editPriceProduct(id) {
            const customer = priceListCustomers.find(c => c.id === currentPriceCustomer);
            const p = customer.products.find(p => p.id === id);
            if (!p) return;

            document.getElementById('plProductId').value = p.id;
            document.getElementById('plCustomerCode').value = p.customerCode;
            document.getElementById('plUnisonCode').value = p.unisonCode;
            document.getElementById('plPrice').value = p.price;
            document.getElementById('plCurrency').value = p.currency;
            document.getElementById('plMoq').value = p.moq;
            document.getElementById('plLeadTime').value = p.leadTime;
            document.getElementById('plValidity').value = p.validity;

            document.getElementById('plSubmitBtn').innerText = 'Güncelle';
            document.getElementById('plCancelBtn').classList.remove('hidden');
        }

        function deletePriceProduct(id) {
            if (confirm('Silmek istediğinize emin misiniz?')) {
                const c = priceListCustomers.find(x => x.id === currentPriceCustomer);
                c.products = c.products.filter(p => p.id !== id);
                saveAndRefresh();
                renderPriceProducts();
            }
        }

        function resetPriceForm() {
            document.getElementById('plProductForm').reset();
            document.getElementById('plProductId').value = '';
            document.getElementById('plSubmitBtn').innerText = 'Kayıt Ekle';
            document.getElementById('plCancelBtn').classList.add('hidden');
        }

        function exportPriceList() {
            if (priceListCustomers.length === 0) { showToast('Veri yok.'); return; }
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(priceListCustomers, null, 2));
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            const fileName = `Fiyat_Listesi_Yedek_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.json`;
            a.setAttribute('download', fileName);
            document.body.appendChild(a); a.click(); a.remove();
            showToast('Yedek indirildi.');
        }

        function importPriceList(input) {
            const file = input.files[0];
            if (!file) return;
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) { showToast('Geçersiz dosya.'); return; }

                    const existingIds = new Set(priceListCustomers.map(c => c.id));
                    let count = 0;
                    data.forEach(c => {
                        if (!existingIds.has(c.id)) {
                            priceListCustomers.push(c);
                            count++;
                        }
                    });
                    saveAndRefresh();
                    renderPriceCustomers();
                    showToast(`${count} yeni cari eklendi.`);
                } catch (err) { showToast('Hata: ' + err); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // === MARKET INTELLIGENCE MODULE ===
        const miFileInput = document.getElementById('miFileInput');
        const MI_MAX_FILE_SIZE = 500 * 1024; // 500KB

        function renderMarketIntel() {
            const container = document.getElementById('miListContainer');
            if (!container) return;
            container.innerHTML = '';

            const search = document.getElementById('miSearch').value.toLowerCase();
            const filtered = marketIntelData.filter(item =>
                item.subject.toLowerCase().includes(search) ||
                item.content.toLowerCase().includes(search) ||
                item.category.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 p-8">Kayıt bulunamadı.</div>';
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = `bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border-l-4 ${item.isImportant ? 'border-red-500 bg-red-50 dark:bg-red-900/10' : 'border-slate-300 dark:border-slate-600'}`;

                let fileHtml = '';
                if (item.attachment) {
                    fileHtml = `
                    <div class="mt-3 bg-slate-100 dark:bg-slate-700 p-2 rounded flex justify-between items-center text-xs">
                        <span class="truncate"><i class="fas fa-paperclip"></i> ${item.attachment.name} (${item.attachment.size})</span>
                        ${item.attachment.data ? `<a href="${item.attachment.data}" download="${item.attachment.name}" class="text-cyan-600 hover:text-cyan-700 font-bold">İndir</a>` : '<span class="text-xs text-red-400">Dosya yok</span>'}
                    </div>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold uppercase text-slate-500">${new Date(item.date).toLocaleDateString('tr-TR')} • ${item.category}</span>
                        <div class="flex gap-2">
                            <button onclick="editMarketIntel('${item.id}')" class="text-slate-400 hover:text-cyan-500"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteMarketIntel('${item.id}')" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold text-slate-800 dark:text-white mb-1 ${item.isImportant ? 'text-red-600' : ''}">${item.subject}</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-300 whitespace-pre-wrap">${item.content}</p>
                    ${fileHtml}
                `;
                container.appendChild(card);
            });
        }

        async function saveMarketIntel(e) {
            e.preventDefault();
            const id = document.getElementById('miEditId').value;
            const file = miFileInput.files[0];
            let attachment = null;

            if (file) {
                if (file.size > MI_MAX_FILE_SIZE) {
                    attachment = { name: file.name, size: formatBytes(file.size), type: file.type, data: null };
                    showToast('Dosya boyutu yüksek, sadece ismi kaydedildi.');
                } else {
                    const base64 = await toBase64(file);
                    attachment = { name: file.name, size: formatBytes(file.size), type: file.type, data: base64 };
                }
            } else if (id) {
                const existing = marketIntelData.find(i => i.id === id);
                if (existing) attachment = existing.attachment;
            }

            const data = {
                id: id || generateId(),
                date: document.getElementById('miDate').value,
                category: document.getElementById('miCategory').value,
                subject: document.getElementById('miSubject').value,
                content: document.getElementById('miContent').value,
                isImportant: document.getElementById('miImportant').checked,
                attachment,
                createdAt: id ? (marketIntelData.find(i => i.id === id)?.createdAt) : new Date().toISOString()
            };

            if (id) {
                const idx = marketIntelData.findIndex(i => i.id === id);
                if (idx > -1) marketIntelData[idx] = data;
            } else {
                marketIntelData.unshift(data);
            }

            saveAndRefresh();
            resetMarketIntelForm();
            showToast('Kaydedildi.');
        }

        function editMarketIntel(id) {
            const item = marketIntelData.find(i => i.id === id);
            if (!item) return;
            document.getElementById('miEditId').value = item.id;
            document.getElementById('miDate').value = item.date;
            document.getElementById('miCategory').value = item.category;
            document.getElementById('miSubject').value = item.subject;
            document.getElementById('miContent').value = item.content;
            document.getElementById('miImportant').checked = item.isImportant;
            document.getElementById('miCancelBtn').classList.remove('hidden');
        }

        function deleteMarketIntel(id) {
            if (confirm('Silmek istediğinize emin misiniz?')) {
                marketIntelData = marketIntelData.filter(i => i.id !== id);
                saveAndRefresh();
            }
        }

        function resetMarketIntelForm() {
            document.getElementById('miForm').reset();
            document.getElementById('miEditId').value = '';
            document.getElementById('miDate').valueAsDate = new Date();
            document.getElementById('miCancelBtn').classList.add('hidden');
        }

        // === PERSONAL NOTEPAD MODULE ===
        // Note: Using prompt for simple adding, or we can inject a modal.
        // Let's inject a modal for better UX as requested.

        function renderPersonalNotes() {
            const todoContainer = document.getElementById('pn-col-todo');
            const doneContainer = document.getElementById('pn-col-done');
            if (!todoContainer || !doneContainer) return;

            todoContainer.innerHTML = '';
            doneContainer.innerHTML = '';

            const todos = personalNotes.filter(n => n.status === 'todo');
            const dones = personalNotes.filter(n => n.status === 'done');

            document.getElementById('count-todo').innerText = todos.length;
            document.getElementById('count-done').innerText = dones.length;

            const createNoteCard = (note) => {
                const div = document.createElement('div');
                div.className = `bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 cursor-grab active:cursor-grabbing hover:shadow-md transition relative group`;
                div.draggable = true;
                div.ondragstart = (e) => dragStartPN(e, note.id);

                let fileIcon = '';
                if (note.attachment) {
                    if (note.attachment.type.startsWith('image/')) {
                        fileIcon = `<img src="${note.attachment.data}" class="w-full h-24 object-cover rounded-lg mt-2 mb-2">`;
                    } else {
                        fileIcon = `<div class="mt-2 text-xs bg-slate-100 dark:bg-slate-700 p-1 rounded"><i class="fas fa-paperclip"></i> ${note.attachment.name}</div>`;
                    }
                }

                div.innerHTML = `
                    <p class="text-sm font-medium text-slate-800 dark:text-gray-200 whitespace-pre-wrap">${note.content}</p>
                    ${fileIcon}
                    <div class="flex justify-between items-center mt-2 text-[10px] text-slate-400">
                        <span>${new Date(note.createdAt).toLocaleDateString('tr-TR')}</span>
                        <div class="flex">
                            <button onclick="editPersonalNote('${note.id}')" class="hover:text-blue-500 opacity-0 group-hover:opacity-100 transition mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deletePersonalNote('${note.id}')" class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                return div;
            };

            todos.forEach(n => todoContainer.appendChild(createNoteCard(n)));
            dones.forEach(n => doneContainer.appendChild(createNoteCard(n)));
        }

        function addPersonalNote() {
            // Check if modal exists, if not create it
            let modal = document.getElementById('pnModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'pnModal';
                modal.className = 'fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm hidden';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                        <div class="p-6">
                            <h3 id="pnModalTitle" class="text-lg font-bold text-slate-900 dark:text-white mb-4">Yeni Not Ekle</h3>
                            <input type="hidden" id="pnEditId">
                            <textarea id="pnNewContent" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-sm outline-none focus:ring-2 focus:ring-yellow-500 h-32 resize-none mb-4" placeholder="Notunuzu buraya yazın..."></textarea>
                            <label class="block text-xs font-bold text-slate-500 mb-1">Dosya / Görsel Ekle (Opsiyonel)</label>
                            <input type="file" id="pnNewFile" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100 mb-6">
                            <div class="flex gap-3">
                                <button onclick="closePersonalNoteModal()" class="flex-1 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold transition">İptal</button>
                                <button onclick="savePersonalNote()" id="pnSubmitBtn" class="flex-1 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white font-bold transition">Ekle</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            document.getElementById('pnNewContent').value = '';
            document.getElementById('pnNewFile').value = '';
            if (document.getElementById('pnEditId')) document.getElementById('pnEditId').value = '';
            if (document.getElementById('pnModalTitle')) document.getElementById('pnModalTitle').innerText = 'Yeni Not Ekle';
            if (document.getElementById('pnSubmitBtn')) document.getElementById('pnSubmitBtn').innerText = 'Ekle';
            modal.classList.remove('hidden');
        }

        function closePersonalNoteModal() {
            document.getElementById('pnModal').classList.add('hidden');
        }

        function editPersonalNote(id) {
            const note = personalNotes.find(n => n.id === id);
            if (!note) return;
            addPersonalNote(); // Opens modal and ensures elements exist

            // Populate fields
            document.getElementById('pnEditId').value = note.id;
            document.getElementById('pnNewContent').value = note.content;
            document.getElementById('pnModalTitle').innerText = 'Notu Düzenle';
            document.getElementById('pnSubmitBtn').innerText = 'Güncelle';
            // Note: We don't pre-fill file input as it's read-only for security, 
            // but we will keep existing attachment if no new one is selected in savePersonalNote
        }

        async function savePersonalNote() {
            const content = document.getElementById('pnNewContent').value.trim();
            const fileInput = document.getElementById('pnNewFile');
            const editId = document.getElementById('pnEditId').value;

            if (!content && fileInput.files.length === 0 && !editId) return;

            let attachment = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.size > MI_MAX_FILE_SIZE) {
                    showToast('Dosya boyutu çok yüksek!');
                    return;
                }
                const base64 = await toBase64(file);
                attachment = { name: file.name, type: file.type, data: base64 };
            }

            if (editId) {
                // Update existing
                const idx = personalNotes.findIndex(n => n.id === editId);
                if (idx > -1) {
                    personalNotes[idx].content = content;
                    // Only update attachment if a new one is uploaded
                    if (attachment) personalNotes[idx].attachment = attachment;
                    personalNotes[idx].updatedAt = new Date().toISOString();
                }
            } else {
                // Create new
                personalNotes.unshift({
                    id: generateId(),
                    content: content,
                    status: 'todo',
                    attachment: attachment,
                    createdAt: new Date().toISOString()
                });
            }

            saveAndRefresh();
            closePersonalNoteModal();
        }

        function deletePersonalNote(id) {
            personalNotes = personalNotes.filter(n => n.id !== id);
            saveAndRefresh();
        }

        function dragStartPN(e, id) { e.dataTransfer.setData('text/plain', id); }
        function allowDropPN(e) { e.preventDefault(); }
        function dropPersonalNote(e, status) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const note = personalNotes.find(n => n.id === id);
            if (note && note.status !== status) {
                note.status = status;
                saveAndRefresh();
            }
        }

        // Helpers
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>

</html>
