<!DOCTYPE html>
<html lang="tr" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GorkAPP | İş ve Kişisel Yönetim Paneli</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Excel & PDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#0f172a', secondary: '#3b82f6', accent: '#0ea5e9' }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Göz yormayan soft renkler */
        body {
            background-color: #f8fafc;
            color: #334155;
            overflow-x: hidden;
        }

        .dark body {
            background-color: #0f172a;
            color: #cbd5e1;
        }

        /* Clean UI Panel - Soft borders instead of hard shadows */
        .glass {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            border-radius: 0.75rem;
        }

        .dark .glass {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: none;
        }

        /* Scrollbar - Zarif ve İnce */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* Login Background - Soft Gradient */
        .login-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }

            body * {
                visibility: hidden;
            }

            #printArea,
            #printArea * {
                visibility: visible;
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            .no-print {
                display: none !important;
            }

            .glass {
                box-shadow: none;
                border: 1px solid #000;
            }

            #appLayout,
            main,
            #mainContent,
            .view-section,
            .overflow-y-auto,
            .overflow-hidden,
            .custom-scrollbar {
                height: auto !important;
                overflow: visible !important;
            }

            /* Color Approval Form - A4 Portrait Single Page */
            #view-color {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                height: 297mm;
                overflow: hidden;
                padding: 0 !important;
            }

            #view-color>div:first-of-type {
                width: 210mm !important;
                min-height: auto !important;
                height: 297mm !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                padding: 10mm !important;
            }
        }

        /* Kanban */
        .kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .kanban-col {
            min-width: 300px;
            flex: 1;
            background: #f1f5f9;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
        }

        .dark .kanban-col {
            background: #1e293b;
            border-color: #334155;
        }

        .kanban-item {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            cursor: grab;
        }

        .dark .kanban-item {
            background: #0f172a;
            color: white;
            border: 1px solid #334155;
        }

        /* Progress Bar Base */
        .progress-bar {
            height: 6px;
            border-radius: 10px;
            background: #e2e8f0;
            overflow: hidden;
            margin-top: 4px;
        }

        .dark .progress-bar {
            background: #334155;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden selection:bg-blue-500 selection:text-white text-sm">

    <!-- LOGIN SCREEN -->
    <div id="loginScreen"
        class="fixed inset-0 z-[100] flex items-center justify-center login-bg p-4 transition-opacity">
        <div
            class="glass p-10 shadow-2xl w-full max-w-md text-center relative overflow-hidden bg-slate-800 border-slate-700">
            <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>

            <div
                class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center shadow-lg border-2 border-slate-600 overflow-hidden bg-white">
                <img src="https://cdn.phototourl.com/uploads/2026-02-22-220adb7c-82f8-4d85-8ae0-b22a7870d1f2.jpg"
                    alt="Logo" class="w-full h-full object-cover">
            </div>

            <h1 class="text-3xl font-bold text-white mb-1 tracking-tight">Gork<span class="text-blue-500">APP</span>
            </h1>
            <p class="text-slate-400 text-xs mb-8">ERP & İş Yönetim Sistemi</p>

            <form id="authForm" class="space-y-4">
                <input type="email" id="email" required
                    class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg py-3 px-4 focus:ring-1 focus:ring-blue-500 outline-none transition text-sm"
                    placeholder="E-Posta">
                <input type="password" id="password" required
                    class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg py-3 px-4 focus:ring-1 focus:ring-blue-500 outline-none transition text-sm"
                    placeholder="Şifre">
                <div id="authError"
                    class="hidden text-red-400 text-xs bg-red-900/20 p-3 rounded border border-red-500/30"></div>
                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-3 rounded-lg transition shadow-md">Sisteme
                    Giriş Yap</button>
            </form>
        </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div id="appLayout" class="hidden w-full h-full flex bg-slate-50 dark:bg-slate-900">

        <!-- SIDEBAR -->
        <aside
            class="w-64 bg-slate-900 text-slate-300 flex flex-col h-full border-r border-slate-800 flex-shrink-0 z-20 transition-all"
            id="sidebar">
            <div class="p-5 flex items-center gap-3 border-b border-slate-800/50">
                <div class="w-10 h-10 rounded-full border border-slate-600 overflow-hidden bg-white shrink-0">
                    <img src="https://cdn.phototourl.com/uploads/2026-02-22-220adb7c-82f8-4d85-8ae0-b22a7870d1f2.jpg"
                        class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 class="font-bold text-white text-base tracking-tight">Gork<span class="text-blue-500">APP</span>
                    </h1>
                    <p id="userEmail" class="text-[10px] text-emerald-400"><i class="fas fa-circle text-[8px]"></i>
                        Çevrimiçi</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
                <!-- İş Kategorisi -->
                <div>
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">İŞ YÖNETİMİ</h3>
                    <div class="space-y-1">
                        <button onclick="nav('home')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition active-nav">
                            <i class="fas fa-home w-5 text-center text-blue-400"></i> Anasayfa
                        </button>
                        <button onclick="nav('dashboard')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-chart-pie w-5 text-center text-indigo-400"></i> Dashboard (Analiz)
                        </button>
                        <button onclick="nav('orders')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-box w-5 text-center"></i> Siparişler
                        </button>
                        <button onclick="nav('shipping')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-truck-fast w-5 text-center"></i> Sevkiyat
                        </button>
                        <button onclick="nav('biota')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 text-emerald-400 hover:text-emerald-300 transition">
                            <i class="fas fa-leaf w-5 text-center"></i> Biota Sipariş
                        </button>
                        <button
                            onclick="window.open('https://gemini.google.com/gem/17YM1pqwRfgxt1ddA1yl8rZ2u55xyCpoY?usp=sharing', '_blank')"
                            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-cube w-5 text-center"></i> CAD Çevirici
                        </button>
                        <button onclick="nav('color')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-palette w-5 text-center"></i> Renk Onay
                        </button>
                        <button onclick="nav('intel')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-user-secret w-5 text-center"></i> Pazar İstihbaratı
                        </button>
                        <button onclick="nav('prices')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-tags w-5 text-center"></i> Fiyat Listesi
                        </button>
                        <button onclick="nav('proposals')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition">
                            <i class="fas fa-handshake w-5 text-center"></i> Teklif Takip
                        </button>
                        <button
                            onclick="window.open('https://notebooklm.google.com/notebook/52441e1a-778c-4e76-9a3c-29d0fc27f550', '_blank')"
                            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition text-purple-400 hover:text-purple-300">
                            <i class="fas fa-brain w-5 text-center"></i> KAM Ai
                        </button>
                        <button onclick="nav('production')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition text-amber-500 hover:text-amber-400">
                            <i class="fas fa-industry w-5 text-center"></i> Üretim Takip
                        </button>
                    </div>
                </div>

                <!-- Kişisel Kategori -->
                <div>
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 px-2">KİŞİSEL</h3>
                    <div class="space-y-1">
                        <button onclick="nav('notes')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 transition"><i
                                class="fas fa-sticky-note w-5 text-center"></i> Not Defteri</button>
                        <button onclick="nav('finance')"
                            class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm hover:bg-slate-800 text-yellow-400 hover:text-yellow-300 transition"><i
                                class="fas fa-wallet w-5 text-center"></i> Finansal Kayıt</button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800/50">
                <button onclick="auth.signOut()"
                    class="w-full flex items-center justify-center gap-2 py-2.5 rounded-md bg-slate-800 hover:bg-red-500/20 hover:text-red-400 transition text-sm"><i
                        class="fas fa-sign-out-alt"></i> Çıkış Yap</button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <main class="flex-1 flex flex-col h-full overflow-hidden relative" id="printArea">

            <!-- TOPBAR -->
            <header
                class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 z-10 no-print flex-shrink-0">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-slate-500 hover:text-slate-800 dark:text-slate-400"
                        onclick="document.getElementById('sidebar').classList.toggle('hidden')"><i
                            class="fas fa-bars text-xl"></i></button>
                    <h2 id="pageTitle" class="text-lg font-medium text-slate-800 dark:text-white tracking-tight">
                        Dashboard (Analiz)</h2>
                </div>
                <div class="flex items-center gap-6">
                    <div class="text-right hidden sm:block">
                        <div id="topTime"
                            class="text-base font-semibold text-slate-700 dark:text-slate-200 leading-none">00:00</div>
                        <div id="topDate" class="text-[10px] font-medium text-slate-400 uppercase mt-1">...</div>
                    </div>
                </div>
            </header>

            <!-- GÜNCELLENEN: MAIN CONTENT (Scroll artık burada değil, iç modüllerde) -->
            <div class="flex-1 overflow-hidden bg-slate-50 dark:bg-slate-900 relative" id="mainContent">

                <!-- 0. ANASAYFA (HOME) -->
                <div id="view-home"
                    class="view-section w-full h-full overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-6 animate-fade-in">

                    <!-- Satır 1: Motivasyon & Özet Dashboard -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Sol: Motivasyon -->
                        <div class="lg:col-span-1">
                            <!-- Motivasyon Widget -->
                            <div
                                class="glass p-4 text-center group relative border-t-4 border-blue-500 rounded-xl flex flex-col justify-center h-full">
                                <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-3 text-sm text-center">
                                </h3>
                                <div class="relative w-full aspect-square rounded-xl overflow-hidden bg-slate-100 dark:bg-slate-800 flex items-center justify-center cursor-pointer group hover:opacity-90 transition shadow-inner"
                                    onclick="document.getElementById('imgMotivation').click()">
                                    <input type="file" id="imgMotivation" hidden accept="image/*"
                                        onchange="uploadMotivation(event)">
                                    <img id="previewMotivation"
                                        class="w-full h-full object-cover hidden absolute inset-0 z-10">
                                    <div class="text-slate-400 flex flex-col items-center">
                                        <i class="fas fa-camera text-3xl mb-2"></i>
                                        <span class="text-xs">Fotoğraf Ekle</span>
                                    </div>
                                </div>
                                <div class="mt-4 px-2">
                                    <input type="text" id="iptMotivationText"
                                        placeholder="Kısa bir motivasyon cümlesi..."
                                        class="w-full text-center text-sm font-medium italic text-slate-600 dark:text-slate-300 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none px-2 py-1 transition"
                                        onchange="saveMotivationText(this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Sağ: Özet Dashboard (Mini Kartlar) -->
                        <div class="lg:col-span-3">
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 h-full">
                                <div class="glass p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition"
                                    onclick="nav('orders')">
                                    <div
                                        class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl shrink-0">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 font-semibold mb-0.5">Aktif Siparişler</p>
                                        <h4 class="text-xl font-bold dark:text-white" id="home-kpi-active">0</h4>
                                    </div>
                                </div>
                                <div class="glass p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition"
                                    onclick="nav('orders')">
                                    <div
                                        class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-xl shrink-0">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 font-semibold mb-0.5">Kritik / Geciken</p>
                                        <h4 class="text-xl font-bold text-red-500" id="home-kpi-late">0</h4>
                                    </div>
                                </div>
                                <div class="glass p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition"
                                    onclick="nav('orders')">
                                    <div
                                        class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl shrink-0">
                                        <i class="fas fa-cubes"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 font-semibold mb-0.5">Toplam Bakiye</p>
                                        <h4 class="text-xl font-bold text-emerald-600 dark:text-emerald-400"
                                            id="home-kpi-qty">0</h4>
                                    </div>
                                </div>
                                <div class="glass p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition"
                                    onclick="nav('proposals')">
                                    <div
                                        class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xl shrink-0">
                                        <i class="fas fa-handshake"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-500 font-semibold mb-0.5">Açık Teklifler</p>
                                        <h4 class="text-xl font-bold text-indigo-600 dark:text-indigo-400"
                                            id="home-kpi-props">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Satır 2: Takvim, Hızlı Notlar, Alışveriş Hatırlatıcısı (3 Sütun) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                        <!-- Takvim (Sütun 1) -->
                        <div class="glass p-4 md:p-6 rounded-xl flex flex-col h-80">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold text-slate-700 dark:text-slate-200 text-sm"><i
                                        class="fas fa-calendar-alt text-blue-500 mr-2"></i>Takvim</h3>
                                <div class="flex gap-2 text-slate-600">
                                    <button onclick="changeCalMonth(-1)" class="hover:text-blue-500"><i
                                            class="fas fa-chevron-left"></i></button>
                                    <span id="calMonthYear" class="font-medium text-sm min-w-[100px] text-center">Ay
                                        Yıl</span>
                                    <button onclick="changeCalMonth(1)" class="hover:text-blue-500"><i
                                            class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-8 gap-y-1 flex-1 content-start">
                                <!-- Hafta Başlıkları -->
                                <div class="text-[10px] font-bold text-slate-400 text-center py-1">Hf</div>
                                <div class="text-[10px] font-bold text-slate-500 text-center py-1">Pt</div>
                                <div class="text-[10px] font-bold text-slate-500 text-center py-1">Sa</div>
                                <div class="text-[10px] font-bold text-slate-500 text-center py-1">Ça</div>
                                <div class="text-[10px] font-bold text-slate-500 text-center py-1">Pe</div>
                                <div class="text-[10px] font-bold text-slate-500 text-center py-1">Cu</div>
                                <div class="text-[10px] font-bold text-red-400 text-center py-1">Ct</div>
                                <div class="text-[10px] font-bold text-red-400 text-center py-1">Pz</div>
                                <!-- Takvim Gövdesi -->
                                <div id="calGrid" class="col-span-8 grid grid-cols-8 gap-1 auto-rows-min"></div>
                            </div>
                        </div>

                        <!-- Hızlı Notlar (Sütun 2) -->
                        <div class="glass p-4 md:p-6 rounded-xl flex flex-col h-80">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-4 text-sm"><i
                                    class="fas fa-check-square text-emerald-500 mr-2"></i>Hızlı Notlar</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="iptHomeTodo"
                                    class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-emerald-500"
                                    placeholder="Bir görev ekle..." onkeypress="if(event.key==='Enter') addHomeTodo()">
                                <button onclick="addHomeTodo()"
                                    class="bg-emerald-500 text-white px-3 rounded-lg hover:bg-emerald-600 transition"><i
                                        class="fas fa-plus"></i></button>
                            </div>
                            <div id="listHomeTodos" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-1">
                            </div>
                        </div>

                        <!-- Alışveriş Hatırlatıcısı (Sütun 3) -->
                        <div class="glass p-4 md:p-6 rounded-xl flex flex-col h-80">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200 mb-4 text-sm"><i
                                    class="fas fa-shopping-cart text-amber-500 mr-2"></i>Alışveriş Hatırlatıcısı</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="iptHomeShopping"
                                    class="flex-1 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-amber-500"
                                    placeholder="Alınacak bir şey ekle..."
                                    onkeypress="if(event.key==='Enter') addHomeShopping()">
                                <button onclick="addHomeShopping()"
                                    class="bg-amber-500 text-white px-3 rounded-lg hover:bg-amber-600 transition"><i
                                        class="fas fa-plus"></i></button>
                            </div>
                            <div id="listHomeShopping" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar pr-1">
                            </div>
                        </div>

                    </div>

                    <!-- Satır 3: Kısayollar (Tam Genişlik) -->
                    <div class="glass p-4 md:p-6 rounded-xl flex flex-col w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-slate-700 dark:text-slate-200 text-sm"><i
                                    class="fas fa-link text-indigo-500 mr-2"></i>Kısayollar</h3>
                            <button onclick="addShortcut()"
                                class="text-xs bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 px-3 py-1.5 rounded-lg transition"><i
                                    class="fas fa-plus mr-1"></i>Ekle</button>
                        </div>
                        <div id="gridShortcuts"
                            class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 flex-1 content-start">
                            <!-- Kısayollar JS ile buraya gelecek -->
                        </div>
                    </div>
                </div>

                <!-- 1. DASHBOARD -->
                <div id="view-dashboard"
                    class="view-section w-full h-full overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-5 animate-fade-in">

                    <!-- Satır 1: Ana KPI'lar -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="glass p-4 border-t-4 border-blue-500">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold">Aktif Siparişler</p>
                            <h3 class="text-2xl font-bold dark:text-white mt-1" id="dash-active">0</h3>
                        </div>
                        <div class="glass p-4 border-t-4 border-red-500">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold">Geciken / Kritik</p>
                            <h3 class="text-2xl font-bold text-red-500 mt-1" id="dash-late">0</h3>
                        </div>
                        <div class="glass p-4 border-t-4 border-emerald-500">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam Kalan Bakiye</p>
                            <h3 class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 mt-1"
                                id="dash-rem-qty">0 Adet</h3>
                        </div>
                        <div class="glass p-4 border-t-4 border-indigo-500">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam USD Hacmi</p>
                            <h3 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 mt-1" id="dash-usd">0 $
                            </h3>
                        </div>
                        <div class="glass p-4 border-t-4 border-purple-500">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam EUR Hacmi</p>
                            <h3 class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1" id="dash-eur">0 €
                            </h3>
                        </div>
                    </div>

                    <!-- Satır 2: Oranlar ve Dağılımlar -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass p-4 flex flex-col justify-center">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                OTIF (Zamanında Teslimat Oranı)</h4>
                            <div class="flex items-end gap-3">
                                <span class="text-3xl font-bold text-emerald-500" id="dash-otif">%0</span>
                                <span class="text-xs text-slate-400 mb-1">Gecikmemiş aktif siparişler</span>
                            </div>
                        </div>
                        <div class="glass p-4 md:col-span-2">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                Kaynak Dağılımı (Sipariş Adedi)</h4>
                            <div class="flex justify-around items-center h-12">
                                <div class="text-center"><span class="block text-xl font-bold text-blue-500"
                                        id="dash-src-prod">0</span><span
                                        class="text-[10px] text-slate-500">Üretim</span></div>
                                <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                                <div class="text-center"><span class="block text-xl font-bold text-orange-500"
                                        id="dash-src-imp">0</span><span class="text-[10px] text-slate-500">İthal</span>
                                </div>
                                <div class="w-px h-8 bg-slate-200 dark:bg-slate-700"></div>
                                <div class="text-center"><span class="block text-xl font-bold text-teal-500"
                                        id="dash-src-stk">0</span><span class="text-[10px] text-slate-500">Stok</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Satır 3: Analiz Kartları -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass p-4">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                <i class="fas fa-fire text-orange-500 mr-1"></i> Termin Isı Haritası
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center text-sm"><span
                                        class="text-red-500 font-medium"><i class="fas fa-exclamation-circle mr-1"></i>
                                        < 7 Gün</span><span
                                                class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-bold"
                                                id="dash-heat-7">0</span></div>
                                <div class="flex justify-between items-center text-sm"><span
                                        class="text-orange-500 font-medium"><i class="fas fa-clock mr-1"></i> 7 - 15
                                        Gün</span><span
                                        class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold"
                                        id="dash-heat-15">0</span></div>
                                <div class="flex justify-between items-center text-sm"><span
                                        class="text-blue-500 font-medium"><i class="fas fa-calendar-alt mr-1"></i> 15 -
                                        30 Gün</span><span
                                        class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold"
                                        id="dash-heat-30">0</span></div>
                            </div>
                        </div>
                        <div class="glass p-4">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                <i class="fas fa-hourglass-end text-red-500 mr-1"></i> Gecikme Analizi (Aging)
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">1 - 10 Gün Geciken</span><span
                                        class="font-bold text-slate-800 dark:text-white" id="dash-age-10">0</span></div>
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">11 - 20 Gün Geciken</span><span
                                        class="font-bold text-slate-800 dark:text-white" id="dash-age-20">0</span></div>
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">21+ Gün Geciken</span><span
                                        class="font-bold text-red-500" id="dash-age-21">0</span></div>
                            </div>
                        </div>
                        <div class="glass p-4">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                <i class="fas fa-coins text-yellow-500 mr-1"></i> Döviz Bazlı Bekleyen Tahsilat
                            </h4>
                            <div class="space-y-3">
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">USD Hacmi</span><span
                                        class="font-mono font-bold text-indigo-600 dark:text-indigo-400"
                                        id="dash-col-usd">0 $</span></div>
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">EUR Hacmi</span><span
                                        class="font-mono font-bold text-purple-600 dark:text-purple-400"
                                        id="dash-col-eur">0 €</span></div>
                                <div class="flex justify-between text-sm"><span
                                        class="text-slate-600 dark:text-slate-300">TL Hacmi</span><span
                                        class="font-mono font-bold text-emerald-600 dark:text-emerald-400"
                                        id="dash-col-tl">0 ₺</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Satır 4: Listeler -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="glass p-4">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                Açık Sipariş Yoğunluğu (Top 5)</h4>
                            <div id="dash-top-customers" class="space-y-3"></div>
                        </div>
                        <div class="glass p-4 md:col-span-2">
                            <h4
                                class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                                Unison Üretim Tamamlanma Yüzdesi</h4>
                            <div id="dash-unison-progress"
                                class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-48 overflow-y-auto custom-scrollbar pr-2">
                            </div>
                        </div>
                    </div>

                    <!-- Satır 5: Lojistik -->
                    <div class="glass p-4">
                        <h4
                            class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-100 dark:border-slate-700 pb-2 mb-3">
                            <i class="fas fa-truck-loading text-blue-500 mr-1"></i> Lojistik / Sevkiyat Hazırlık Aşaması
                            (Kısmi Teslimatlar)
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="text-slate-500 border-b border-slate-100 dark:border-slate-700">
                                    <tr>
                                        <th class="pb-2 font-medium">Sipariş No</th>
                                        <th class="pb-2 font-medium">Müşteri</th>
                                        <th class="pb-2 font-medium">Durum (Teslim/Toplam)</th>
                                        <th class="pb-2 font-medium">Kalan</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-logistics" class="divide-y divide-slate-50 dark:divide-slate-800/50">
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- 2. SİPARİŞLER (GÜNCELLENDİ: ARTIK TAM EKRAN VE SADECE İÇİ SCROLL EDİYOR) -->
                <div id="view-orders" class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4">
                    <div
                        class="flex flex-wrap justify-between items-center gap-2 no-print shrink-0 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                                <input type="text" id="searchOrders" placeholder="Sipariş veya Müşteri Ara..."
                                    class="pl-9 pr-3 py-2 rounded-lg border border-slate-200 dark:bg-slate-900 dark:border-slate-700 text-sm w-64 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                    onkeyup="renderOrders()">
                            </div>
                            <select id="filterOrders" onchange="renderOrders()"
                                class="px-3 py-2 rounded-lg border border-slate-200 dark:bg-slate-900 dark:border-slate-700 text-sm font-medium text-slate-600 dark:text-slate-300 outline-none">
                                <option value="all">Tüm Siparişler</option>
                                <option value="active" selected>Aktif Siparişler</option>
                                <option value="completed">Tamamlananlar</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('fileOrdersExcel').click()"
                                class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 px-3 py-2 rounded-lg text-sm transition font-medium"><i
                                    class="fas fa-file-import mr-1"></i> İçe Aktar</button>
                            <input type="file" id="fileOrdersExcel" class="hidden" accept=".xlsx, .xls"
                                onchange="importOrdersExcel(event)">
                            <button onclick="exportExcel('Siparişler', appData.orders)"
                                class="bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 px-3 py-2 rounded-lg text-sm transition font-medium"><i
                                    class="fas fa-file-excel mr-1"></i> Excel</button>
                            <button onclick="exportOrdersPDF()" id="btnOrdersPdf"
                                class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded-lg text-sm transition font-medium"><i
                                    class="fas fa-file-pdf mr-1"></i> PDF Çıktı</button>
                            <button onclick="openModal('orderModal')"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm"><i
                                    class="fas fa-plus mr-1"></i> Yeni Sipariş</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center no-print shrink-0 px-1">
                        <span class="text-xs text-slate-500" id="orderCountText">Toplam 0 sipariş listeleniyor.</span>
                        <button onclick="deleteSelected('orders')"
                            class="text-red-500 px-3 py-1.5 rounded text-xs font-medium hover:bg-red-50 dark:hover:bg-slate-800 transition"><i
                                class="fas fa-trash mr-1"></i> Seçili Olanları Sil</button>
                    </div>

                    <!-- BURASI TAM EKRAN ESNİYOR (flex-1) VE İÇİ SCROLL OLUYOR -->
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        <div class="flex items-center gap-2 mb-3 no-print">
                            <input type="checkbox" onchange="toggleSelectAll('orders', this.checked)"
                                class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-xs text-slate-500">Tümünü Seç</span>
                        </div>
                        <div id="gridOrders" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <!-- 3. SEVKİYAT (GÜNCELLENDİ) -->
                <div id="view-shipping" class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4">
                    <div
                        class="flex flex-wrap justify-between items-center gap-2 no-print shrink-0 bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                            <input type="text" id="searchShipping" placeholder="Müşteri veya Adres Ara..."
                                class="pl-9 pr-3 py-2 rounded-lg border border-slate-200 dark:bg-slate-900 dark:border-slate-700 text-sm w-64 focus:border-blue-500 outline-none transition"
                                onkeyup="renderShipping()">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportExcel('Sevkiyat', appData.shipping)"
                                class="bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 px-3 py-2 rounded-lg text-sm transition font-medium"><i
                                    class="fas fa-file-excel mr-1"></i> Excel</button>
                            <button onclick="exportShippingPDF()" id="btnShippingPdf"
                                class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded-lg text-sm transition font-medium"><i
                                    class="fas fa-file-pdf mr-1"></i> PDF Çıktı</button>
                            <button onclick="openModal('shippingModal')"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm"><i
                                    class="fas fa-plus mr-1"></i> Yeni Plan</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center no-print shrink-0 px-1">
                        <span class="text-xs text-slate-500">Sevkiyat listesi gösteriliyor.</span>
                        <button onclick="deleteSelected('shipping')"
                            class="text-red-500 px-3 py-1.5 rounded text-xs font-medium hover:bg-red-50 dark:hover:bg-slate-800 transition"><i
                                class="fas fa-trash mr-1"></i> Seçili Olanları Sil</button>
                    </div>

                    <div class="glass rounded-xl overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar">
                            <table id="tableShipping" class="w-full text-sm text-left border-collapse">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 sticky top-0 z-10 border-b border-slate-200 dark:border-slate-700 text-xs uppercase tracking-wide">
                                    <tr>
                                        <th class="p-3 no-print w-10"><input type="checkbox"
                                                onchange="toggleSelectAll('shipping', this.checked)"
                                                class="rounded border-slate-300 text-blue-600"></th>
                                        <th class="p-3 w-8"></th>
                                        <th class="p-3 min-w-[120px] font-semibold">Tarih Planı</th>
                                        <th class="p-3 min-w-[150px] font-semibold">Firma Bilgisi</th>
                                        <th class="p-3 min-w-[150px] font-semibold">Ürün İçeriği</th>
                                        <th class="p-3 min-w-[110px] font-semibold">Miktar / Koli</th>
                                        <th class="p-3 min-w-[220px] font-semibold">Adres / Lokasyon</th>
                                        <th class="p-3 min-w-[180px] font-semibold">Notlar</th>
                                        <th class="p-3 no-print w-14 text-center font-semibold">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyShipping"
                                    class="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-900/40">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 4. BİOTA SİPARİŞ (GÜNCELLENDİ) -->
                <div id="view-biota" class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4">
                    <div
                        class="glass p-4 border-l-4 border-emerald-500 bg-emerald-50/50 dark:bg-emerald-900/10 flex justify-between items-center shrink-0">
                        <div>
                            <h3 class="font-bold text-emerald-700 dark:text-emerald-400">Biota Özel Sipariş Modülü</h3>
                            <p class="text-xs text-slate-500">Kısmi teslimatları girerek ana siparişten otomatik
                                düşürün.</p>
                        </div>
                        <button onclick="copyBiotaMail()"
                            class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-emerald-500 transition"><i
                                class="fas fa-envelope mr-1"></i> Maile Kopyala</button>
                    </div>
                    <div class="flex flex-wrap justify-between items-center gap-2 no-print shrink-0">
                        <input type="text" id="searchBiota" placeholder="Malzeme No, Açıklama..."
                            class="px-3 py-2 rounded-lg border border-slate-200 dark:bg-slate-900 dark:border-slate-700 text-sm w-64 outline-none"
                            onkeyup="renderBiota()">
                        <div class="flex gap-2">
                            <button onclick="exportExcel('Biota', appData.biota)"
                                class="bg-emerald-50 text-emerald-600 border border-emerald-200 px-3 py-2 rounded-lg text-sm font-medium"><i
                                    class="fas fa-file-excel mr-1"></i> Excel</button>
                            <input type="file" id="biotaExcelInput" accept=".xlsx, .xls" class="hidden"
                                onchange="importBiotaExcel(event)">
                            <button onclick="document.getElementById('biotaExcelInput').click()"
                                class="bg-blue-50 text-blue-600 border border-blue-200 px-3 py-2 rounded-lg text-sm font-medium"><i
                                    class="fas fa-file-import mr-1"></i> İçe Aktar</button>
                            <button onclick="openModal('biotaModal')"
                                class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium"><i
                                    class="fas fa-plus mr-1"></i> Sipariş Ekle</button>
                        </div>
                    </div>
                    <div class="flex gap-2 no-print shrink-0"><button onclick="deleteSelected('biota')"
                            class="text-red-500 px-3 py-1.5 text-xs font-medium"><i class="fas fa-trash mr-1"></i>
                            Sil</button></div>

                    <div class="glass rounded-xl overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 sticky top-0 z-10 border-b border-slate-200 dark:border-slate-700 text-xs uppercase tracking-wide">
                                    <tr>
                                        <th class="p-3"><input type="checkbox"
                                                onchange="toggleSelectAll('biota', this.checked)"></th>
                                        <th class="p-3">Sipariş No</th>
                                        <th class="p-3">Malzeme No</th>
                                        <th class="p-3">Açıklama</th>
                                        <th class="p-3">Tarih</th>
                                        <th class="p-3">Sipariş Adet</th>
                                        <th class="p-3">Kalan</th>
                                        <th class="p-3">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyBiota"
                                    class="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-900/40">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. RENK ONAY (GÜNCELLENDİ) -->
                <div id="view-color"
                    class="view-section hidden w-full h-full overflow-y-auto custom-scrollbar p-4 md:p-6">
                    <div class="flex justify-end mb-4 no-print"><button onclick="exportColorPDF()"
                            class="bg-slate-800 text-white px-4 py-2 rounded-lg font-medium"><i
                                class="fas fa-file-pdf mr-1"></i> PDF Çıktı</button></div>
                    <div
                        class="bg-white w-[210mm] min-h-[297mm] mx-auto p-[15mm] border border-gray-200 text-black shadow-sm">
                        <header class="flex justify-between border-b-4 border-slate-800 pb-4 mb-6">
                            <div><img
                                    src="https://www.unison.com.tr/wp-content/uploads/2024/11/cropped-logo_unison-300x70.png"
                                    class="h-12"></div>
                            <div class="text-right">
                                <h1 class="text-2xl font-bold uppercase text-slate-800">Renk Onay Formu</h1>
                                <p class="text-xs text-slate-500 mt-1">COLOR APPROVAL FORM</p>
                            </div>
                        </header>
                        <div class="grid grid-cols-2 gap-y-4 gap-x-8 mb-6">
                            <div><label class="block text-xs font-bold text-slate-500">DÜZENLEYEN</label><input
                                    type="text"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500">TARİH</label><input type="date"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500">FİRMA</label><input type="text"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500">İLGİLİ KİŞİ</label><input
                                    type="text"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                            <div class="col-span-2"><label
                                    class="block text-xs font-bold text-slate-500">ÜRÜN</label><input type="text"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                            <div class="col-span-2"><label class="block text-xs font-bold text-slate-500">RENK
                                    TANIMI</label><input type="text"
                                    class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent">
                            </div>
                        </div>
                        <div class="border-2 border-dashed border-gray-300 h-64 flex items-center justify-center relative group cursor-pointer"
                            onclick="document.getElementById('colorImg').click()"><input type="file" id="colorImg"
                                hidden accept="image/*"
                                onchange="previewImage(event, 'previewColorImg', 'phColorImg')"><span id="phColorImg"
                                class="text-gray-400 group-hover:text-blue-500"><i
                                    class="fas fa-image text-3xl mb-2 block text-center"></i>Görsel Eklemek İçin
                                Tıklayın</span><img id="previewColorImg"
                                class="absolute inset-0 w-full h-full object-contain hidden p-2"></div>
                        <div class="mt-4"><label class="block text-xs font-bold text-slate-500">NOTLAR</label><textarea
                                class="w-full border-b border-gray-300 py-1 outline-none text-sm bg-transparent resize-none"
                                rows="2"></textarea></div>
                        <div class="mt-12 pt-6 border-t border-gray-300 flex justify-between items-end">
                            <div>
                                <p class="font-bold text-sm">Unison Dış Ticaret A.Ş.</p>
                                <p class="text-xs text-gray-500 mt-1">Onay (Kaşe/İmza)</p>
                            </div>
                            <div class="border border-gray-400 w-48 h-24 p-2 relative"><span
                                    class="absolute top-2 text-xs font-bold text-gray-500">MÜŞTERİ ONAYI</span><span
                                    class="absolute bottom-2 right-2 text-[10px] text-gray-400">Tarih:
                                    ___/___/20___</span></div>
                        </div>
                    </div>
                </div>

                <!-- 6. PAZAR İSTİHBARATI (GÜNCELLENDİ) -->
                <div id="view-intel"
                    class="view-section hidden w-full h-full overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-medium text-slate-800 dark:text-white">Sahadan Bilgiler</h3><button
                            onclick="openModal('intelModal')"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium"><i
                                class="fas fa-plus mr-1"></i> Not Ekle</button>
                    </div>
                    <div id="gridIntel" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>

                <!-- 7. FİYAT LİSTESİ (GÜNCELLENDİ) -->
                <div id="view-prices" class="view-section hidden w-full h-full p-4 md:p-6">
                    <div class="flex h-full gap-4">
                        <div class="w-1/3 glass flex flex-col overflow-hidden">
                            <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <input type="text" id="searchPriceCust" placeholder="Müşteri Ara..."
                                    class="px-3 py-1.5 text-sm border rounded-md w-full mr-2 outline-none"
                                    onkeyup="renderPriceLists()"><button onclick="addPriceCustomer()"
                                    class="bg-blue-600 text-white w-8 h-8 rounded-md shrink-0"><i
                                        class="fas fa-plus"></i></button>
                            </div>
                            <ul id="listPriceCustomers"
                                class="flex-1 overflow-y-auto custom-scrollbar divide-y divide-slate-100"></ul>
                        </div>
                        <div class="w-2/3 glass flex flex-col overflow-hidden">
                            <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <h3 id="selectedPriceCustomerName" class="font-medium">Lütfen Müşteri Seçin</h3><button
                                    onclick="addPriceProduct()" id="btnAddPriceProd"
                                    class="hidden bg-emerald-600 text-white px-3 py-1.5 rounded-md text-sm"><i
                                        class="fas fa-plus mr-1"></i> Ürün Ekle</button>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-0">
                                <table class="w-full text-sm text-left">
                                    <thead
                                        class="bg-white border-b border-slate-100 text-slate-500 text-xs uppercase sticky top-0 z-10">
                                        <tr>
                                            <th class="p-3">Unison Ürün Adı</th>
                                            <th class="p-3">Müşteri Ürün Adı</th>
                                            <th class="p-3">Fiyat</th>
                                            <th class="p-3">Geçerlilik</th>
                                            <th class="p-3 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyPriceProducts" class="divide-y divide-slate-100 bg-white"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 8. TEKLİF TAKİP (GÜNCELLENDİ) -->
                <div id="view-proposals" class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4">
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <h3 class="text-base font-medium">Satış Süreçleri</h3><button
                            onclick="openModal('proposalModal')"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium"><i
                                class="fas fa-plus mr-1"></i> Yeni Teklif</button>
                    </div>
                    <div class="kanban-board flex-1 custom-scrollbar">
                        <div class="kanban-col flex flex-col" ondrop="dropProp(event, 'Teklif')"
                            ondragover="allowDrop(event)">
                            <h4 class="font-medium text-slate-700 border-b-2 border-blue-500 pb-2 mb-3">Teklif
                                Aşamasında <span id="cnt-Teklif"
                                    class="text-xs bg-white text-slate-500 px-2 py-0.5 rounded-full float-right border border-slate-200">0</span>
                            </h4>
                            <div id="kb-Teklif" class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1"></div>
                        </div>
                        <div class="kanban-col flex flex-col" ondrop="dropProp(event, 'Takip')"
                            ondragover="allowDrop(event)">
                            <h4 class="font-medium text-slate-700 border-b-2 border-amber-500 pb-2 mb-3">Takip Ediliyor
                                <span id="cnt-Takip"
                                    class="text-xs bg-white text-slate-500 px-2 py-0.5 rounded-full float-right border border-slate-200">0</span>
                            </h4>
                            <div id="kb-Takip" class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1"></div>
                        </div>
                        <div class="kanban-col flex flex-col" ondrop="dropProp(event, 'Sonuç')"
                            ondragover="allowDrop(event)">
                            <h4 class="font-medium text-slate-700 border-b-2 border-purple-500 pb-2 mb-3">Sonuç
                                Bekleniyor <span id="cnt-Sonuç"
                                    class="text-xs bg-white text-slate-500 px-2 py-0.5 rounded-full float-right border border-slate-200">0</span>
                            </h4>
                            <div id="kb-Sonuç" class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1"></div>
                        </div>
                        <div class="kanban-col flex flex-col" ondrop="dropProp(event, 'Tamamlandı')"
                            ondragover="allowDrop(event)">
                            <h4 class="font-medium text-slate-700 border-b-2 border-emerald-500 pb-2 mb-3">
                                Tamamlandı/Arşiv <span id="cnt-Tamamlandı"
                                    class="text-xs bg-white text-slate-500 px-2 py-0.5 rounded-full float-right border border-slate-200">0</span>
                            </h4>
                            <div id="kb-Tamamlandı" class="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 9. NOTLAR (GÜNCELLENDİ) -->
                <div id="view-notes"
                    class="view-section hidden w-full h-full overflow-y-auto custom-scrollbar p-4 md:p-6 space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-base font-medium">Kişisel Notlarım</h3><button onclick="openModal('noteModal')"
                            class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium"><i
                                class="fas fa-plus mr-1"></i> Not Ekle</button>
                    </div>
                    <div id="gridNotes" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>

                <!-- 10. FİNANS (GÜNCELLENDİ) -->
                <div id="view-finance"
                    class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4 pb-10">
                    <div
                        class="flex justify-between items-center glass p-3 rounded-xl no-print flex-wrap gap-4 shrink-0">
                        <div class="flex items-center gap-3"><label class="text-sm font-medium text-slate-600">Ay / Yıl
                                Seçimi:</label><input type="month" id="finMonthPicker"
                                onchange="changeFinMonth(this.value)"
                                class="border border-slate-200 p-2 rounded-lg text-sm outline-none focus:border-blue-500">
                        </div>
                        <div class="flex gap-2"><button onclick="exportPDF('Finansal Kayıt', 'finPrintArea')"
                                class="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg text-sm font-medium"><i
                                    class="fas fa-file-pdf mr-1"></i> PDF</button><button
                                onclick="openModal('financeModal')"
                                class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium"><i
                                    class="fas fa-plus mr-1"></i> Kayıt Ekle</button></div>
                    </div>
                    <div id="finPrintArea" class="flex-1 overflow-y-auto custom-scrollbar">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="glass p-4 text-center border-t-4 border-emerald-500">
                                <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam Gelir</p>
                                <h3 class="text-2xl font-bold text-emerald-600 mt-1" id="fin-tot-gelir">0 ₺</h3>
                            </div>
                            <div class="glass p-4 text-center border-t-4 border-red-500">
                                <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam Gider (KK+Kredi)
                                </p>
                                <h3 class="text-2xl font-bold text-red-600 mt-1" id="fin-tot-gider">0 ₺</h3>
                            </div>
                            <div class="glass p-4 text-center border-t-4 border-amber-500">
                                <p class="text-[10px] text-slate-500 uppercase font-semibold">Toplam Yatırım</p>
                                <h3 class="text-2xl font-bold text-amber-600 mt-1" id="fin-tot-yatirim">0 ₺</h3>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="glass p-4 flex flex-col max-h-[500px]">
                                <h4 class="text-xs font-semibold text-emerald-600 mb-3 border-b border-slate-100 pb-2">
                                    GELİRLER</h4>
                                <div id="fin-list-gelir" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                </div>
                            </div>
                            <div class="glass p-4 flex flex-col max-h-[500px]">
                                <h4 class="text-xs font-semibold text-red-500 mb-3 border-b border-slate-100 pb-2">KREDİ
                                    KARTLARI</h4>
                                <div id="fin-list-kk" class="flex-1 overflow-y-auto custom-scrollbar space-y-2"></div>
                            </div>
                            <div class="glass p-4 flex flex-col max-h-[500px]">
                                <h4 class="text-xs font-semibold text-red-600 mb-3 border-b border-slate-100 pb-2">KREDİ
                                    & BORÇ</h4>
                                <div id="fin-list-kredi" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                </div>
                            </div>
                            <div class="glass p-4 flex flex-col max-h-[500px]">
                                <h4 class="text-xs font-semibold text-amber-500 mb-3 border-b border-slate-100 pb-2">
                                    YATIRIMLAR</h4>
                                <div id="fin-list-yatirim" class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 11. ÜRETİM TAKİP -->
                <div id="view-production"
                    class="view-section hidden w-full h-full flex flex-col p-4 md:p-6 space-y-4 pb-10">
                    <div
                        class="flex flex-wrap justify-between items-center gap-4 shrink-0 glass p-4 rounded-xl no-print">
                        <div>
                            <h3 class="text-base font-bold text-slate-800 dark:text-white"><i
                                    class="fas fa-industry text-amber-500 mr-2"></i>Üretim Takip Çizelgesi</h3>
                            <p class="text-xs text-slate-500 mt-1">Haftalık toplantılar için makinelerin öngörülen bitiş
                                tarihlerini güncelleyin.</p>
                        </div>
                    </div>
                    <div class="glass rounded-xl overflow-hidden flex-1 flex flex-col shadow-sm">
                        <div class="overflow-x-auto overflow-y-auto flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead
                                    class="bg-slate-50 dark:bg-slate-800/80 text-slate-600 dark:text-slate-300 sticky top-0 z-10 border-b border-slate-200 dark:border-slate-700 text-xs uppercase tracking-wide">
                                    <tr>
                                        <th class="p-4 w-1/3">Makine Adı</th>
                                        <th class="p-4 w-1/3">Geçen Hafta Bitiş Tarihi</th>
                                        <th class="p-4 w-1/3">Bu Hafta Bitiş Tarihi</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyProduction"
                                    class="divide-y divide-slate-100 dark:divide-slate-800 bg-white dark:bg-slate-900/40">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODALS (Aynı mantık, UI temizlendi) -->
    <div id="orderModal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[150] hidden items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-900 rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl border border-slate-200">
            <h3 class="text-lg font-medium mb-4 text-slate-800 border-b border-slate-100 pb-2">Sipariş Formu</h3>
            <form id="formOrder" onsubmit="saveForm(event, 'orders')"
                class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <input type="hidden" name="id">
                <div><label class="text-xs text-slate-500">Cari / Müşteri Adı</label><input type="text" name="customer"
                        required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Sipariş No</label><input type="text" name="orderNo" required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Sipariş Tarihi</label><input type="date" name="orderDate"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Ürün Kodu</label><input type="text" name="productCode"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Unison Kod</label><input type="text" name="unisonCode"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Toplam Adet</label><input type="number" name="totalQty"
                        required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Teslim Edilen</label><input type="number" name="deliveredQty"
                        value="0"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1"><label class="text-xs text-slate-500">Birim Fiyat</label><input type="number"
                            step="0.001" name="price"
                            class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                    </div>
                    <div class="w-20"><label class="text-xs text-slate-500">Döviz</label><select name="currency"
                            class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                            <option>USD</option>
                            <option>EUR</option>
                            <option>TL</option>
                        </select></div>
                </div>
                <div><label class="text-xs text-slate-500">Koli İçi Adet</label><input type="number" name="boxQty"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Termin Tarihi</label><input type="date" name="deadline"
                        required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Durum</label><select name="status"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                        <option>Üretim</option>
                        <option>İthal</option>
                        <option>Stok</option>
                        <option>Tamamlandı</option>
                    </select></div>
                <div><label class="text-xs text-slate-500">Nakliye</label><input type="text" name="transport"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div><label class="text-xs text-slate-500">Konum</label><input type="text" name="location"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500">
                </div>
                <div class="md:col-span-3"><label class="text-xs text-slate-500">Açıklama & Lojistik
                        Notları</label><textarea name="notes" rows="2"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1 outline-none focus:border-blue-500"></textarea>
                </div>

                <div class="md:col-span-3 flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100">
                    <button type="button" onclick="closeModal('orderModal')"
                        class="px-5 py-2.5 border border-slate-200 rounded-lg text-slate-600 hover:bg-slate-50 transition font-medium">İptal</button>
                    <button type="submit"
                        class="px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white font-medium rounded-lg transition shadow-sm">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Modal Diğerleri Kısaltılarak eklendi (Fonksiyonelite eksiksiz) -->
    <div id="shippingModal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[150] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl border border-slate-200">
            <h3 class="text-lg font-medium mb-4 border-b border-slate-100 pb-2">Sevkiyat Planı</h3>
            <form id="formShipping" onsubmit="saveForm(event, 'shipping')"
                class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"><input type="hidden" name="id">
                <div class="md:col-span-2 flex items-center gap-2 bg-amber-50 p-2.5 rounded border border-amber-200">
                    <input type="checkbox" name="isImportant" id="isImportant" class="w-4 h-4"><label for="isImportant"
                        class="font-medium text-amber-700">Önemli/Kritik Sevkiyat!</label>
                </div>
                <div><label class="text-xs text-slate-500">Başlangıç</label><input type="date" name="startDate" required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Bitiş</label><input type="date" name="endDate"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Firma / Müşteri</label><input type="text" name="customer"
                        required class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Ürün</label><input type="text" name="product" required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Toplam Adet</label><input type="number" name="totalQty"
                        id="shpQty" oninput="calcBox()" required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Koli İçi</label><input type="number" name="boxQty"
                        id="shpBox" oninput="calcBox()" required
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div
                    class="md:col-span-2 bg-slate-50 p-2.5 rounded text-center text-sm font-medium text-slate-600 border border-slate-100">
                    Hesaplanan Toplam Koli: <span id="shpRes" class="font-bold">0</span></div>
                <div><label class="text-xs text-slate-500">Çıkış Adresi</label><input type="text" name="fromAddress"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div><label class="text-xs text-slate-500">Varış Adresi</label><input type="text" name="toAddress"
                        class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></div>
                <div class="md:col-span-2"><label class="text-xs text-slate-500">Açıklama / Notlar</label><textarea
                        name="notes" rows="2" class="w-full border border-slate-200 p-2.5 rounded-md mt-1"></textarea>
                </div>
                <div class="md:col-span-2 flex justify-end gap-2 mt-2 pt-4 border-t border-slate-100"><button
                        type="button" onclick="closeModal('shippingModal')"
                        class="px-5 py-2.5 border border-slate-200 rounded-lg text-slate-600">İptal</button><button
                        type="submit" class="px-6 py-2.5 bg-blue-600 text-white font-medium rounded-lg">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Kalan modallar (Biota, Intel, Proposal, Note, Finance) sistemsel olarak hatasız çalışması için dahil ediliyor -->
    <div id="biotaModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <form id="formBiota" onsubmit="saveForm(event, 'biota')" class="space-y-3"><input type="hidden" name="id">
                <div><label class="text-xs text-slate-500">Sipariş No</label><input type="text" name="orderNo" required
                        class="w-full border p-2 rounded"></div>
                <div><label class="text-xs text-slate-500">Malzeme No</label><input type="text" name="materialNo"
                        class="w-full border p-2 rounded"></div>
                <div><label class="text-xs text-slate-500">Açıklama</label><input type="text" name="materialDesc"
                        class="w-full border p-2 rounded"></div>
                <div><label class="text-xs text-slate-500">Tarih</label><input type="date" name="date"
                        class="w-full border p-2 rounded"></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs text-slate-500">Sipariş Adet</label><input type="number" name="qty"
                            required class="w-full border p-2 rounded"></div>
                    <div><label class="text-xs text-emerald-600 font-medium">Yeni Teslimat Ekle</label><input
                            type="number" name="newDelivered" value="0"
                            class="w-full border border-emerald-300 bg-emerald-50 p-2 rounded"></div><input
                        type="hidden" name="deliveredQty" value="0">
                </div>
                <div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal('biotaModal')"
                        class="px-4 py-2 border rounded">İptal</button><button type="submit"
                        class="px-4 py-2 bg-emerald-600 text-white rounded">Kaydet</button></div>
            </form>
        </div>
    </div>
    <div id="intelModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <form id="formIntel" onsubmit="saveForm(event, 'intel')" class="space-y-3"><input type="hidden" name="id">
                <div class="flex gap-2 mb-2"><input type="checkbox" name="isImportant" id="intelImp"><label
                        for="intelImp" class="text-sm font-medium text-red-500">Önemli</label></div>
                <div><select name="category" class="w-full border p-2 rounded">
                        <option>Potansiyel Müşteri</option>
                        <option>Ürün Bilgisi</option>
                        <option>Sektör Dedikodusu</option>
                    </select></div>
                <div><input type="text" name="title" required placeholder="Başlık" class="w-full border p-2 rounded">
                </div>
                <div><input type="date" name="date" id="intelDate" class="w-full border p-2 rounded"></div>
                <div><textarea name="desc" rows="3" placeholder="Detay" class="w-full border p-2 rounded"></textarea>
                </div>
                <div><input type="file" onchange="handleFileConvert(event, 'intelFileData', 'intelFileName')"
                        class="w-full border p-2 rounded text-xs"><input type="hidden" name="fileData"
                        id="intelFileData"><input type="hidden" name="fileName" id="intelFileName"></div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeModal('intelModal')"
                        class="px-4 py-2 border rounded">İptal</button><button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded">Kaydet</button></div>
            </form>
        </div>
    </div>
    <div id="proposalModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <form id="formProposal" onsubmit="saveForm(event, 'proposals')" class="space-y-3"><input type="hidden"
                    name="id"><input type="hidden" name="status" value="Teklif">
                <div><input type="text" name="customer" required placeholder="Firma" class="w-full border p-2 rounded">
                </div>
                <div><input type="text" name="title" required placeholder="Konu" class="w-full border p-2 rounded">
                </div>
                <div><input type="text" name="amount" placeholder="Tutar" class="w-full border p-2 rounded"></div>
                <div><input type="date" name="date" class="w-full border p-2 rounded"></div>
                <div><textarea name="notes" rows="2" placeholder="Notlar" class="w-full border p-2 rounded"></textarea>
                </div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeModal('proposalModal')"
                        class="px-4 py-2 border rounded">İptal</button><button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded">Kaydet</button></div>
            </form>
        </div>
    </div>
    <div id="noteModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <form id="formNote" onsubmit="saveForm(event, 'notes')" class="space-y-3"><input type="hidden"
                    name="id"><input type="hidden" name="date" id="sysDateNote">
                <div><input type="text" name="title" required placeholder="Başlık" class="w-full border p-2 rounded">
                </div>
                <div><textarea name="content" rows="4" placeholder="İçerik"
                        class="w-full border p-2 rounded"></textarea></div>
                <div><input type="file" onchange="handleFileConvert(event, 'noteFileData', 'noteFileName')"
                        class="w-full border p-2 rounded text-xs"><input type="hidden" name="fileData"
                        id="noteFileData"><input type="hidden" name="fileName" id="noteFileName"></div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeModal('noteModal')"
                        class="px-4 py-2 border rounded">İptal</button><button type="submit"
                        class="px-4 py-2 bg-slate-800 text-white rounded">Kaydet</button></div>
            </form>
        </div>
    </div>
    <div id="financeModal" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center p-4 z-[150]">
        <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
            <form id="formFinance" onsubmit="saveFinanceRecord(event)" class="space-y-3"><input type="hidden"
                    name="month" id="finHiddenMonth">
                <div><select id="finType" onchange="updateFinCategories()" class="w-full border p-2 rounded">
                        <option value="gelir">GELİRLER</option>
                        <option value="kk">KREDİ KARTLARI</option>
                        <option value="kredi">KREDİLER</option>
                        <option value="yatirim">YATIRIMLAR</option>
                    </select></div>
                <div id="finCatWrapper"><select id="finCategory" class="w-full border p-2 rounded"></select></div>
                <div id="finInvWrapper" class="hidden space-y-3">
                    <div><input type="text" id="finInvType" placeholder="Tür (Altın vb.)"
                            class="w-full border p-2 rounded"></div>
                    <div><input type="number" step="0.01" id="finInvQty" placeholder="Miktar"
                            class="w-full border p-2 rounded"></div>
                </div>
                <div><input type="number" step="0.01" id="finAmount" required placeholder="Tutar (TL)"
                        class="w-full border p-2 rounded font-bold text-blue-600"></div>
                <div class="flex justify-end gap-2"><button type="button" onclick="closeModal('financeModal')"
                        class="px-4 py-2 border rounded">İptal</button><button type="submit"
                        class="px-4 py-2 bg-slate-800 text-white rounded">Kaydet</button></div>
            </form>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyApndGw-eVvtsVTwtPitHuQkldHsjJ4QTw",
            authDomain: "unison-kam-grkm.firebaseapp.com",
            projectId: "unison-kam-grkm",
            storageBucket: "unison-kam-grkm.firebasestorage.app",
            messagingSenderId: "694763291293",
            appId: "1:694763291293:web:768b0d4b798d93397b8a74"
        };

        // --- GLOBAL STATE ---
        let db, auth;
        let currentUser = null;
        let currentTab = 'home';
        let currentFinMonth = new Date().toISOString().slice(0, 7);
        let selectedItems = { orders: [], shipping: [], biota: [] };
        let activePriceCustomer = null;
        let editedBiotaOrders = [];

        let currentCalDate = new Date();

        let appData = {
            home: { motivationImg: '', motivationText: '', todos: [], shopping: [], shortcuts: [] },
            orders: [], shipping: [], biota: [], intel: [],
            prices: [], proposals: [], notes: [], finance: [], production: [],
            todos: { todos: [], notes: [] }
        };

        const productionMachineList = [
            "Bekum / UN01", "Uniloy-Uc 750 / UN02", "Uniloy-Msa / UN03", "Uniblow-I / UN04",
            "Uniblow-II / UN05", "Aiemme / UN06", "Uniloy-Msc D / UN07", "Uniloy-Msc D III / UN08",
            "Automa / UN09", "Uniloy-Msc D / UN10", "Uniloy-Msc D / UN11", "Uniloy-Msc D-V / UN12",
            "Bekum / UN13", "UN14", "MSB / UN15"
        ];

        // PDF Font (Türkçe Karakter Desteği)
        window.pdfFontBase64 = null;
        async function getPdfFont() {
            if (window.pdfFontBase64) return window.pdfFontBase64;
            const b1 = document.getElementById('btnOrdersPdf'), b2 = document.getElementById('btnShippingPdf');
            if (b1) b1.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Yükleniyor...';
            if (b2) b2.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Yükleniyor...';
            try {
                const res = await fetch('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf');
                const blob = await res.blob();
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        window.pdfFontBase64 = reader.result.split(',')[1];
                        if (b1) b1.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> PDF Çıktı';
                        if (b2) b2.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> PDF Çıktı';
                        resolve(window.pdfFontBase64);
                    };
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                if (b1) b1.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> PDF Çıktı';
                if (b2) b2.innerHTML = '<i class="fas fa-file-pdf mr-1"></i> PDF Çıktı';
                return null;
            }
        }

        // --- INITIALIZATION ---
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            document.getElementById('authError').innerText = "Bağlantı Hatası.";
            document.getElementById('authError').classList.remove('hidden');
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appLayout').classList.remove('hidden');
                document.getElementById('userEmail').innerHTML = `<i class="fas fa-circle text-[8px] mr-1"></i>${user.email.split('@')[0]}`;
                initDataListeners();
                document.getElementById('finMonthPicker').value = currentFinMonth;
                nav('home');
                setInterval(updateClock, 60000); updateClock();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appLayout').classList.add('hidden');
            }
        });

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const eIn = document.getElementById('email').value, pIn = document.getElementById('password').value;
            const err = document.getElementById('authError'); err.classList.add('hidden');
            try { await auth.signInWithEmailAndPassword(eIn, pIn); }
            catch (error) { err.innerText = "Giriş Başarısız: Şifre hatalı."; err.classList.remove('hidden'); }
        });

        // --- DATA SYNC ---
        function initDataListeners() {
            if (!currentUser) return;
            const ref = db.collection('users').doc(currentUser.uid).collection('data');
            const modules = ['home', 'orders', 'shipping', 'biota', 'intel', 'prices', 'proposals', 'notes', 'finance', 'production'];
            modules.forEach(mod => {
                ref.doc(mod).onSnapshot(doc => {
                    if (doc.exists) appData[mod] = doc.data().items || [];
                    refreshUI(mod);
                });
            });
        }

        async function saveData(mod) {
            if (!currentUser) return;
            try { await db.collection('users').doc(currentUser.uid).collection('data').doc(mod).set({ items: appData[mod] }, { merge: true }); }
            catch (e) { console.error(e); }
        }

        // --- ROUTING ---
        function nav(tab) {
            currentTab = tab;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-slate-800', 'text-white'));

            const view = document.getElementById('view-' + tab);
            if (view) view.classList.remove('hidden');

            const btn = document.querySelector(`button[onclick="nav('${tab}')"]`);
            if (btn) btn.classList.add('bg-slate-800', 'text-white');

            const titles = { home: 'Hoşgeldiniz', dashboard: 'Dashboard (Analiz)', orders: 'Siparişler Listesi', shipping: 'Lojistik & Sevkiyat Planı', biota: 'Biota Özel', color: 'Renk Onay', intel: 'İstihbarat', prices: 'Fiyatlar', proposals: 'Teklif & Satış', notes: 'Notlar', finance: 'Finans', production: 'Üretim Takip Çizelgesi' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            refreshUI(tab);
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
        }

        function refreshUI(mod) {
            if (mod === 'home') renderHome();
            if (mod === 'orders' || mod === 'dashboard') { renderOrders(); calcDashboard(); if (currentTab === 'home') renderHomeOverview(); }
            if (mod === 'shipping') renderShipping();
            if (mod === 'biota') renderBiota();
            if (mod === 'intel') renderIntel();
            if (mod === 'prices') renderPriceLists();
            if (mod === 'proposals') renderProposals();
            if (mod === 'notes') renderNotes();
            if (mod === 'finance') renderFinance();
            if (mod === 'production') renderProduction();
        }

        // --- YENİ DASHBOARD HESAPLAMALARI ---
        function calcDashboard() {
            if (!appData.orders) return;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const active = appData.orders.filter(o => o.status !== 'Tamamlandı');
            const completed = appData.orders.filter(o => o.status === 'Tamamlandı');

            let lateCount = 0;
            let totalRemQty = 0;
            let usd = 0, eur = 0, tl = 0;
            let src = { 'Üretim': 0, 'İthal': 0, 'Stok': 0 };

            // Isı haritası ve Aging
            let heat7 = 0, heat15 = 0, heat30 = 0;
            let age10 = 0, age20 = 0, age21 = 0;

            // Diğer analizler
            let custMap = {};
            let unisonStats = {};
            let logisticsList = [];

            active.forEach(o => {
                let p = parseFloat(o.price) || 0;
                let tq = parseInt(o.totalQty) || 0;
                let dq = parseInt(o.deliveredQty) || 0;
                let rem = Math.max(0, tq - dq);

                totalRemQty += rem;

                // Tahsilat hacmi (Sadece kalanın değeri)
                if (o.currency === 'USD') usd += (p * rem);
                else if (o.currency === 'EUR') eur += (p * rem);
                else if (o.currency === 'TL') tl += (p * rem);

                // Kaynak Dağılımı (Sipariş Adedi üzerinden)
                if (o.status && src[o.status] !== undefined) src[o.status]++;

                // Müşteri Dağılımı (Kalan Miktar Üzerinden)
                if (!custMap[o.customer]) custMap[o.customer] = 0;
                custMap[o.customer] += rem;

                // Unison Tamamlanma
                let uCode = o.unisonCode || 'Belirtilmedi';
                if (!unisonStats[uCode]) unisonStats[uCode] = { t: 0, d: 0 };
                unisonStats[uCode].t += tq;
                unisonStats[uCode].d += dq;

                // Tarih bazlı hesaplamalar
                if (o.deadline) {
                    let dDate = new Date(o.deadline);
                    let diffTime = dDate - today;
                    let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        lateCount++;
                        let absLate = Math.abs(diffDays);
                        if (absLate <= 10) age10++;
                        else if (absLate <= 20) age20++;
                        else age21++;
                    } else {
                        if (diffDays <= 7) heat7++;
                        else if (diffDays <= 15) heat15++;
                        else if (diffDays <= 30) heat30++;
                    }
                }

                // Lojistik hazırlık (Teslimat başlamış veya kalan çok az)
                if (dq > 0 || (rem > 0 && rem <= 50)) {
                    logisticsList.push(o);
                }
            });

            // DOM Updates (Row 1)
            document.getElementById('dash-active').innerText = active.length;
            document.getElementById('dash-late').innerText = lateCount;
            document.getElementById('dash-rem-qty').innerText = totalRemQty.toLocaleString('tr-TR');
            document.getElementById('dash-usd').innerText = usd.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' $';
            document.getElementById('dash-eur').innerText = eur.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' €';

            // DOM Updates (Row 2)
            let otif = active.length > 0 ? (((active.length - lateCount) / active.length) * 100).toFixed(0) : 0;
            document.getElementById('dash-otif').innerText = '%' + otif;
            document.getElementById('dash-src-prod').innerText = src['Üretim'];
            document.getElementById('dash-src-imp').innerText = src['İthal'];
            document.getElementById('dash-src-stk').innerText = src['Stok'];

            // DOM Updates (Row 3 - Heat & Age & Col)
            document.getElementById('dash-heat-7').innerText = heat7;
            document.getElementById('dash-heat-15').innerText = heat15;
            document.getElementById('dash-heat-30').innerText = heat30;

            document.getElementById('dash-age-10').innerText = age10;
            document.getElementById('dash-age-20').innerText = age20;
            document.getElementById('dash-age-21').innerText = age21;

            document.getElementById('dash-col-usd').innerText = usd.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' $';
            document.getElementById('dash-col-eur').innerText = eur.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' €';
            document.getElementById('dash-col-tl').innerText = tl.toLocaleString('tr-TR', { maximumFractionDigits: 0 }) + ' ₺';

            // DOM Updates (Row 4 - Customers)
            let sortedCust = Object.keys(custMap).map(k => ({ name: k, val: custMap[k] })).sort((a, b) => b.val - a.val).slice(0, 5);
            let maxC = sortedCust.length > 0 ? sortedCust[0].val : 1;
            document.getElementById('dash-top-customers').innerHTML = sortedCust.length ? sortedCust.map(c => {
                let w = (c.val / maxC) * 100;
                return `<div class="mb-2">
                    <div class="flex justify-between text-[11px] font-medium text-slate-700 mb-0.5"><span class="truncate pr-2">${c.name}</span><span>${c.val.toLocaleString('tr-TR')} Ad.</span></div>
                    <div class="progress-bar"><div class="progress-fill bg-blue-500" style="width:${w}%"></div></div>
                </div>`;
            }).join('') : '<p class="text-xs text-slate-400">Veri yok</p>';

            // DOM Updates (Row 4 - Unison)
            let sortedU = Object.keys(unisonStats).map(k => {
                let p = unisonStats[k].t > 0 ? (unisonStats[k].d / unisonStats[k].t) * 100 : 0;
                return { name: k, perc: p.toFixed(0), t: unisonStats[k].t, d: unisonStats[k].d };
            }).sort((a, b) => b.t - a.t).slice(0, 6); // En çok sipariş edilen 6 ürün

            document.getElementById('dash-unison-progress').innerHTML = sortedU.length ? sortedU.map(u => {
                let color = u.perc >= 100 ? 'bg-emerald-500' : (u.perc > 50 ? 'bg-indigo-500' : 'bg-amber-500');
                return `<div class="mb-2 bg-slate-50 dark:bg-slate-800 p-2 rounded border border-slate-100 dark:border-slate-700">
                    <div class="flex justify-between text-[10px] font-medium mb-1"><span class="truncate" title="${u.name}">${u.name}</span><span>%${u.perc}</span></div>
                    <div class="progress-bar bg-white dark:bg-slate-900"><div class="progress-fill ${color}" style="width:${Math.min(u.perc, 100)}%"></div></div>
                    <div class="text-[9px] text-slate-400 text-right mt-1">${u.d} / ${u.t}</div>
                </div>`;
            }).join('') : '<p class="text-xs text-slate-400">Veri yok</p>';

            // DOM Updates (Row 5 - Logistics)
            document.getElementById('dash-logistics').innerHTML = logisticsList.length ? logisticsList.slice(0, 5).map(o => {
                let rem = (parseInt(o.totalQty) || 0) - (parseInt(o.deliveredQty) || 0);
                return `<tr class="hover:bg-slate-50 transition">
                    <td class="py-2 text-blue-600 font-mono font-medium">${o.orderNo}</td>
                    <td class="py-2 truncate max-w-[150px]" title="${o.customer}">${o.customer}</td>
                    <td class="py-2"><span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded text-[10px]">${o.deliveredQty} / ${o.totalQty}</span></td>
                    <td class="py-2 font-medium ${rem <= 0 ? 'text-emerald-500' : 'text-amber-600'}">${rem <= 0 ? 'Hazır/Bitti' : rem}</td>
                </tr>`;
            }).join('') : '<tr><td colspan="4" class="py-3 text-xs text-slate-400 text-center">Sevkiyata hazırlanan kısmi teslimat yok.</td></tr>';
        }

        // --- FORMS & MODALS ---
        function saveForm(e, mod) {
            e.preventDefault();
            const fd = new FormData(e.target);
            const obj = Object.fromEntries(fd.entries());
            if (!obj.id) obj.id = Date.now().toString();

            if (mod === 'biota' && obj.newDelivered) {
                let addDelv = parseInt(obj.newDelivered) || 0;
                let existDelv = parseInt(obj.deliveredQty) || 0;
                obj.deliveredQty = (existDelv + addDelv).toString();
                delete obj.newDelivered;
                if (addDelv > 0 && !editedBiotaOrders.includes(obj.orderNo)) editedBiotaOrders.push(obj.orderNo);
            }

            const idx = appData[mod].findIndex(x => x.id === obj.id);
            if (idx > -1) appData[mod][idx] = obj; else appData[mod].push(obj);

            saveData(mod);
            closeModal(e.target.closest('.fixed').id);
        }

        function openModal(id, dataId = null, mod = null) {
            const modal = document.getElementById(id);
            const form = modal.querySelector('form');
            form.reset();
            if (id === 'financeModal') updateFinCategories();

            const hdnFields = form.querySelectorAll('input[type="hidden"]');
            hdnFields.forEach(f => { if (f.name === 'fileData' || f.name === 'fileName') f.value = ''; });

            if (dataId && mod) {
                const item = appData[mod].find(x => x.id === dataId);
                if (item) Object.keys(item).forEach(k => { if (form.elements[k]) form.elements[k].value = item[k]; });
            } else {
                if (form.elements['id']) form.elements['id'].value = '';
                if (id === 'intelModal') document.getElementById('intelDate').valueAsDate = new Date();
                if (id === 'noteModal') document.getElementById('sysDateNote').value = new Date().toLocaleDateString('tr-TR');
            }
            modal.classList.remove('hidden'); modal.classList.add('flex');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex');
        }

        function toggleSelectAll(mod, isChecked) {
            const cbs = document.querySelectorAll(`.cb-${mod}`);
            selectedItems[mod] = [];
            cbs.forEach(cb => { cb.checked = isChecked; if (isChecked) selectedItems[mod].push(cb.value); });
        }
        function toggleSelect(mod, id, isChecked) {
            if (isChecked) selectedItems[mod].push(id);
            else selectedItems[mod] = selectedItems[mod].filter(x => x !== id);
        }
        function deleteSelected(mod) {
            if (selectedItems[mod].length === 0) return alert('Kayıt seçmediniz.');
            if (confirm('Seçili kayıtları silmek istediğinize emin misiniz?')) {
                appData[mod] = appData[mod].filter(x => !selectedItems[mod].includes(x.id));
                selectedItems[mod] = [];
                saveData(mod);
            }
        }

        // --- SİPARİŞLER RENDER (GRID KART GÖRÜNÜMÜ) ---
        function renderOrders() {
            const grid = document.getElementById('gridOrders');
            if (!grid) return;
            const search = (document.getElementById('searchOrders')?.value || '').toLowerCase();
            const filter = document.getElementById('filterOrders')?.value || 'active';

            let list = appData.orders.filter(o => (o.customer?.toLowerCase().includes(search) || o.orderNo?.toLowerCase().includes(search)));
            if (filter === 'active') list = list.filter(o => o.status !== 'Tamamlandı');
            if (filter === 'completed') list = list.filter(o => o.status === 'Tamamlandı');

            // Sort orders by Termin Tarihi (deadline) nearest first
            list.sort((a, b) => {
                const da = a.deadline ? new Date(a.deadline) : new Date(8640000000000000); // Max date if no deadline
                const db = b.deadline ? new Date(b.deadline) : new Date(8640000000000000);
                return da - db;
            });

            document.getElementById('orderCountText').innerText = `Toplam ${list.length} sipariş listeleniyor.`;

            grid.innerHTML = list.map(o => {
                const total = parseInt(o.totalQty) || 0;
                const delv = parseInt(o.deliveredQty) || 0;
                const remain = Math.max(0, total - delv);
                const isLate = new Date(o.deadline) < new Date() && o.status !== 'Tamamlandı';
                const progress = total > 0 ? Math.min(100, Math.round((delv / total) * 100)) : 0;
                const isCompleted = o.status === 'Tamamlandı';

                const statusColors = {
                    'Üretim': 'bg-blue-100 text-blue-700 border-blue-200',
                    'İthal': 'bg-purple-100 text-purple-700 border-purple-200',
                    'Stok': 'bg-amber-100 text-amber-700 border-amber-200',
                    'Tamamlandı': 'bg-emerald-100 text-emerald-700 border-emerald-200'
                };
                const statusClass = statusColors[o.status] || 'bg-slate-100 text-slate-600 border-slate-200';
                const borderColor = isLate ? 'border-red-400' : (isCompleted ? 'border-emerald-400' : 'border-blue-400');

                return `
                <div class="glass rounded-xl p-0 overflow-hidden border-l-4 ${borderColor} hover:shadow-lg transition-all duration-200 group relative" style="overflow-wrap:break-word; word-break:break-word;">
                    <!-- Kart Üst Kısım: Sipariş No + Müşteri -->
                    <div class="p-4 pb-3 border-b border-slate-100 dark:border-slate-700 bg-gradient-to-r from-slate-50/80 to-white dark:from-slate-800/50 dark:to-slate-900/50">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1 min-w-0 overflow-hidden">
                                <div class="flex items-center gap-2 mb-1 min-w-0">
                                    <input type="checkbox" class="cb-orders rounded border-slate-300 shrink-0" value="${o.id}" onchange="toggleSelect('orders', '${o.id}', this.checked)">
                                    <span class="font-mono font-bold text-slate-800 dark:text-slate-200 text-sm truncate">${o.orderNo}</span>
                                    ${isLate ? '<i class="fas fa-exclamation-triangle text-red-500 text-xs animate-pulse shrink-0"></i>' : ''}
                                </div>
                                <h4 class="font-semibold text-blue-600 dark:text-blue-400 text-base truncate" title="${o.customer}">${o.customer}</h4>
                            </div>
                            <div class="flex items-center gap-1 shrink-0 no-print">
                                <button onclick="openModal('orderModal', '${o.id}', 'orders')" class="text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-2 rounded-lg transition"><i class="fas fa-pen text-xs"></i></button>
                            </div>
                        </div>
                        <span class="inline-block px-2.5 py-0.5 rounded-full text-[10px] uppercase font-bold tracking-wide ${statusClass} border mt-2">${o.status}</span>
                    </div>

                    <!-- Kart Orta: Detay Grid -->
                    <div class="p-4 space-y-3 text-sm">
                        <!-- Ürün Bilgileri -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block">Ürün Kodu</span>
                                <span class="text-slate-700 dark:text-slate-300 font-medium block truncate" title="${o.productCode || '-'}">${o.productCode || '-'}</span>
                            </div>
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block">Unison Kod</span>
                                <span class="text-slate-700 dark:text-slate-300 font-medium block truncate" title="${o.unisonCode || '-'}">${o.unisonCode || '-'}</span>
                            </div>
                        </div>

                        <!-- Miktar + İlerleme -->
                        <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <span class="text-[10px] text-slate-400 uppercase font-semibold">Toplam</span>
                                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">${total.toLocaleString('tr-TR')}</p>
                                </div>
                                <div class="text-center">
                                    <span class="text-[10px] text-slate-400 uppercase font-semibold">Teslim</span>
                                    <p class="text-lg font-bold text-emerald-600">${delv.toLocaleString('tr-TR')}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-[10px] text-slate-400 uppercase font-semibold">Kalan</span>
                                    <p class="text-lg font-bold ${remain > 0 ? 'text-orange-500' : 'text-emerald-500'}">${remain.toLocaleString('tr-TR')}</p>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill ${progress >= 100 ? 'bg-emerald-500' : (progress > 50 ? 'bg-blue-500' : 'bg-amber-500')}" style="width:${progress}%"></div>
                            </div>
                            <div class="text-right text-[10px] text-slate-400 mt-1">%${progress} tamamlandı</div>
                        </div>

                        <!-- Fiyat + Koli -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block">Birim Fiyat</span>
                                <span class="font-mono font-medium text-slate-700 dark:text-slate-300 block truncate">${o.price || '-'} ${o.currency || ''}</span>
                            </div>
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block">Koli İçi Adet</span>
                                <span class="text-slate-700 dark:text-slate-300 block">${o.boxQty || '-'}</span>
                            </div>
                        </div>

                        <!-- Termin -->
                        <div class="flex items-center gap-2 ${isLate ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800' : 'bg-slate-50 dark:bg-slate-800/50'} rounded-lg px-3 py-2">
                            <i class="fas fa-calendar-alt ${isLate ? 'text-red-500' : 'text-slate-400'} shrink-0"></i>
                            <div class="min-w-0 flex flex-col w-full">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block">Termin Tarihi</span>
                                <div class="flex items-center justify-between">
                                    <span class="font-medium ${isLate ? 'text-red-600 dark:text-red-400' : 'text-slate-700 dark:text-slate-300'}">${o.deadline || '-'}</span>
                                    ${isLate ? '<span class="text-[10px] text-red-500 font-bold ml-2">GECİKMİŞ!</span>' : ''}
                                    ${o.orderDate ? `<span class="text-[9px] text-slate-400 ml-auto whitespace-nowrap">Sipariş: ${o.orderDate}</span>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Nakliye + Konum -->
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block"><i class="fas fa-truck text-slate-300 mr-1"></i>Nakliye</span>
                                <span class="text-slate-700 dark:text-slate-300 block truncate" title="${o.transport || '-'}">${o.transport || '-'}</span>
                            </div>
                            <div class="min-w-0 overflow-hidden">
                                <span class="text-[10px] text-slate-400 uppercase font-semibold block"><i class="fas fa-map-marker-alt text-slate-300 mr-1"></i>Konum</span>
                                <span class="text-slate-700 dark:text-slate-300 block truncate" title="${o.location || '-'}">${o.location || '-'}</span>
                            </div>
                        </div>

                        <!-- Notlar -->
                        ${o.notes ? `<div class="border-t border-slate-100 dark:border-slate-700 pt-3">
                            <span class="text-[10px] text-slate-400 uppercase font-semibold block mb-1"><i class="fas fa-sticky-note text-slate-300 mr-1"></i>Açıklama / Lojistik Notları</span>
                            <p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed break-words">${o.notes}</p>
                        </div>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        async function exportOrdersPDF() {
            const fontB64 = await getPdfFont();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const fontName = fontB64 ? 'Roboto' : 'helvetica';

            if (fontB64) {
                doc.addFileToVFS('Roboto-Regular.ttf', fontB64);
                doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            }

            // Header
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 297, 28, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('Sipariş Listesi', 14, 12);
            doc.setFontSize(8);
            doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}`, 14, 19);
            doc.setFontSize(8);
            doc.text('Unison Dış Ticaret A.Ş.', 297 - 14, 12, { align: 'right' });
            doc.setTextColor(0, 0, 0);

            const head = [['Sipariş No', 'Müşteri / Firma', 'Ürün Kodu\nUnison Kod', 'Toplam\nAdet', 'Teslim', 'Kalan', 'Birim Fiyat', 'Durum', 'Termin\nTarihi', 'Nakliye', 'Notlar']];

            let exp = appData.orders;
            if (document.getElementById('filterOrders')?.value === 'active') exp = exp.filter(o => o.status !== 'Tamamlandı');
            if (selectedItems.orders.length > 0) exp = exp.filter(x => selectedItems.orders.includes(x.id));

            const body = exp.map(o => {
                const total = parseInt(o.totalQty) || 0;
                const delv = parseInt(o.deliveredQty) || 0;
                const rem = Math.max(0, total - delv);
                return [
                    o.orderNo || '-',
                    o.customer || '-',
                    `${o.productCode || '-'}\n${o.unisonCode || ''}`,
                    total.toLocaleString('tr-TR'),
                    delv.toLocaleString('tr-TR'),
                    rem.toLocaleString('tr-TR'),
                    `${o.price || '-'} ${o.currency || ''}`,
                    o.status || '-',
                    o.deadline || '-',
                    o.transport || '-',
                    o.notes || ''
                ];
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 32,
                theme: 'grid',
                styles: {
                    font: fontName,
                    fontSize: 7,
                    cellPadding: { top: 2.5, right: 2, bottom: 2.5, left: 2 },
                    overflow: 'linebreak',
                    lineColor: [203, 213, 225],
                    lineWidth: 0.2,
                    textColor: [30, 41, 59],
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: { top: 3, right: 2, bottom: 3, left: 2 }
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                columnStyles: {
                    0: { cellWidth: 22, halign: 'center' },
                    1: { cellWidth: 32 },
                    2: { cellWidth: 28 },
                    3: { cellWidth: 16, halign: 'center' },
                    4: { cellWidth: 16, halign: 'center' },
                    5: { cellWidth: 16, halign: 'center' },
                    6: { cellWidth: 22, halign: 'right' },
                    7: { cellWidth: 18, halign: 'center' },
                    8: { cellWidth: 20, halign: 'center' },
                    9: { cellWidth: 22 },
                    10: { cellWidth: 'auto' }
                },
                didParseCell: function (data) {
                    // Highlight overdue dates in red
                    if (data.section === 'body' && data.column.index === 8) {
                        const deadline = data.cell.raw;
                        if (deadline && deadline !== '-' && new Date(deadline) < new Date()) {
                            data.cell.styles.textColor = [220, 38, 38];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                    // Highlight "Kalan" column if > 0
                    if (data.section === 'body' && data.column.index === 5) {
                        const val = parseInt(data.cell.raw?.toString().replace(/\./g, '')) || 0;
                        if (val > 0) {
                            data.cell.styles.textColor = [234, 88, 12];
                            data.cell.styles.fontStyle = 'bold';
                        } else {
                            data.cell.styles.textColor = [16, 185, 129];
                        }
                    }
                },
                margin: { left: 8, right: 8 }
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text(`Sayfa ${i} / ${pageCount}`, 297 - 14, 200, { align: 'right' });
                doc.text('GorkAPP - Sipariş Yönetim Sistemi', 14, 200);
            }

            doc.save(`Siparis_Listesi_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // --- SEVKİYAT RENDER (CLEAN UI & TEXT WRAPPING) ---
        function calcBox() {
            const q = parseInt(document.getElementById('shpQty').value) || 0, b = parseInt(document.getElementById('shpBox').value) || 1;
            document.getElementById('shpRes').innerText = Math.ceil(q / b);
        }

        function renderShipping() {
            const tb = document.getElementById('tbodyShipping');
            if (!tb) return;
            const s = (document.getElementById('searchShipping')?.value || '').toLowerCase();

            tb.innerHTML = appData.shipping.filter(x => x.customer?.toLowerCase().includes(s) || x.toAddress?.toLowerCase().includes(s) || x.product?.toLowerCase().includes(s)).map(x => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition ${x.isImportant ? 'bg-amber-50/30' : ''}">
                    <td class="p-3 align-top border-b border-slate-100 w-10"><input type="checkbox" class="cb-shipping rounded border-slate-300" value="${x.id}" onchange="toggleSelect('shipping', '${x.id}', this.checked)"></td>
                    <td class="p-3 align-top border-b border-slate-100 w-8">${x.isImportant ? '<i class="fas fa-exclamation-triangle text-amber-500"></i>' : ''}</td>
                    <td class="p-3 align-top border-b border-slate-100 text-[12px] whitespace-nowrap"><span class="text-slate-400">Baş:</span> ${x.startDate} <br> <span class="text-slate-400">Bit:</span> ${x.endDate || '-'}</td>
                    <td class="p-3 align-top border-b border-slate-100 font-medium text-blue-600 dark:text-blue-400 min-w-[150px] whitespace-normal break-words">${x.customer}</td>
                    <td class="p-3 align-top border-b border-slate-100 text-[13px] min-w-[150px] whitespace-normal break-words">${x.product}</td>
                    <td class="p-3 align-top border-b border-slate-100 font-mono text-[13px] whitespace-nowrap">${x.totalQty}<br><span class="text-[10px] text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded">${Math.ceil(x.totalQty / (x.boxQty || 1))} Koli</span></td>
                    <td class="p-3 align-top border-b border-slate-100 text-[12px] min-w-[220px] whitespace-normal break-words">
                        <div class="mb-1 text-slate-500"><i class="fas fa-arrow-up text-orange-400 mr-1 opacity-70"></i>${x.fromAddress || '-'}</div>
                        <div class="text-slate-800 font-medium"><i class="fas fa-map-marker-alt text-emerald-500 mr-1 opacity-70"></i>${x.toAddress || '-'}</div>
                    </td>
                    <td class="p-3 align-top border-b border-slate-100 text-[12px] min-w-[180px] whitespace-normal break-words text-slate-500">${x.notes || '-'}</td>
                    <td class="p-3 align-top border-b border-slate-100 text-center w-14">
                        <button onclick="openModal('shippingModal', '${x.id}', 'shipping')" class="text-slate-400 hover:text-blue-500 hover:bg-blue-50 p-1.5 rounded transition"><i class="fas fa-pen"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function exportShippingPDF() {
            const fontB64 = await getPdfFont();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const fontName = fontB64 ? 'Roboto' : 'helvetica';

            if (fontB64) {
                doc.addFileToVFS('Roboto-Regular.ttf', fontB64);
                doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            }

            // Header
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 297, 28, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('Sevkiyat Planı', 14, 12);
            doc.setFontSize(8);
            doc.text(`Tarih: ${new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}`, 14, 19);
            doc.text('Unison Dış Ticaret A.Ş.', 297 - 14, 12, { align: 'right' });
            doc.setTextColor(0, 0, 0);

            const head = [['Önem', 'Başlangıç\nTarihi', 'Bitiş\nTarihi', 'Firma / Müşteri', 'Ürün İçeriği', 'Toplam\nAdet', 'Koli\nSayısı', 'Çıkış Adresi', 'Varış Adresi', 'Açıklama / Notlar']];

            let exp = appData.shipping;
            if (selectedItems.shipping.length > 0) exp = exp.filter(x => selectedItems.shipping.includes(x.id));

            const body = exp.map(x => [
                x.isImportant ? '⚠ Kritik' : '-',
                x.startDate || '-',
                x.endDate || '-',
                x.customer || '-',
                x.product || '-',
                x.totalQty || '-',
                Math.ceil((parseInt(x.totalQty) || 0) / (parseInt(x.boxQty) || 1)).toString(),
                x.fromAddress || '-',
                x.toAddress || '-',
                x.notes || ''
            ]);

            doc.autoTable({
                head: head,
                body: body,
                startY: 32,
                theme: 'grid',
                styles: {
                    font: fontName,
                    fontSize: 7,
                    cellPadding: { top: 2.5, right: 2, bottom: 2.5, left: 2 },
                    overflow: 'linebreak',
                    lineColor: [203, 213, 225],
                    lineWidth: 0.2,
                    textColor: [30, 41, 59],
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: { top: 3, right: 2, bottom: 3, left: 2 }
                },
                alternateRowStyles: {
                    fillColor: [248, 250, 252]
                },
                columnStyles: {
                    0: { cellWidth: 16, halign: 'center' },
                    1: { cellWidth: 22, halign: 'center' },
                    2: { cellWidth: 22, halign: 'center' },
                    3: { cellWidth: 32 },
                    4: { cellWidth: 35 },
                    5: { cellWidth: 16, halign: 'center' },
                    6: { cellWidth: 16, halign: 'center' },
                    7: { cellWidth: 38 },
                    8: { cellWidth: 40 },
                    9: { cellWidth: 'auto' }
                },
                didParseCell: function (data) {
                    // Highlight critical shipments
                    if (data.section === 'body' && data.column.index === 0) {
                        if (data.cell.raw && data.cell.raw.includes('Kritik')) {
                            data.cell.styles.textColor = [220, 38, 38];
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [254, 242, 242];
                        }
                    }
                },
                margin: { left: 8, right: 8 }
            });

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text(`Sayfa ${i} / ${pageCount}`, 297 - 14, 200, { align: 'right' });
                doc.text('GorkAPP - Sevkiyat Yönetim Sistemi', 14, 200);
            }

            doc.save(`Sevkiyat_Plani_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // Kalan yardımcı ve modül fonksiyonları
        function exportExcel(f, d) { if (d.length === 0) return; const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(d), f); XLSX.writeFile(wb, `${f}_${new Date().toISOString().slice(0, 10)}.xlsx`); }

        function importBiotaExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (json.length <= 1) {
                        alert("Excel dosyasında veri bulunamadı veya sadece başlık var.");
                        e.target.value = '';
                        return;
                    }

                    let count = 0;
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        if (!row || row.length === 0 || (!row[0] && !row[1] && !row[2])) continue;

                        const newItem = {
                            id: Date.now().toString() + Math.random().toString(36).substring(7),
                            orderNo: row[0] ? row[0].toString() : '',
                            materialNo: row[1] ? row[1].toString() : '',
                            materialDesc: row[2] ? row[2].toString() : '',
                            date: row[3] ? row[3].toString() : '',
                            qty: row[4] ? row[4].toString() : '0',
                            deliveredQty: '0'
                        };

                        appData.biota.push(newItem);
                        count++;
                    }

                    if (count > 0) {
                        saveData('biota');
                        renderBiota();
                        alert(`${count} sipariş başarıyla eklendi!`);
                    }

                } catch (error) {
                    console.error("Excel ayrıştırma hatası:", error);
                    alert("Dosya işlenirken bir hata oluştu. Excel formatının doğruluğunu kontrol edin.");
                }
            };
            e.target.value = '';
        }

        function importOrdersExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (json.length <= 1) {
                        alert("Excel dosyasında veri bulunamadı veya sadece başlık var.");
                        e.target.value = '';
                        return;
                    }

                    let count = 0;
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        if (!row || row.length === 0 || (!row[0] && !row[1] && !row[2])) continue;

                        const newItem = {
                            id: Date.now().toString() + Math.random().toString(36).substring(7),
                            customer: row[0] ? row[0].toString() : '',
                            orderNo: row[1] ? row[1].toString() : '',
                            productCode: row[2] ? row[2].toString() : '',
                            totalQty: row[3] ? row[3].toString() : '0',
                            deadline: row[4] ? row[4].toString() : '',
                            orderDate: row[5] ? row[5].toString() : '',
                            deliveredQty: '0',
                            status: 'Üretim',
                            price: '',
                            currency: 'USD',
                            boxQty: '',
                            unisonCode: '',
                            transport: '',
                            location: '',
                            notes: 'Excel\'den aktarıldı.'
                        };

                        appData.orders.push(newItem);
                        count++;
                    }

                    if (count > 0) {
                        saveData('orders');
                        renderOrders();
                        alert(`${count} sipariş başarıyla eklendi! Varsayılan sütun yapısı: Müşteri | Sipariş No | Ürün Kodu | Toplam Adet | Termin Tarihi | Sipariş Tarihi`);
                    }

                } catch (error) {
                    console.error("Excel ayrıştırma hatası:", error);
                    alert("Dosya işlenirken bir hata oluştu. Excel formatının doğruluğunu kontrol edin.");
                }
            };
            reader.readAsArrayBuffer(file);
        }
        function previewImage(e, id, phId) { const r = new FileReader(); r.onload = function () { const el = document.getElementById(id); el.src = r.result; el.classList.remove('hidden'); document.getElementById(phId).classList.add('hidden'); }; if (e.target.files[0]) r.readAsDataURL(e.target.files[0]); }
        function handleFileConvert(e, dId, nId) { const f = e.target.files[0]; if (!f) return; if (f.size > 2 * 1024 * 1024) return alert("Maks 2MB!"); const r = new FileReader(); r.onload = (ev) => { document.getElementById(dId).value = ev.target.result; document.getElementById(nId).value = f.name; }; r.readAsDataURL(f); }
        function updateClock() { const d = new Date(); document.getElementById('topTime').innerText = d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }); document.getElementById('topDate').innerText = d.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }

        // Diğer modüllerin (Biota, Fiyat Listesi, Finans) standart render metodları
        function renderBiota() { const tb = document.getElementById('tbodyBiota'); if (!tb) return; tb.innerHTML = appData.biota.map(x => { const t = parseInt(x.qty) || 0, d = parseInt(x.deliveredQty) || 0, r = t - d; return `<tr><td class="p-3"><input type="checkbox" class="cb-biota" value="${x.id}" onchange="toggleSelect('biota', '${x.id}', this.checked)"></td><td class="p-3">${x.orderNo}</td><td class="p-3">${x.materialNo}</td><td class="p-3 text-xs">${x.materialDesc}</td><td class="p-3">${x.date}</td><td class="p-3">${t}</td><td class="p-3 ${r <= 0 ? 'text-emerald-500' : 'text-amber-500'}">${r <= 0 ? 'Bitti' : r}</td><td class="p-3"><button onclick="openModal('biotaModal', '${x.id}', 'biota')" class="text-blue-500"><i class="fas fa-edit"></i></button></td></tr>` }).join(''); }
        function copyBiotaMail() { if (editedBiotaOrders.length === 0) return; const t = `Merhaba,\nDüzenlenen sipariş numaraları; ${editedBiotaOrders.join(', ')} teşekkürler.`; navigator.clipboard.writeText(t).then(() => { alert("Kopyalandı"); editedBiotaOrders = []; }).catch(() => { alert("Kopyalanamadı."); }); }
        function renderIntel() { document.getElementById('gridIntel').innerHTML = appData.intel.sort((a, b) => new Date(b.date) - new Date(a.date)).map(x => `<div class="glass p-4 relative group"><div class="text-[10px] text-blue-500 font-bold">${x.category}</div><h4 class="font-medium">${x.title}</h4><p class="text-[10px] text-slate-400 mb-2">${x.date || ''}</p><p class="text-sm text-slate-600 line-clamp-3">${x.desc}</p><div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100"><button onclick="openModal('intelModal','${x.id}','intel')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="delItem('intel','${x.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
        function renderPriceLists() { const c = appData.prices.find(x => x.id === activePriceCustomer); document.getElementById('listPriceCustomers').innerHTML = appData.prices.map(x => `<li onclick="activePriceCustomer='${x.id}';renderPriceLists()" class="p-3 cursor-pointer border-b border-slate-100 hover:bg-slate-50 ${activePriceCustomer === x.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''}"><div class="text-sm font-medium">${x.name}</div></li>`).join(''); if (c) { document.getElementById('selectedPriceCustomerName').innerText = c.name; document.getElementById('btnAddPriceProd').classList.remove('hidden'); document.getElementById('tbodyPriceProducts').innerHTML = (c.products || []).map(p => `<tr><td class="p-3 text-sm">${p.unisonName}</td><td class="p-3 text-sm">${p.custName}</td><td class="p-3 text-sm font-mono">${p.price}</td><td class="p-3 text-xs">${p.validity}</td><td class="p-3"><button onclick="delItem('prices','${p.id}')" class="text-red-400"><i class="fas fa-times"></i></button></td></tr>`).join(''); } }
        function addPriceCustomer() { const n = prompt("Müşteri Adı:"); if (n) { appData.prices.push({ id: Date.now().toString(), name: n, products: [] }); saveData('prices'); renderPriceLists(); } }
        function addPriceProduct() { if (!activePriceCustomer) return; const c = appData.prices.find(x => x.id === activePriceCustomer); const u = prompt("Unison Adı:"), m = prompt("Müşteri Adı:"), f = prompt("Fiyat:"), v = prompt("Geçerlilik:"); if (u) { if (!c.products) c.products = []; c.products.push({ id: Date.now().toString(), unisonName: u, custName: m, price: f, validity: v }); saveData('prices'); renderPriceLists(); } }
        function renderProposals() { ['Teklif', 'Takip', 'Sonuç', 'Tamamlandı'].forEach(st => { document.getElementById('cnt-' + st).innerText = appData.proposals.filter(p => p.status === st).length; document.getElementById('kb-' + st).innerHTML = appData.proposals.filter(p => p.status === st).map(p => `<div id="prop-${p.id}" draggable="true" ondragstart="event.dataTransfer.setData('text','${p.id}')" class="kanban-item relative group"><div class="text-sm font-medium">${p.customer}</div><div class="text-xs text-slate-500">${p.title}</div><div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100"><button onclick="openModal('proposalModal', '${p.id}', 'proposals')" class="text-blue-500 hover:text-blue-600"><i class="fas fa-edit"></i></button><button onclick="delItem('proposals','${p.id}')" class="text-red-400 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>`).join(''); }); }
        function allowDrop(ev) { ev.preventDefault(); } function dropProp(ev, st) { ev.preventDefault(); const item = appData.proposals.find(p => p.id === ev.dataTransfer.getData("text")); if (item) { item.status = st; saveData('proposals'); renderProposals(); } }
        function renderNotes() { document.getElementById('gridNotes').innerHTML = appData.notes.map(n => `<div class="glass p-4 relative group border-t-4 border-slate-800"><div class="text-[10px] text-slate-400">${n.date || ''}</div><h4 class="font-medium text-sm">${n.title}</h4><p class="text-xs text-slate-600 mt-1">${n.content}</p><div class="absolute bottom-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100"><button onclick="openModal('noteModal','${n.id}','notes')" class="text-blue-500"><i class="fas fa-edit"></i></button><button onclick="delItem('notes','${n.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></div>`).join(''); }
        function updateFinCategories() { const t = document.getElementById('finType').value, c = document.getElementById('finCategory'); c.innerHTML = ''; if (t === 'gelir') ['Maaş', 'Yemek', 'Ek', 'Diğer'].forEach(x => c.innerHTML += `<option>${x}</option>`); else if (t === 'kk') ['Akbank', 'Yapı Kredi', 'Garanti', 'Diğer'].forEach(x => c.innerHTML += `<option>${x}</option>`); else if (t === 'kredi') ['Akbank Kredi', 'Nurçehre', 'Diğer'].forEach(x => c.innerHTML += `<option>${x}</option>`); document.getElementById('finCatWrapper').style.display = t === 'yatirim' ? 'none' : 'block'; document.getElementById('finInvWrapper').style.display = t === 'yatirim' ? 'block' : 'none'; }
        function saveFinanceRecord(e) { e.preventDefault(); const t = document.getElementById('finType').value, c = document.getElementById('finCategory').value, a = document.getElementById('finAmount').value; let n = c; if (t === 'yatirim') { n = `${document.getElementById('finInvType').value} (${document.getElementById('finInvQty').value})`; } appData.finance.push({ id: Date.now().toString(), month: currentFinMonth, type: t, name: n, amount: a }); saveData('finance'); closeModal('financeModal'); }
        function renderFinance() { const r = appData.finance.filter(x => x.month === currentFinMonth); let g = 0, k = 0, kr = 0, y = 0;['gelir', 'kk', 'kredi', 'yatirim'].forEach(t => { const l = r.filter(x => x.type === t); document.getElementById('fin-list-' + t).innerHTML = l.map(i => `<div class="flex justify-between p-2 border-b border-slate-100 text-sm"><span>${i.name}</span><span class="font-mono">${i.amount} ₺ <i onclick="delItem('finance','${i.id}')" class="fas fa-times text-red-400 cursor-pointer ml-2"></i></span></div>`).join(''); let tot = l.reduce((s, i) => s + parseFloat(i.amount), 0); if (t === 'gelir') g = tot; if (t === 'kk') k = tot; if (t === 'kredi') kr = tot; if (t === 'yatirim') y = tot; }); document.getElementById('fin-tot-gelir').innerText = g + ' ₺'; document.getElementById('fin-tot-gider').innerText = (k + kr) + ' ₺'; document.getElementById('fin-tot-yatirim').innerText = y + ' ₺'; }
        function changeFinMonth(m) { currentFinMonth = m; renderFinance(); }
        function delItem(m, id) { if (confirm('Sil?')) { appData[m] = appData[m].filter(x => x.id !== id); saveData(m); } }

        // --- ÜRETİM TAKİP ---
        function renderProduction() {
            const tb = document.getElementById('tbodyProduction');
            if (!tb) return;
            tb.innerHTML = productionMachineList.map(machine => {
                // Find existing record
                const record = appData.production.find(x => x.machine === machine);
                const dateVal = record ? (record.endDate || '') : '';
                const prevDateVal = record ? (record.prevEndDate || '') : '';

                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition border-b border-slate-100 dark:border-slate-800">
                    <td class="p-4 font-medium text-slate-800 dark:text-slate-200">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded bg-amber-100 text-amber-600 flex items-center justify-center font-bold text-xs shrink-0">${machine.split('/').pop().trim()}</span>
                            <span>${machine}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-1">
                            <input type="${prevDateVal === 'Aktif sipariş / Biota' ? 'text' : 'date'}" value="${prevDateVal}" 
                                onfocus="if(this.value==='Aktif sipariş / Biota'){this.type='date';this.value='';}" 
                                onchange="saveProductionDate('${machine}', 'prev', this.value)" 
                                class="bg-slate-50 dark:bg-slate-800 border-none px-3 py-2 rounded outline-none focus:ring-1 focus:ring-amber-500 text-sm w-40 transition text-slate-500 dark:text-slate-400">
                            <button onclick="saveProductionDate('${machine}', 'prev', 'Aktif sipariş / Biota'); renderProduction();" title="Biota İşaretle" class="px-2 py-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded text-xs transition whitespace-nowrap"><i class="fas fa-leaf"></i> Biota</button>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-1">
                            <input type="${dateVal === 'Aktif sipariş / Biota' ? 'text' : 'date'}" value="${dateVal}" 
                                onfocus="if(this.value==='Aktif sipariş / Biota'){this.type='date';this.value='';}" 
                                onchange="saveProductionDate('${machine}', 'curr', this.value)" 
                                class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 px-3 py-2 rounded outline-none focus:border-amber-500 text-sm w-40 transition shadow-sm text-slate-700 dark:text-slate-300">
                            <button onclick="saveProductionDate('${machine}', 'curr', 'Aktif sipariş / Biota'); renderProduction();" title="Biota İşaretle" class="px-2 py-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded text-xs transition whitespace-nowrap"><i class="fas fa-leaf"></i> Biota</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function saveProductionDate(machine, type, dateVal) {
            const idx = appData.production.findIndex(x => x.machine === machine);
            if (idx > -1) {
                if (type === 'prev') appData.production[idx].prevEndDate = dateVal;
                else appData.production[idx].endDate = dateVal;
            } else {
                const newItem = { id: Date.now().toString() + Math.random().toString(36).substr(2, 5), machine: machine, endDate: '', prevEndDate: '' };
                if (type === 'prev') newItem.prevEndDate = dateVal;
                else newItem.endDate = dateVal;
                appData.production.push(newItem);
            }
            saveData('production');
        }

        // --- RENK ONAY FORMU PDF (A4 Dikey, Tek Sayfa) ---
        async function exportColorPDF() {
            const colorFormContainer = document.querySelector('#view-color > div:last-child');
            if (!colorFormContainer) return alert('Renk onay formu bulunamadı.');

            // Temporarily hide non-print elements
            const noPrintEls = document.querySelectorAll('#view-color .no-print');
            noPrintEls.forEach(el => el.style.display = 'none');

            // Force the container to exact A4 dimensions for capture
            const origMinH = colorFormContainer.style.minHeight;
            const origH = colorFormContainer.style.height;
            const origOverflow = colorFormContainer.style.overflow;
            colorFormContainer.style.minHeight = '0';
            colorFormContainer.style.height = 'auto';
            colorFormContainer.style.overflow = 'hidden';

            try {
                const canvas = await html2canvas(colorFormContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 5;
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);

                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                // Always scale to fit within single A4 page
                const ratio = Math.min(contentWidth / imgWidth, contentHeight / imgHeight);
                const finalWidth = imgWidth * ratio;
                const finalHeight = imgHeight * ratio;

                const xOffset = margin + (contentWidth - finalWidth) / 2;
                const yOffset = margin;

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                doc.addImage(imgData, 'JPEG', xOffset, yOffset, finalWidth, finalHeight);
                doc.save(`Renk_Onay_Formu_${new Date().toISOString().slice(0, 10)}.pdf`);

            } catch (e) {
                console.error('PDF oluşturma hatası:', e);
                alert('PDF oluşturulurken bir hata oluştu.');
            } finally {
                colorFormContainer.style.minHeight = origMinH;
                colorFormContainer.style.height = origH;
                colorFormContainer.style.overflow = origOverflow;
                noPrintEls.forEach(el => el.style.display = '');
            }
        }

        // --- FİNANSAL KAYIT PDF (Aylık Özet, A4 Dikey) ---
        async function exportPDF(title, areaId) {
            const fontB64 = await getPdfFont();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            const fontName = fontB64 ? 'Roboto' : 'helvetica';

            if (fontB64) {
                doc.addFileToVFS('Roboto-Regular.ttf', fontB64);
                doc.addFont('Roboto-Regular.ttf', 'Roboto', 'normal');
                doc.setFont('Roboto');
            }

            // Current month data
            const monthData = appData.finance.filter(x => x.month === currentFinMonth);
            const monthLabel = new Date(currentFinMonth + '-01').toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

            // Calculate totals
            let totGelir = 0, totKK = 0, totKredi = 0, totYatirim = 0;
            const gelirler = monthData.filter(x => x.type === 'gelir');
            const kklar = monthData.filter(x => x.type === 'kk');
            const krediler = monthData.filter(x => x.type === 'kredi');
            const yatirimlar = monthData.filter(x => x.type === 'yatirim');

            gelirler.forEach(x => totGelir += parseFloat(x.amount) || 0);
            kklar.forEach(x => totKK += parseFloat(x.amount) || 0);
            krediler.forEach(x => totKredi += parseFloat(x.amount) || 0);
            yatirimlar.forEach(x => totYatirim += parseFloat(x.amount) || 0);

            const totGider = totKK + totKredi;
            const netDurum = totGelir - totGider;

            // ---- HEADER ----
            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('Finansal Kayıt - Aylık Özet', 14, 13);
            doc.setFontSize(10);
            doc.text(monthLabel.charAt(0).toUpperCase() + monthLabel.slice(1), 14, 22);
            doc.setFontSize(8);
            doc.text(`Oluşturma: ${new Date().toLocaleDateString('tr-TR')}`, 210 - 14, 13, { align: 'right' });
            doc.setTextColor(0, 0, 0);

            let yPos = 38;

            // ---- SUMMARY BOXES ----
            const boxWidth = 58;
            const boxHeight = 22;
            const gap = 4;
            const startX = 14;

            // Gelir box
            doc.setFillColor(236, 253, 245);
            doc.roundedRect(startX, yPos, boxWidth, boxHeight, 2, 2, 'F');
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text('Toplam Gelir', startX + 4, yPos + 7);
            doc.setFontSize(14);
            doc.setTextColor(5, 150, 105);
            doc.text(`${totGelir.toLocaleString('tr-TR')} TL`, startX + 4, yPos + 17);

            // Gider box
            doc.setFillColor(254, 242, 242);
            doc.roundedRect(startX + boxWidth + gap, yPos, boxWidth, boxHeight, 2, 2, 'F');
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text('Toplam Gider (KK+Kredi)', startX + boxWidth + gap + 4, yPos + 7);
            doc.setFontSize(14);
            doc.setTextColor(220, 38, 38);
            doc.text(`${totGider.toLocaleString('tr-TR')} TL`, startX + boxWidth + gap + 4, yPos + 17);

            // Yatırım box
            doc.setFillColor(255, 251, 235);
            doc.roundedRect(startX + (boxWidth + gap) * 2, yPos, boxWidth, boxHeight, 2, 2, 'F');
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text('Toplam Yatırım', startX + (boxWidth + gap) * 2 + 4, yPos + 7);
            doc.setFontSize(14);
            doc.setTextColor(217, 119, 6);
            doc.text(`${totYatirim.toLocaleString('tr-TR')} TL`, startX + (boxWidth + gap) * 2 + 4, yPos + 17);

            yPos += boxHeight + 6;

            // Net Durum line
            doc.setFontSize(9);
            doc.setTextColor(30, 41, 59);
            doc.text(`Net Durum (Gelir - Gider): `, 14, yPos + 4);
            if (netDurum >= 0) {
                doc.setTextColor(5, 150, 105);
            } else {
                doc.setTextColor(220, 38, 38);
            }
            doc.setFontSize(11);
            doc.text(`${netDurum >= 0 ? '+' : ''}${netDurum.toLocaleString('tr-TR')} TL`, 70, yPos + 4);
            doc.setTextColor(0, 0, 0);

            yPos += 12;

            // ---- HELPER: Draw Category Table ----
            function drawCategoryTable(categoryTitle, items, colorRGB, startY) {
                if (items.length === 0) return startY;

                doc.setFontSize(10);
                doc.setTextColor(colorRGB[0], colorRGB[1], colorRGB[2]);
                doc.text(categoryTitle, 14, startY);
                startY += 2;

                const head = [['Kalem', 'Tutar (TL)']];
                const body = items.map(x => [x.name || '-', `${parseFloat(x.amount).toLocaleString('tr-TR')} TL`]);
                const total = items.reduce((s, x) => s + (parseFloat(x.amount) || 0), 0);
                body.push([{ content: 'TOPLAM', styles: { fontStyle: 'bold' } }, { content: `${total.toLocaleString('tr-TR')} TL`, styles: { fontStyle: 'bold' } }]);

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: startY,
                    theme: 'grid',
                    styles: {
                        font: fontName,
                        fontSize: 8,
                        cellPadding: { top: 2.5, right: 3, bottom: 2.5, left: 3 },
                        overflow: 'linebreak',
                        lineColor: [226, 232, 240],
                        lineWidth: 0.2,
                        textColor: [30, 41, 59],
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: colorRGB,
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 120 },
                        1: { cellWidth: 50, halign: 'right' }
                    },
                    margin: { left: 14, right: 14 }
                });

                return doc.lastAutoTable.finalY + 8;
            }

            // Draw each category
            yPos = drawCategoryTable('Gelirler', gelirler, [5, 150, 105], yPos);
            yPos = drawCategoryTable('Kredi Kartları', kklar, [220, 38, 38], yPos);
            yPos = drawCategoryTable('Kredi ve Bor\u00e7', krediler, [185, 28, 28], yPos);
            yPos = drawCategoryTable('Yatırımlar', yatirimlar, [217, 119, 6], yPos);

            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(148, 163, 184);
                doc.text(`Sayfa ${i} / ${pageCount}`, 210 - 14, 290, { align: 'right' });
                doc.text('GorkAPP - Finansal Kayıt Sistemi', 14, 290);
            }

            doc.save(`Finansal_Kayit_${currentFinMonth}.pdf`);
        }

        // ==========================================
        //         ANASAYFA (HOME) FONKSİYONLARI
        // ==========================================

        function renderHome() {
            if (!appData.home) appData.home = { motivationImg: '', motivationText: '', todos: [], shortcuts: [] };

            // 1. Motivasyon
            const mImg = document.getElementById('previewMotivation');
            const mIcon = mImg.nextElementSibling;
            if (appData.home.motivationImg) {
                mImg.src = appData.home.motivationImg;
                mImg.classList.remove('hidden');
                mIcon.classList.add('hidden');
            } else {
                mImg.classList.add('hidden');
                mIcon.classList.remove('hidden');
            }
            document.getElementById('iptMotivationText').value = appData.home.motivationText || '';

            // 2. To-Do & Alışveriş Listesi
            renderHomeTodos();
            renderHomeShopping();

            // 3. Özet Veriler
            renderHomeOverview();

            // 4. Takvim
            renderCalendar();

            // 5. Kısayollar
            renderShortcuts();
        }

        function renderHomeOverview() {
            if (!appData.orders) return;
            const active = appData.orders.filter(o => o.status !== 'Tamamlandı');
            let lateCount = 0;
            let totalRemQty = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            active.forEach(o => {
                let tq = parseInt(o.totalQty) || 0;
                let dq = parseInt(o.deliveredQty) || 0;
                totalRemQty += Math.max(0, tq - dq);

                if (o.deadline) {
                    let dDate = new Date(o.deadline);
                    if (dDate < today) lateCount++;
                }
            });

            const props = (appData.proposals || []).filter(p => p.status === 'Teklif' || p.status === 'Takip').length;

            document.getElementById('home-kpi-active').innerText = active.length;
            document.getElementById('home-kpi-late').innerText = lateCount;
            document.getElementById('home-kpi-qty').innerText = totalRemQty.toLocaleString('tr-TR');
            document.getElementById('home-kpi-props').innerText = props;
        }

        // Motivasyon
        function uploadMotivation(e) {
            const f = e.target.files[0];
            if (!f) return;
            if (f.size > 2 * 1024 * 1024) return alert("Dosya boyutu 2MB'den küçük olmalı!");
            const reader = new FileReader();
            reader.onload = (ev) => {
                appData.home.motivationImg = ev.target.result;
                saveData('home');
                renderHome();
            };
            reader.readAsDataURL(f);
        }
        function saveMotivationText(txt) {
            appData.home.motivationText = txt;
            saveData('home');
        }

        // Hızlı Notlar
        function renderHomeTodos() {
            const list = appData.home.todos || [];
            document.getElementById('listHomeTodos').innerHTML = list.length ? list.map(t =>
                `<div class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition group border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleHomeTodo('${t.id}')" class="w-4 h-4 text-emerald-500 rounded border-gray-300 focus:ring-emerald-500 cursor-pointer">
                    <span class="flex-1 text-sm ${t.done ? 'line-through text-slate-400' : 'text-slate-700 dark:text-slate-200'}">${t.text}</span>
                    <button onclick="deleteHomeTodo('${t.id}')" class="text-red-400 opacity-0 group-hover:opacity-100 transition px-2 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                </div>`
            ).join('') : '<p class="text-xs text-center text-slate-400 mt-4 italic">Yapılacaklar listeniz boş.</p>';
        }
        function addHomeTodo() {
            const ipt = document.getElementById('iptHomeTodo');
            const txt = ipt.value.trim();
            if (!txt) return;
            if (!appData.home.todos) appData.home.todos = [];
            appData.home.todos.push({ id: Date.now().toString(), text: txt, done: false });
            ipt.value = '';
            saveData('home');
            renderHomeTodos();
        }
        function toggleHomeTodo(id) {
            const t = appData.home.todos.find(x => x.id === id);
            if (t) { t.done = !t.done; saveData('home'); renderHomeTodos(); }
        }
        function deleteHomeTodo(id) {
            appData.home.todos = appData.home.todos.filter(x => x.id !== id);
            saveData('home');
            renderHomeTodos();
        }

        // Alışveriş Hatırlatıcısı
        function renderHomeShopping() {
            const list = appData.home.shopping || [];
            document.getElementById('listHomeShopping').innerHTML = list.length ? list.map(t =>
                `<div class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition group border border-transparent hover:border-slate-200 dark:hover:border-slate-700">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleHomeShopping('${t.id}')" class="w-4 h-4 text-amber-500 rounded border-gray-300 focus:ring-amber-500 cursor-pointer">
                    <span class="flex-1 text-sm ${t.done ? 'line-through text-slate-400' : 'text-slate-700 dark:text-slate-200'}">${t.text}</span>
                    <button onclick="deleteHomeShopping('${t.id}')" class="text-red-400 opacity-0 group-hover:opacity-100 transition px-2 hover:text-red-600"><i class="fas fa-trash text-xs"></i></button>
                </div>`
            ).join('') : '<p class="text-xs text-center text-slate-400 mt-4 italic">Alışveriş listeniz boş.</p>';
        }
        function addHomeShopping() {
            const ipt = document.getElementById('iptHomeShopping');
            const txt = ipt.value.trim();
            if (!txt) return;
            if (!appData.home.shopping) appData.home.shopping = [];
            appData.home.shopping.push({ id: Date.now().toString(), text: txt, done: false });
            ipt.value = '';
            saveData('home');
            renderHomeShopping();
        }
        function toggleHomeShopping(id) {
            const t = appData.home.shopping.find(x => x.id === id);
            if (t) { t.done = !t.done; saveData('home'); renderHomeShopping(); }
        }
        function deleteHomeShopping(id) {
            appData.home.shopping = appData.home.shopping.filter(x => x.id !== id);
            saveData('home');
            renderHomeShopping();
        }

        // Takvim
        function changeCalMonth(d) {
            currentCalDate.setMonth(currentCalDate.getMonth() + d);
            renderCalendar();
        }
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        function renderCalendar() {
            const y = currentCalDate.getFullYear();
            const m = currentCalDate.getMonth();
            document.getElementById('calMonthYear').innerText = currentCalDate.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(y, m, 1);
            let firstDayOfWeek = firstDay.getDay() === 0 ? 7 : firstDay.getDay(); // Pz = 7, Pt = 1
            const lastDate = new Date(y, m + 1, 0).getDate();

            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';

            const todayDate = new Date();
            const isCurrentMonth = todayDate.getFullYear() === y && todayDate.getMonth() === m;
            const currentDay = todayDate.getDate();

            let dateCount = 1;
            for (let row = 0; row < 6; row++) {
                if (dateCount > lastDate) continue;

                // Haftanın ilk günü için obje
                let rowFirstDate = new Date(y, m, dateCount === 1 ? 1 : dateCount);
                if (row === 0 && firstDayOfWeek > 1) {
                    rowFirstDate = new Date(y, m, 1);
                }
                const weekNum = getWeekNumber(rowFirstDate);

                // Hafta numarası hücresi
                const isCurrentWeek = isCurrentMonth && (currentDay >= dateCount && currentDay < dateCount + (8 - firstDayOfWeek) || (row > 0 && currentDay >= dateCount && currentDay < dateCount + 7));
                grid.innerHTML += `<div class="flex items-center justify-center text-[9px] font-bold ${isCurrentWeek ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/40 dark:text-blue-400 rounded' : 'text-slate-400'}">${weekNum}</div>`;

                for (let col = 1; col <= 7; col++) {
                    if (row === 0 && col < firstDayOfWeek) {
                        grid.innerHTML += `<div class="p-1"></div>`; // Boş hücre
                    } else if (dateCount > lastDate) {
                        grid.innerHTML += `<div class="p-1"></div>`;
                    } else {
                        const isToday = isCurrentMonth && dateCount === currentDay;
                        const isWeekend = col >= 6;
                        grid.innerHTML += `<div class="flex items-center justify-center rounded-lg text-xs p-1 cursor-default
                            ${isToday ? 'bg-blue-500 text-white font-bold shadow-md' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition'}
                            ${isWeekend && !isToday ? 'text-red-500 dark:text-red-400' : ''}
                        ">${dateCount}</div>`;
                        dateCount++;
                    }
                }
            }
        }

        // Kısayollar
        function renderShortcuts() {
            let sc = appData.home.shortcuts || [];
            sc.sort((a, b) => a.order - b.order);
            const grid = document.getElementById('gridShortcuts');

            grid.innerHTML = sc.map(s =>
                `<div draggable="true" data-id="${s.id}" class="shortcut-item relative group bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-500 rounded-xl p-3 flex flex-col items-center gap-2 cursor-pointer hover:shadow-md transition text-center" onclick="if(!window.isDraggingShortcut) window.open('${s.url}', '_blank')">
                    <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 flex gap-1 z-10 bg-white/80 dark:bg-slate-800/80 p-0.5 rounded">
                        <button onclick="event.stopPropagation(); editShortcut('${s.id}')" class="text-blue-500 hover:bg-blue-50 w-5 h-5 rounded flex items-center justify-center"><i class="fas fa-pen text-[10px]"></i></button>
                        <button onclick="event.stopPropagation(); deleteShortcut('${s.id}')" class="text-red-500 hover:bg-red-50 w-5 h-5 rounded flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button>
                    </div>
                    ${s.iconImg ?
                    `<div class="w-10 h-10 rounded overflow-hidden shrink-0"><img src="${s.iconImg}" class="w-full h-full object-cover"></div>` :
                    `<div class="w-10 h-10 rounded bg-indigo-50 dark:bg-indigo-900/30 text-indigo-500 flex items-center justify-center text-lg shrink-0"><i class="fas ${s.icon || 'fa-link'}"></i></div>`
                }
                    <span class="text-xs font-medium text-slate-700 dark:text-slate-200 line-clamp-1 truncate w-full px-1">${s.name}</span>
                </div>`
            ).join('');

            initShortcutsDragAndDrop();
        }

        function addShortcut() {
            const name = prompt("Kısayol Adı:");
            if (!name) return;
            const url = prompt("URL (https://...):", "https://");
            if (!url) return;

            const newId = Date.now().toString();
            const order = (appData.home.shortcuts || []).length;

            const iconUrl = prompt("Görsel URL'si eklemek ister misiniz? (Url varsa yapıştırın, iptal derseniz bilgisayardan dosya seçimi sorulur)");
            if (iconUrl) {
                appData.home.shortcuts.push({ id: newId, name, url, iconImg: iconUrl, order });
                saveData('home'); renderShortcuts();
                return;
            }

            const wantsIcon = confirm("Bilgisayardan özel bir ikon resmi eklemek ister misiniz? (Varsayılan ikon için İptal'e basın)");
            if (wantsIcon) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    if (f.size > 100 * 1024) return alert("İkon resmi 100KB'den küçük olmalı!");
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        appData.home.shortcuts.push({ id: newId, name, url, iconImg: ev.target.result, order });
                        saveData('home'); renderShortcuts();
                    };
                    reader.readAsDataURL(f);
                };
                input.click();
            } else {
                appData.home.shortcuts.push({ id: newId, name, url, icon: 'fa-link', order });
                saveData('home'); renderShortcuts();
            }
        }

        function editShortcut(id) {
            const s = appData.home.shortcuts.find(x => x.id === id);
            if (!s) return;
            const name = prompt("Yeni Kısayol Adı:", s.name);
            if (!name) return;
            const url = prompt("Yeni URL:", s.url);
            if (!url) return;
            s.name = name;
            s.url = url;
            saveData('home'); renderShortcuts();
        }

        function deleteShortcut(id) {
            if (confirm("Kısayolu silmek istediğinize emin misiniz?")) {
                appData.home.shortcuts = appData.home.shortcuts.filter(x => x.id !== id);
                saveData('home'); renderShortcuts();
            }
        }

        function initShortcutsDragAndDrop() {
            const items = document.querySelectorAll('.shortcut-item');
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    window.isDraggingShortcut = true;
                    e.dataTransfer.setData('text/plain', item.dataset.id);
                    item.classList.add('opacity-50');
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('opacity-50');
                    setTimeout(() => window.isDraggingShortcut = false, 100);
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.classList.add('border-indigo-500', 'border-dashed', 'border-2');
                });
                item.addEventListener('dragleave', () => {
                    item.classList.remove('border-indigo-500', 'border-dashed', 'border-2');
                });
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('border-indigo-500', 'border-dashed', 'border-2');
                    const draggedId = e.dataTransfer.getData('text/plain');
                    const targetId = item.dataset.id;
                    if (draggedId === targetId) return;

                    let sc = appData.home.shortcuts;
                    const draggedIdx = sc.findIndex(x => x.id === draggedId);
                    const targetIdx = sc.findIndex(x => x.id === targetId);

                    if (draggedIdx > -1 && targetIdx > -1) {
                        const draggedOrder = sc[draggedIdx].order;
                        const targetOrder = sc[targetIdx].order;
                        sc[draggedIdx].order = targetOrder;
                        sc[targetIdx].order = draggedOrder;
                        saveData('home');
                        renderShortcuts();
                    }
                });
            });
        }

    </script>
</body>

</html>
